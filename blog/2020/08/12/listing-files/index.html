<!doctype html>
<html class="no-js" lang="en">
<head>
<meta charset="utf-8" />
<title>Listing Files on macOS &#8211; Eugene Petrenko</title>
<meta name="description" content="How to list 1M files fast"/>
<meta name="keywords" content="jonnyzzz, Евгений Петренко, Eugene Petrenko, jvm, java, jni, native, macOS" />


<!-- Twitter Cards -->
<meta name="twitter:title" content="Listing Files on macOS -- Eugene Petrenko" />
<meta name="twitter:description" content="How to list 1M files fast" />
<meta name="twitter:site" content="@jonnyzzz" />
<meta name="twitter:creator" content="@jonnyzzz" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="https://jonnyzzz.com/images/me.jpg" />

<!-- Open Graph -->

<meta property="og:type" content="article" />
<meta property="og:image" content="https://jonnyzzz.com/images/me.jpg" />
<meta property="og:title" content="Listing Files on macOS -- Eugene Petrenko" />
<meta property="og:description" content="How to list 1M files fast" />
<meta property="og:url" content="https://jonnyzzz.com/blog/2020/08/12/listing-files/" />
<meta property="og:site_name" content="Eugene Petrenko" />

<meta property="article:tag" content="jonnyzzz" />

<meta property="article:tag" content="Евгений Петренко" />

<meta property="article:tag" content="Eugene Petrenko" />


<meta property="article:tag" content="jvm" />

<meta property="article:tag" content="java" />

<meta property="article:tag" content="jni" />

<meta property="article:tag" content="native" />

<meta property="article:tag" content="macOS" />



<!-- Webmaster Tools verfication -->
<meta name="google-site-verification" content="MJZCyfst2Tx4KyxbOIQu1fZyOSwA_JkQu73zJcfsl2g" />




<link rel="canonical" href="https://jonnyzzz.com/blog/2020/08/12/listing-files/" />
<link href="https://feeds.feedburner.com/jonnyzzz" type="application/atom+xml" rel="alternate" title="ATOM Feed" />

<meta name="HandheldFriendly" content="True" />
<meta name="MobileOptimized" content="320" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css" />

<link rel="apple-touch-icon" sizes="57x57" href="/images/apple-icon-57x57.png" />
<link rel="apple-touch-icon" sizes="60x60" href="/images/apple-icon-60x60.png" />
<link rel="apple-touch-icon" sizes="72x72" href="/images/apple-icon-72x72.png" />
<link rel="apple-touch-icon" sizes="76x76" href="/images/apple-icon-76x76.png" />
<link rel="apple-touch-icon" sizes="114x114" href="/images/apple-icon-114x114.png" />
<link rel="apple-touch-icon" sizes="120x120" href="/images/apple-icon-120x120.png" />
<link rel="apple-touch-icon" sizes="144x144" href="/images/apple-icon-144x144.png" />
<link rel="apple-touch-icon" sizes="152x152" href="/images/apple-icon-152x152.png" />
<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-icon-180x180.png" />
<link rel="icon" type="image/png" sizes="192x192"  href="/images/android-icon-192x192.png" />
<link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png" />
<link rel="icon" type="image/png" sizes="96x96" href="/images/favicon-96x96.png" />
<link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png" />
<link rel="manifest" href="/images/manifest.json" />
<meta name="msapplication-TileColor" content="#ffffff" />
<meta name="msapplication-TileImage" content="/images/ms-icon-144x144.png" />
<meta name="theme-color" content="#ffffff" />

</head>

<body id="post">

<div class="navigation-wrapper">
	<nav role="navigation" id="site-nav">
	    <ul>
      
		    
		    <li><a href="/about/" >About</a></li>
		  
		    
		    <li><a href="/blog/" >Blog</a></li>
		  
		    
		    <li><a href="/projects/" >Projects</a></li>
		  
		    
		    <li><a href="/talks/" >Talks</a></li>
		  
		    
		    <li><a href="/tags/" >Tags</a></li>
		  
	    </ul>
	</nav>
</div><!-- /.navigation-wrapper -->

<header class="masthead">
	<div class="wrap">
      
      <h1 class="site-title"><a href="/">Eugene Petrenko</a></h1>
		<h2 class="site-description" itemprop="description">@jonnyzzz personal page and blog</h2>
	</div>
</header><!-- /.masthead -->

<div class="js-menu-screen menu-screen"></div>


<div id="main" role="main">
  <article class="hentry">
    
    <div class="entry-wrapper">
      <header class="entry-header">
        <ul class="entry-tags">
          <li><a href="/tags/#jvm" title="Pages tagged jvm">jvm</a></li><li><a href="/tags/#java" title="Pages tagged java">java</a></li><li><a href="/tags/#jni" title="Pages tagged jni">jni</a></li><li><a href="/tags/#native" title="Pages tagged native">native</a></li><li><a href="/tags/#macOS" title="Pages tagged macOS">macOS</a></li>
        </ul>
        
          <h1 class="entry-title">Listing Files on macOS</h1>
        
      </header>
      <footer class="entry-meta">
        
        
          <img src="/images/me.jpg" class="bio-photo" alt="Eugene Petrenko bio photo"></a>
        
        <span class="author vcard">By <span class="fn">Eugene Petrenko</span></span>
        <span class="entry-date date published"><time datetime="2020-08-12T00:00:00+00:00"><i class="fa fa-calendar-o"></i> August 12, 2020</time></span>
        
        <span class="entry-comments"><i class="fa fa-comment-o"></i> <a href="#disqus_thread">Comment</a></span>
        <span class="social-share-twitter">
  <a href="https://twitter.com/intent/tweet?hashtags=jvm,java,jni,native,macOS&amp;text=Listing%20Files%20on%20macOS&amp;url=https://jonnyzzz.com/blog/2020/08/12/listing-files/&amp;via=jonnyzzz" title="Share on Twitter" itemprop="Twitter" target="_blank"><i class="fa fa-twitter-square"></i> Tweet</a>
</span>
<span class="social-share-facebook">
  <a href="https://www.facebook.com/sharer/sharer.php?u=https://jonnyzzz.com/blog/2020/08/12/listing-files/" title="Share on Facebook" itemprop="Facebook" target="_blank"><i class="fa fa-facebook-square"></i> Like</a>
</span>

<!-- /.social-share -->

        
      </footer>
      <div class="entry-content">
        <p>Listing files, it’s an easy task, isn’t it? I remember myself doing
that as part of my computer science classes many years ago. What if one has
about a million of files to list? That could be way more interesting.</p>

<p>You may say, 1 million of files, is that possible at all? Yes, it actually
not hard to find under a checkout folder of a medium project. A compiler
output directory is likely to double the size of files you have (e.g. with <code class="highlighter-rouge">.obj</code> or <code class="highlighter-rouge">.class</code> files).</p>

<p>The experiments and measurements I do are executed on the Apple MacBook Pro
(15-inch, 2019, 2,4 GHz 8-Core Intel Core i9, 32Gb, Apple SSD AP0512M, 512Gb) running 
macOS Catalina 10.15.6 (19G73). I use an encrypted case-insensitive APFS on the whole SSD.</p>

<h1 id="the-find-utility">The Find Utility</h1>

<p>Let’s start with a baseline experiment, for that we just call the <code class="highlighter-rouge">find</code> command in the console:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash-3.2$  find . | wc -l
  942330

bash-3.2$  find . -type f | wc -l
  800205

bash-3.2$  find . -type d | wc -l
  141981
</code></pre></div></div>

<p>We use the <a href="https://man7.org/linux/man-pages/man1/wc.1.html">wc</a> command to count lines in 
the output of the <a href="https://man7.org/linux/man-pages/man1/find.1.html">find</a> command.
With the help of <code class="highlighter-rouge">|</code> we <a href="https://tldp.org/HOWTO/Bash-Prog-Intro-HOWTO-4.html">pipe</a> the
output of the <code class="highlighter-rouge">find</code> command to the <code class="highlighter-rouge">wc</code> command.</p>

<p>There are <code class="highlighter-rouge">942330</code> items under the working directory, <code class="highlighter-rouge">800205</code> files, <code class="highlighter-rouge">141981</code> directories. 
I have some symlinks from macOS Frameworks and <code class="highlighter-rouge">node_modules</code>.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash-3.2$  time find . &gt; /dev/null

real    0m30.977s
user    0m0.796s
sys     0m12.034s
</code></pre></div></div>

<p>I’ve made several runs, yielding the time around <code class="highlighter-rouge">31 seconds</code> (<code class="highlighter-rouge">30.977</code>, <code class="highlighter-rouge">33.643</code>, <code class="highlighter-rouge">31.497</code>).</p>

<h1 id="git-status">Git Status</h1>

<p>My working directory is under <a href="https://git-scm.com/">Git</a> version control. The <code class="highlighter-rouge">.gitignore</code> makes 
Git to ignore the compiler output folders. The status command works a bit faster, but still time-taking:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash-3.2$  time git status

It took 4.59 seconds to enumerate untracked files. 'status -uno'
may speed it up, but you have to be careful not to forget to add
new files yourself (see 'git help status').
nothing added to commit but untracked files present (use "git add" to track)


real   0m9.217s
user   0m1.427s
sys    0m58.756s
</code></pre></div></div>

<p>I’ve made several runs, it shows the time around <code class="highlighter-rouge">8.5 seconds</code>
(<code class="highlighter-rouge">9.046</code>, <code class="highlighter-rouge">8.179</code>, <code class="highlighter-rouge">9.217</code>, <code class="highlighter-rouge">8.383</code>, <code class="highlighter-rouge">8,461</code>, <code class="highlighter-rouge">8.726</code>).</p>

<h1 id="java">Java</h1>

<p>I decided to try Java implementation to see if it works faster. 
For the experiment I use <code class="highlighter-rouge">OpenJDK 14.0.1</code> on the same macOS.</p>

<p>We can collect all files in Java with the <code class="highlighter-rouge">Files.walk</code> API:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="n">Instant</span> <span class="n">start</span> <span class="o">=</span> <span class="n">Instant</span><span class="o">.</span><span class="na">now</span><span class="o">();</span>
        <span class="kt">long</span> <span class="n">size</span> <span class="o">=</span> <span class="n">Files</span><span class="o">.</span><span class="na">walk</span><span class="o">(</span><span class="n">home</span><span class="o">).</span><span class="na">count</span><span class="o">();</span>
        <span class="n">Duration</span> <span class="n">duration</span> <span class="o">=</span> <span class="n">Duration</span><span class="o">.</span><span class="na">between</span><span class="o">(</span><span class="n">start</span><span class="o">,</span> <span class="n">Instant</span><span class="o">.</span><span class="na">now</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Total files: "</span> <span class="o">+</span> <span class="n">size</span> <span class="o">+</span> <span class="s">", done in "</span> <span class="o">+</span> <span class="n">duration</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>It prints:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Total files: 942330, done in PT45.623236S
Total files: 942330, done in PT49.75288S
Total files: 942330, done in PT49.52438S
Total files: 942330, done in PT48.5415S
Total files: 942330, done in PT49.18739S
</code></pre></div></div>

<p>On my machine the program managed to complete in approximately <code class="highlighter-rouge">49 seconds</code>
(<code class="highlighter-rouge">45.623236</code>,<code class="highlighter-rouge">49.75288</code>, <code class="highlighter-rouge">49.52438</code>, <code class="highlighter-rouge">48.5415</code>,<code class="highlighter-rouge">49.18739</code>). I’ve added the loop
in the program with a hope to <a href="https://stackoverflow.com/questions/36198278/why-does-the-jvm-require-warmup">warmup</a>
the JVM.</p>

<p>Parallel execution via <code class="highlighter-rouge">Stream.parallel()</code> did not help at all on my 8-core machine. Similarly, 
the <code class="highlighter-rouge">Files.walkFileTree</code> API does not give any sensible performance win.</p>

<p>Quick CPU profile in <a href="https://www.jetbrains.com/help/idea/cpu-profiler.html">IntelliJ IDEA</a>
shown the most of the time it was spending calling the <code class="highlighter-rouge">lstat</code> POSIX function:</p>

<p><img src="https://jonnyzzz.com/images/posts/2020-08-12-java-lstat.png" alt="CPU Profiles Samples" /></p>

<p>It started to look a native approach that uses another native APIs would work better.</p>

<h1 id="swift-and-objective-c-api">Swift and Objective-C API</h1>

<p>The very first experiment was to try macOS native APIs. I found the <a href="https://developer.apple.com/documentation/foundation/filemanager">FileManager</a>
and it’s <code class="highlighter-rouge">enumerator</code> API to list the files from Swift/Objective-C. The Swift program was as follows:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="nv">fileManager</span> <span class="o">=</span> <span class="kt">FileManager</span><span class="o">.</span><span class="k">default</span>
<span class="k">let</span> <span class="nv">dirEnum</span> <span class="o">=</span> <span class="n">fileManager</span><span class="o">.</span><span class="nf">enumerator</span><span class="p">(</span><span class="nv">atPath</span><span class="p">:</span> <span class="n">path</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">start</span> <span class="o">=</span> <span class="kt">CFAbsoluteTimeGetCurrent</span><span class="p">()</span>
<span class="k">var</span> <span class="nv">total</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">while</span> <span class="k">let</span> <span class="nv">file</span> <span class="o">=</span> <span class="n">dirEnum</span><span class="p">?</span><span class="o">.</span><span class="nf">nextObject</span><span class="p">()</span> <span class="k">as?</span> <span class="kt">String</span> <span class="p">{</span>
    <span class="n">total</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="p">}</span>

<span class="k">let</span> <span class="nv">end</span> <span class="o">=</span> <span class="kt">CFAbsoluteTimeGetCurrent</span><span class="p">()</span>
<span class="nf">print</span><span class="p">(</span><span class="s">"total: "</span><span class="p">,</span> <span class="n">total</span><span class="p">,</span> <span class="s">"consume: "</span><span class="p">,</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">),</span> <span class="s">" s"</span><span class="p">)</span>
</code></pre></div></div>

<p>Unfortunately, it did not give the better result:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>total:  942276 consume:  69.13790500164032  s
Program ended with exit code: 0
</code></pre></div></div>

<h1 id="golang">Golang</h1>

<p>The next native language I decided was <a href="https://golang.org/">Go</a>.
I wrote a small program to list a folder recursively:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span><span class="x"> </span><span class="n">scanDisk</span><span class="p">(</span><span class="n">home</span><span class="x"> </span><span class="kt">string</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">f</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">os</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">home</span><span class="p">)</span><span class="x">
	</span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="x">
		</span><span class="k">return</span><span class="x">
	</span><span class="p">}</span><span class="x">
	</span><span class="k">defer</span><span class="x"> </span><span class="n">f</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span><span class="x">

	</span><span class="n">dirs</span><span class="p">,</span><span class="x"> </span><span class="n">_</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">f</span><span class="o">.</span><span class="n">Readdirnames</span><span class="p">(</span><span class="o">-</span><span class="m">1</span><span class="p">)</span><span class="x">
	</span><span class="k">if</span><span class="x"> </span><span class="n">dirs</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="k">for</span><span class="x"> </span><span class="n">_</span><span class="p">,</span><span class="x"> </span><span class="n">name</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="k">range</span><span class="x"> </span><span class="n">dirs</span><span class="x"> </span><span class="p">{</span><span class="x">
			</span><span class="n">scanDisk</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">Join</span><span class="p">(</span><span class="n">home</span><span class="p">,</span><span class="x"> </span><span class="n">name</span><span class="p">))</span><span class="x">
		</span><span class="p">}</span><span class="x">
	</span><span class="p">}</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<p>It took approximately <code class="highlighter-rouge">80 seconds</code> for that program to complete. Reading the code, I found out
Go uses the <a href="https://www.man7.org/linux/man-pages/man3/readdir.3.html">readdir</a> function from POSIX API.</p>

<p>Next, I decided to give it a try in Native.</p>

<h1 id="basic-c-implementation">Basic C++ Implementation</h1>

<p>At that point it turned more clear, the better performance could be
achieved by using a native APIs and with an attempt to avoid calling
unneeded system calls. In the basic implementation I use the same
<a href="https://www.man7.org/linux/man-pages/man3/readdir.3.html">readdir</a>
function. One has to call <code class="highlighter-rouge">opendir</code> before and <code class="highlighter-rouge">closedir</code> after the
series of calls to the <code class="highlighter-rouge">readdir</code>. It yields enough information to
get a type of the directory entry. I’ve got the following C++ code:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">readOneDir</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">dirName</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">queue</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">newDirs</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">DIR</span> <span class="o">*</span><span class="n">pDir</span> <span class="o">=</span> <span class="n">opendir</span><span class="p">(</span><span class="n">dirName</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pDir</span> <span class="o">==</span> <span class="nb">nullptr</span><span class="p">)</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

    <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">auto</span> <span class="n">e</span> <span class="o">=</span> <span class="n">readdir</span><span class="p">(</span><span class="n">pDir</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">e</span> <span class="o">==</span> <span class="nb">nullptr</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'.'</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\0'</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'.'</span> <span class="o">&amp;&amp;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\0'</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">d_type</span> <span class="o">==</span> <span class="n">DT_UNKNOWN</span> <span class="o">||</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">d_type</span> <span class="o">==</span> <span class="n">DT_DIR</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">newDirs</span><span class="p">.</span><span class="n">emplace</span><span class="p">(</span><span class="n">dirName</span> <span class="o">+</span> <span class="sc">'/'</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="n">count</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">closedir</span><span class="p">(</span><span class="n">pDir</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">readRecursive</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">dir</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">queue</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">dirQueue</span><span class="p">;</span>
    <span class="n">dirQueue</span><span class="p">.</span><span class="n">emplace</span><span class="p">(</span><span class="n">dir</span><span class="p">);</span>

    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">dirQueue</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">home</span> <span class="o">=</span> <span class="n">dirQueue</span><span class="p">.</span><span class="n">front</span><span class="p">();</span>
        <span class="n">dirQueue</span><span class="p">.</span><span class="n">pop</span><span class="p">();</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="n">readOneDir</span><span class="p">(</span><span class="n">home</span><span class="p">,</span> <span class="n">dirQueue</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>With the output:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Time difference = 17641[ms]
Total files: 942330
Time difference = 17053[ms]
Total files: 942330
Time difference = 17038[ms]
Total files: 942330
Time difference = 16748[ms]
Total files: 942330
Time difference = 16865[ms]
Total files: 942330
</code></pre></div></div>

<p>So the program is able to scan all my <code class="highlighter-rouge">942330</code> files in approximately <code class="highlighter-rouge">17 seconds</code>
(<code class="highlighter-rouge">17641</code>, <code class="highlighter-rouge">17053</code>, <code class="highlighter-rouge">17038</code>, <code class="highlighter-rouge">16748</code>, <code class="highlighter-rouge">16865</code>).</p>

<p>Is it possible to avoid doing that number of system calls to get the same list of files?</p>

<h2 id="7x-speedup-or-macos-cache">7x Speedup or macOS Cache</h2>

<p>I was experimenting with the program above and decided to remove the <code class="highlighter-rouge">out</code> folder
from the processing. It is easy to implement by checking the <code class="highlighter-rouge">e-&gt;d_name</code> value. I added 
the following line to the loop:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">,</span> <span class="s">"out"</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
</code></pre></div></div>

<p>Adding that test reduced the number of files from one side, and gave a huge performance
boost:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Time difference = 6358[ms]
Total files: 534067
Time difference = 2195[ms]
Total files: 534067
Time difference = 2224[ms]
Total files: 534067
Time difference = 2182[ms]
Total files: 534067
Time difference = 2155[ms]
Total files: 534067
</code></pre></div></div>

<p>It is AMAZING! Removing the <code class="highlighter-rouge">out</code> folder with compilers output made it return the answer in <code class="highlighter-rouge">2 seconds</code> after a warmup.
It seems like the macOS has a disk-related cache that is not enough for all the files, but enough
for 534067 entries!</p>

<p>I’ve made another run of the tool directly on the <code class="highlighter-rouge">out</code> folder:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Time difference = 8334[ms]
Total files: 408117
Time difference = 1288[ms]
Total files: 408117
Time difference = 1290[ms]
Total files: 408117
Time difference = 1196[ms]
Total files: 408117
Time difference = 1194[ms]
Total files: 408117
</code></pre></div></div>

<p>Once again, we see that OS caching improves it greatly to <code class="highlighter-rouge">1.1 seconds</code>!</p>

<p>It is still unclear, if one can tweak the cache size. I would be happy to make the
cache at list twice big to make sure all my working copies on the computer fit into it. 
Please let me know in the comments if you have an idea on how to tune it.</p>

<h1 id="macos-specific-implementation">macOS Specific Implementation</h1>

<p>After reading internet and talking with friends we found there is a
closer-to-the-kernel way to list files on macOS.</p>

<p><a href="https://stackoverflow.com/questions/15103690/os-x-faster-file-system-api-than-repetitively-calling-nsfilemanager-attributeso/15104593#15104593">getdirentriesattr</a>
function help to make the macOS kernel do more work for us (if that one works).
It seems deprecated in the recent versions of the macOS.</p>

<p>I’ve dug deeper and found out there is a better <code class="highlighter-rouge">getattrlistbulk</code> function in the kernel,
this one works for all filesystems, and it is not deprecated. You may find some 
<a href="https://www.mail-archive.com/filesystem-dev@lists.apple.com/msg00022.html">discussions</a>
about that function in the mail-list or a <a href="https://www.manpagez.com/man/2/getattrlistbulk/">man</a>
page with a code sample. There is yet another code sample <a href="https://gist.github.com/anonymous/8f92e5c5b67133cbcc86">Gist</a>.</p>

<p>The implementation is longer, but hopefully, it would reduce the number of system calls:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">readOneDir</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">dirName</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">queue</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">newDirs</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">dirfd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">dirName</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">O_RDONLY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dirfd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

    <span class="kt">char</span> <span class="n">attrBuf</span><span class="p">[</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">];</span>
    <span class="n">attrlist</span> <span class="n">attrList</span><span class="p">{};</span>
    <span class="n">attrList</span><span class="p">.</span><span class="n">bitmapcount</span> <span class="o">=</span> <span class="n">ATTR_BIT_MAP_COUNT</span><span class="p">;</span>
    <span class="n">attrList</span><span class="p">.</span><span class="n">commonattr</span>  <span class="o">=</span> <span class="n">ATTR_CMN_RETURNED_ATTRS</span> <span class="o">|</span> <span class="n">ATTR_CMN_NAME</span> <span class="o">|</span> <span class="n">ATTR_CMN_ERROR</span> <span class="o">|</span> <span class="n">ATTR_CMN_OBJTYPE</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">retCount</span> <span class="o">=</span> <span class="n">getattrlistbulk</span><span class="p">(</span><span class="n">dirfd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attrList</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attrBuf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attrBuf</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">retCount</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>

        <span class="kt">char</span><span class="o">*</span> <span class="n">entry_start</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">attrBuf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">retCount</span><span class="p">;</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">count</span><span class="o">++</span><span class="p">;</span>

            <span class="kt">char</span><span class="o">*</span> <span class="n">field</span> <span class="o">=</span> <span class="n">entry_start</span><span class="p">;</span>
            <span class="kt">uint32_t</span> <span class="n">length</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">field</span><span class="p">;</span>
            <span class="n">field</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">);</span>
            <span class="n">entry_start</span> <span class="o">+=</span> <span class="n">length</span><span class="p">;</span>

            <span class="n">attribute_set_t</span> <span class="n">returned</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">attribute_set_t</span> <span class="o">*</span><span class="p">)</span><span class="n">field</span><span class="p">;</span>
            <span class="n">field</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attribute_set_t</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">returned</span><span class="p">.</span><span class="n">commonattr</span> <span class="o">&amp;</span> <span class="n">ATTR_CMN_ERROR</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

            <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">name</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">returned</span><span class="p">.</span><span class="n">commonattr</span> <span class="o">&amp;</span> <span class="n">ATTR_CMN_NAME</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">attrreference_t</span> <span class="n">name_info</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">attrreference_t</span> <span class="o">*</span><span class="p">)</span><span class="n">field</span><span class="p">;</span>
                <span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="n">field</span> <span class="o">+</span> <span class="n">name_info</span><span class="p">.</span><span class="n">attr_dataoffset</span><span class="p">);</span>
                <span class="n">field</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attrreference_t</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">returned</span><span class="p">.</span><span class="n">commonattr</span> <span class="o">&amp;</span> <span class="n">ATTR_CMN_OBJTYPE</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">fsobj_type_t</span> <span class="n">obj_type</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">fsobj_type_t</span> <span class="o">*</span><span class="p">)</span><span class="n">field</span><span class="p">;</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">obj_type</span> <span class="o">==</span> <span class="n">VDIR</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">newDirs</span><span class="p">.</span><span class="n">emplace</span><span class="p">(</span><span class="n">dirName</span> <span class="o">+</span> <span class="sc">'/'</span> <span class="o">+</span> <span class="n">name</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">close</span><span class="p">(</span><span class="n">dirfd</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The experimental run gives:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Time difference = 36195[ms]
Total files: 942330
Time difference = 37179[ms]
Total files: 942330
Time difference = 35888[ms]
Total files: 942330
Time difference = 37209[ms]
Total files: 942330
Time difference = 35302[ms]
Total files: 942330
</code></pre></div></div>

<p>The <code class="highlighter-rouge">man getattrlistbulk</code> command helps to get a documentation on that system call. 
Unfortunately, this code works <em>slower</em> than the code above. It takes approximately <code class="highlighter-rouge">36 seconds</code>
to list all my files that way.</p>

<p>A quick <a href="https://blog.jetbrains.com/clion/2018/10/clion-2018-3-eap-profiler-multiline-todo/">profiling in CLion</a>
show that the most of the work is done in the kernel, in the <code class="highlighter-rouge">getattrlistbulk</code> call.</p>

<p><img src="https://jonnyzzz.com/images/posts/2020-08-12-getattrsbulk.png" alt="CPU Profiles Samples" /></p>

<h1 id="fts-api">FTS API</h1>

<p>I found a related <a href="http://blog.tempel.org/2019/04/dir-read-performance.html">post</a>
by Thomas Tempelmann on the same topic. Worth reading!</p>

<p>Yet another possibility is to use the <code class="highlighter-rouge">FTS</code> C-functions to iterate the filesystem:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kt">int</span> <span class="nf">compare</span><span class="p">(</span><span class="k">const</span> <span class="n">FTSENT</span> <span class="o">**</span><span class="n">one</span><span class="p">,</span> <span class="k">const</span> <span class="n">FTSENT</span> <span class="o">**</span><span class="n">two</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">((</span><span class="o">*</span><span class="n">one</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">fts_name</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">two</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">fts_name</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">scanDirs</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">home</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">buff</span><span class="p">[</span><span class="mi">222333</span><span class="p">];</span>
    <span class="kt">char</span><span class="o">*</span> <span class="n">pName</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">buff</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">strcpy</span><span class="p">(</span><span class="n">pName</span><span class="p">,</span> <span class="n">home</span><span class="p">);</span>
    <span class="n">FTS</span><span class="o">*</span> <span class="n">file_system</span> <span class="o">=</span> <span class="n">fts_open</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pName</span><span class="p">,</span> <span class="n">FTS_COMFOLLOW</span> <span class="o">|</span> <span class="n">FTS_NOCHDIR</span> <span class="o">|</span> <span class="n">FTS_PHYSICAL</span> <span class="o">|</span> <span class="n">FTS_NOSTAT_TYPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">compare</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">file_system</span> <span class="o">==</span> <span class="nb">nullptr</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">(</span><span class="n">fts_read</span><span class="p">(</span><span class="n">file_system</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">nullptr</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FTSENT</span> <span class="o">*</span><span class="n">child</span> <span class="o">=</span> <span class="n">fts_children</span><span class="p">(</span><span class="n">file_system</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">child</span> <span class="o">!=</span> <span class="nb">nullptr</span> <span class="o">&amp;&amp;</span> <span class="n">child</span><span class="o">-&gt;</span><span class="n">fts_link</span> <span class="o">!=</span> <span class="nb">nullptr</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">child</span> <span class="o">=</span> <span class="n">child</span><span class="o">-&gt;</span><span class="n">fts_link</span><span class="p">;</span>
            <span class="n">count</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">fts_close</span><span class="p">(</span><span class="n">file_system</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This code executes in approximately <code class="highlighter-rouge">26 seconds</code>. The <code class="highlighter-rouge">man fts_open</code> command helps to learn
more about the API:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Time difference = 26353[ms]
Time difference = 25987[ms]
Time difference = 26439[ms]
Time difference = 26885[ms]
Time difference = 26648[ms]
</code></pre></div></div>

<h1 id="conclusion">Conclusion</h1>

<p>There is <a href="https://en.wikipedia.org/wiki/No_Silver_Bullet">no silver bullet</a>, but I will
continue the research to try to find a way to list files faster. At that point it looks
like the whole filesystem abstraction is leaking. There are another approaches to represent
is like <a href="https://aws.amazon.com/s3/">S3</a>, <a href="https://min.io/">Minio</a>,
<a href="https://hadoop.apache.org/docs/r1.2.1/hdfs_design.html">HDFS</a>, or anything similar.
FUSE and Docker filesystems look promising too, but I do not see how to apply that. 
Hope there is something I miss. I’ll be grateful to hear more ideas in the comments.</p>

        
          <div id="disqus_thread"></div><!-- /#disqus_thread -->
          
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'jonnyzzz'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

        
      </div><!-- /.entry-content -->
    </div><!-- /.entry-wrapper -->
    <nav class="pagination" role="navigation">
      
        <a href="/blog/2020/04/06/delegated-property/" class="btn" title="Delegated Properties in Kotlin">Previous</a>
      
      
        <a href="/blog/2021/01/31/kotlin-prefix/" class="btn" title="Prefix or Null with Kotlin?">Next</a>
      
    </nav><!-- /.pagination -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo" class="entry-wrapper">
    

<span>
  &copy; 2005—2025 Eugene Petrenko.
  <br />
  Unless otherwise noted, the content on the website is licensed under a
  <a href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a> license.
  <br />
  Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using
  the <a href="https://mademistakes.com/work/so-simple-jekyll-theme/" rel="nofollow">So Simple Theme</a>.
</span>
<div class="social-icons">
	<a href="https://twitter.com/jonnyzzz" title="Eugene Petrenko on Twitter" target="_blank"><i class="fa fa-twitter-square fa-2x"></i></a>
	<a href="https://facebook.com/jonnyzzz" title="Eugene Petrenko on Facebook" target="_blank"><i class="fa fa-facebook-square fa-2x"></i></a>
	
	<a href="https://linkedin.com/in/jonnyzzz" title="Eugene Petrenko on LinkedIn" target="_blank"><i class="fa fa-linkedin-square fa-2x"></i></a>
	<a href="http://stackoverflow.com/users/49811/eugene-petrenko" title="Eugene Petrenko on StackExchange" target="_blank"><i class="fa fa-stack-exchange fa-2x"></i></a>
	<a href="https://instagram.com/jonnyzzz" title="Eugene Petrenko on Instagram" target="_blank"><i class="fa fa-instagram fa-2x"></i></a>
	<a href="https://www.flickr.com/photos/_jonny_" title="Eugene Petrenko on Flickr" target="_blank"><i class="fa fa-flickr fa-2x"></i></a>
	<a href="https://github.com/jonnyzzz" title="Eugene Petrenko on Github" target="_blank"><i class="fa fa-github-square fa-2x"></i></a>
	
  <a href="https://www.pinterest.com/jonnyzzz/" title="Eugene Petrenko on Pinterest" target="_blank"><i class="fa fa-pinterest fa-2x"></i></a>
	
  <a href="https://feeds.feedburner.com/jonnyzzz" title="Atom/RSS feed"><i class="fa fa-rss-square fa-2x"></i></a>
</div><!-- /.social-icons -->

  </footer>
</div><!-- /.footer-wrapper -->

<script type="text/javascript">
  var BASE_URL = '';
</script>

<script>
  // use links _blank by default
  Array.from(document.links).forEach(link => {
    if (link.hostname !== window.location.hostname) {
      link.target = '_blank';
    }
  });
</script>


<!-- Google Analytics (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-70104598-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-70104598-1');
</script>
<!-- End Google Analytics -->





<!--SYNTAX HIGHLIGHTER BEGINS-->
<!-- see https://prismjs.com/ download generator -->
<link rel="stylesheet" href="/assets/prismjs/prism.css"/>

<script src="/assets/prismjs/prism.js" ></script>

<!--SYNTAX HIGHLIGHTER ENDS-->



</body>
</html>
