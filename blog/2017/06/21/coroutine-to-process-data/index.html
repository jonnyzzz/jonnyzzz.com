<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8" />
<title>A Kotlin Coroutine for an OutputStream Filtering &#8211; Eugene Petrenko</title>
<meta name="description" content="Kotlin coroutines for OutputStream.

"/>
<meta name="keywords" content="jonnyzzz, Евгений Петренко, Eugene Petrenko, kotlin, coroutine" />


<!-- Twitter Cards -->
<meta name="twitter:title" content="A Kotlin Coroutine for an OutputStream Filtering -- Eugene Petrenko" />
<meta name="twitter:description" content="Kotlin coroutines for OutputStream.

" />
<meta name="twitter:site" content="@jonnyzzz" />
<meta name="twitter:creator" content="@jonnyzzz" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="https://jonnyzzz.com/images/me.jpg" />

<!-- Open Graph -->

<meta property="og:type" content="article" />
<meta property="og:image" content="https://jonnyzzz.com/images/me.jpg" />
<meta property="og:title" content="A Kotlin Coroutine for an OutputStream Filtering -- Eugene Petrenko" />
<meta property="og:description" content="Kotlin coroutines for OutputStream.

" />
<meta property="og:url" content="https://jonnyzzz.com/blog/2017/06/21/coroutine-to-process-data/" />
<meta property="og:site_name" content="Eugene Petrenko" />

<meta property="article:tag" content="jonnyzzz" />

<meta property="article:tag" content="Евгений Петренко" />

<meta property="article:tag" content="Eugene Petrenko" />


<meta property="article:tag" content="kotlin" />

<meta property="article:tag" content="coroutine" />



<!-- Webmaster Tools verfication -->
<meta name="google-site-verification" content="MJZCyfst2Tx4KyxbOIQu1fZyOSwA_JkQu73zJcfsl2g" />




<link rel="canonical" href="https://jonnyzzz.com/blog/2017/06/21/coroutine-to-process-data/" />
<link href="https://feeds.feedburner.com/jonnyzzz" type="application/atom+xml" rel="alternate" title="ATOM Feed" />

<meta name="HandheldFriendly" content="True" />
<meta name="MobileOptimized" content="320" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css" />

<!-- Webfonts -->
<script src="https://use.edgefonts.net/source-sans-pro:n2,i2,n3,i3,n4,i4,n6,i6,n7,i7,n9,i9;source-code-pro:n4,n7;volkhov.js"></script>

<meta http-equiv="cleartype" content="on" />

<!-- HTML5 Shiv and Media Query Support -->
<!--[if lt IE 9]>
  <script src="/assets/js/vendor/html5shiv.min.js"></script>
  <script src="/assets/js/vendor/respond.min.js"></script>
<![endif]-->

<!-- Modernizr -->
<script src="/assets/js/vendor/modernizr-2.7.1.custom.min.js"></script>

<link rel="apple-touch-icon" sizes="57x57" href="/images/apple-icon-57x57.png" />
<link rel="apple-touch-icon" sizes="60x60" href="/images/apple-icon-60x60.png" />
<link rel="apple-touch-icon" sizes="72x72" href="/images/apple-icon-72x72.png" />
<link rel="apple-touch-icon" sizes="76x76" href="/images/apple-icon-76x76.png" />
<link rel="apple-touch-icon" sizes="114x114" href="/images/apple-icon-114x114.png" />
<link rel="apple-touch-icon" sizes="120x120" href="/images/apple-icon-120x120.png" />
<link rel="apple-touch-icon" sizes="144x144" href="/images/apple-icon-144x144.png" />
<link rel="apple-touch-icon" sizes="152x152" href="/images/apple-icon-152x152.png" />
<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-icon-180x180.png" />
<link rel="icon" type="image/png" sizes="192x192"  href="/images/android-icon-192x192.png" />
<link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png" />
<link rel="icon" type="image/png" sizes="96x96" href="/images/favicon-96x96.png" />
<link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png" />
<link rel="manifest" href="/images/manifest.json" />
<meta name="msapplication-TileColor" content="#ffffff" />
<meta name="msapplication-TileImage" content="/images/ms-icon-144x144.png" />
<meta name="theme-color" content="#ffffff" />

</head>

<body id="post">

<div class="navigation-wrapper">
	<nav role="navigation" id="site-nav" class="animated drop">
	    <ul>
      
		    
		    <li><a href="/about/" >About</a></li>
		  
		    
		    <li><a href="/blog/" >Blog</a></li>
		  
		    
		    <li><a href="/projects/" >Projects</a></li>
		  
		    
		    <li><a href="/talks/" >Talks</a></li>
		  
		    
		    <li><a href="/tags/" >Tags</a></li>
		  
	    </ul>
	</nav>
</div><!-- /.navigation-wrapper -->

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->

<header class="masthead">
	<div class="wrap">
      
      <h1 class="site-title animated fadeIn"><a href="/">Eugene Petrenko</a></h1>
		<h2 class="site-description animated fadeIn" itemprop="description">@jonnyzzz personal page and blog</h2>
	</div>
</header><!-- /.masthead -->

<div class="js-menu-screen menu-screen"></div>


<div id="main" role="main">
  <article class="hentry">
    
    <div class="entry-wrapper">
      <header class="entry-header">
        <ul class="entry-tags">
          <li><a href="/tags/#kotlin" title="Pages tagged kotlin">kotlin</a></li><li><a href="/tags/#coroutine" title="Pages tagged coroutine">coroutine</a></li>
        </ul>
        
          <h1 class="entry-title">A Kotlin Coroutine for an OutputStream Filtering</h1>
        
      </header>
      <footer class="entry-meta">
        
        
          <img src="/images/me.jpg" class="bio-photo" alt="Eugene Petrenko bio photo"></a>
        
        <span class="author vcard">By <span class="fn">Eugene Petrenko</span></span>
        <span class="entry-date date published"><time datetime="2017-06-21T00:00:00+00:00"><i class="fa fa-calendar-o"></i> June 21, 2017</time></span>
        
        <span class="entry-comments"><i class="fa fa-comment-o"></i> <a href="#disqus_thread">Comment</a></span>
        <span class="social-share-twitter">
  <a href="https://twitter.com/intent/tweet?hashtags=kotlin,coroutine&amp;text=A%20Kotlin%20Coroutine%20for%20an%20OutputStream%20Filtering&amp;url=https://jonnyzzz.com/blog/2017/06/21/coroutine-to-process-data/&amp;via=jonnyzzz" title="Share on Twitter" itemprop="Twitter" target="_blank"><i class="fa fa-twitter-square"></i> Tweet</a>
</span>
<span class="social-share-facebook">
  <a href="https://www.facebook.com/sharer/sharer.php?u=https://jonnyzzz.com/blog/2017/06/21/coroutine-to-process-data/" title="Share on Facebook" itemprop="Facebook" target="_blank"><i class="fa fa-facebook-square"></i> Like</a>
</span>

<!-- /.social-share -->

        
      </footer>
      <div class="entry-content">
        <p>Kotlin coroutines for OutputStream.</p>

<p>In this post, we consider a low-level implementation for specific 
coroutines that are used to process streams in a server-side Java application. 
There is an existing code that writes the output to a given <code>OutputStream</code> object. 
One may write it in Java as:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">interface</span> <span class="nc">ExistingService</span> <span class="o">{</span>
  <span class="kt">void</span> <span class="nf">callExistingCode</span><span class="o">(</span><span class="n">OutputStream</span> <span class="n">resultOutput</span><span class="o">)</span>
<span class="o">}</span></code></pre></figure>

<p>We need to intercept the output that is bing written by the <code>#callExistingCode</code> function.</p>

<h1 id="example">Example</h1>
<p>Say the <code>ExistingService</code> replies with an HTML, and the goal is to extract some part of it, say a <code>&lt;div&gt;</code>
with a given <code>id</code>.
Or an <code>ExistingService</code> may be returning a ZIP archive, and the goal can be to add a file in it.</p>

<p>There are many similar cases, where an <code>OutputStream</code> post processing can be necessary.</p>

<h1 id="problem-statement">Problem Statement</h1>
<p>Suppose the <code>ExistingService</code> writes output in the following format:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>(&lt;SIZE&gt;&lt;CHANNEL-ID&gt;&lt;DATA&gt;)*</code></pre></figure>

<p>Where <code>&lt;SIZE&gt;</code> is 4 bytes length message. <code>&lt;CHANNEL-ID&gt;</code> is a one-byte message. <code>&lt;DATA&gt;</code> is a 
byte sequence of given size.</p>

<p>The such or similar format is widely used to send several streams within one connection. For example,
it is used in <a href="https://www.ietf.org/rfc/rfc4251.txt">SSH-2</a>, <a href="https://tools.ietf.org/html/rfc7540">HTTP/2</a>
or <a href="https://github.com/git/git/blob/master/Documentation/technical/pack-protocol.txt">Git</a>.</p>

<p>Out goal is to include additional messages to the stream on the fly, while it is being generated 
by the call to an <code>ExistingService</code>.
We just need to implement the method:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="n">OutputStream</span> <span class="nf">weaveStream</span><span class="o">(</span><span class="n">OutputStream</span> <span class="n">target</span><span class="o">);</span></code></pre></figure>

<h1 id="a-trivial-java-implementation">A Trivial Java Implementation</h1>

<p>In Java we have <code>PipedOutputStream</code>/<code>PipedInputStream</code> classes that may turn an OutputStream 
into an <code>InputStream</code>. Next, the processing can be done easily.</p>

<p>We have a thread, that reads data from an <code>InputStream</code>, e.g.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="n">OutputStream</span> <span class="nf">weaveStream</span><span class="o">(</span><span class="n">OutputStream</span> <span class="n">target</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
  <span class="n">PipedOutputStream</span> <span class="n">pos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PipeOutputStream</span><span class="o">();</span>
  <span class="n">PipedInputStream</span> <span class="n">pis</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PipedInputStream</span><span class="o">(</span><span class="n">pos</span><span class="o">);</span>
  
  <span class="n">runInThread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">weaveStream</span><span class="o">(</span><span class="n">pis</span><span class="o">,</span> <span class="n">target</span><span class="o">));</span>
  <span class="k">return</span> <span class="n">pos</span><span class="o">;</span>
<span class="o">}</span>

<span class="kt">void</span> <span class="nf">weaveStream</span><span class="o">(</span><span class="n">InputStream</span> <span class="n">source</span><span class="o">,</span> <span class="n">OutputStream</span> <span class="n">target</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">//omitted error processing here</span>
      <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">extractSize</span><span class="o">(</span><span class="n">source</span><span class="o">.</span><span class="na">read</span><span class="o">(),</span> <span class="n">source</span><span class="o">.</span><span class="na">read</span><span class="o">(),</span> <span class="n">source</span><span class="o">.</span><span class="na">read</span><span class="o">(),</span> <span class="n">source</span><span class="o">.</span><span class="na">read</span><span class="o">());</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">isLastBlock</span><span class="o">(</span><span class="n">size</span><span class="o">))</span> <span class="k">return</span><span class="o">;</span>

      <span class="kt">int</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">extractChannelId</span><span class="o">(</span><span class="n">source</span><span class="o">.</span><span class="na">read</span><span class="o">());</span>

      <span class="n">writeHeader</span><span class="o">(</span><span class="n">target</span><span class="o">,</span> <span class="n">size</span><span class="o">,</span> <span class="n">ch</span><span class="o">);</span>
      <span class="n">copyBlock</span><span class="o">(</span><span class="n">target</span><span class="o">,</span> <span class="n">size</span><span class="o">,</span> <span class="n">source</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>The cost here is high. We need an additional thread to implement that. Additionally, 
the whole data is copied to a buffer from which a <code>PipedInputStream</code> is reading. 
Finally, piped streams implementation uses a level of synchronization to wait for 
next data portion to arrive. That can be problematic for some loads.</p>

<h1 id="a-smart-java-implementation">A Smart Java Implementation</h1>

<p>One can do a smarter implementation. Directly implement the <code>OutputStream</code> and do the processing
and patching the output in there.</p>

<p>What we do here is to add a state to our <code>OutputStream</code> implementation. Each call to <code>write</code> method
yields an update of the state.</p>

<p>A <em>State Machine</em>. That is what the code from here is about. It is up to programmer if to have a state
explicitly or not. Think about maintainability of such code first.</p>

<p>The implementation here can be quite complex. As an example, I show a byte-by-byte 
processing. In real cases, it can be way more efficient to implement 
<code>write(byte[], int, int)</code> method.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="n">OutputStream</span> <span class="nf">weaveStream</span><span class="o">(</span><span class="n">OutputStream</span> <span class="n">target</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="n">OutputStream</span><span class="o">()</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="kt">int</span> <span class="n">b</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">isReadingSize</span><span class="o">())</span> <span class="o">{</span>
       <span class="n">readMoreSize</span><span class="o">(</span><span class="n">b</span><span class="o">);</span> 
      <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">isReadingChannelId</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">readMoreChannelId</span><span class="o">(</span><span class="n">b</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">isProcessingData</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">processModeData</span><span class="o">(</span><span class="n">b</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">IOException</span><span class="o">(</span><span class="s">&quot;Unexpected state&quot;</span><span class="o">);</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">};</span>
<span class="o">}</span></code></pre></figure>

<p>The benefit here is that we no longer need an extra thread to pipe the output as input. Sill, code 
is getting more complex.</p>

<h1 id="a-coroutine-state-machine">A Coroutine State Machine</h1>

<p>In Kotlin 1.1 we have <a href="http://kotlinlang.org/docs/reference/coroutines.html">coroutines</a>. The alternative way 
to implement a state machine with the help of compiler, with way more readable, linear-looking code.</p>

<p>First, we need to declare an interface with <code>suspend</code> functions, e.g.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">interface</span> <span class="nc">DataReader</span> <span class="o">{</span>
  <span class="n">suspend</span> <span class="n">fun</span> <span class="nf">read</span><span class="o">()</span> <span class="o">:</span> <span class="n">Int</span>
  
  <span class="n">suspend</span> <span class="n">fun</span> <span class="nf">pipe</span><span class="o">(</span><span class="n">sz</span> <span class="o">:</span> <span class="n">Int</span><span class="o">,</span> <span class="n">to</span><span class="o">:</span> <span class="n">OutputStream</span><span class="o">)</span>
<span class="o">}</span></code></pre></figure>

<p>Also, we need an implementation of the <code>OutputStream</code> that allows us to use the <code>DataReader</code>. That is 
the function <code>inverseRead</code>. We’ll turn back to the implementation a bit later.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="n">fun</span> <span class="nf">inverseRead</span><span class="o">(</span><span class="n">reader</span><span class="o">:</span> <span class="n">suspend</span> <span class="n">DataReader</span><span class="o">.()</span> <span class="o">-&gt;</span> <span class="n">Unit</span><span class="o">)</span> <span class="o">:</span> <span class="n">OutputStream</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span></code></pre></figure>

<p>Finally, we are able to implement the data processing:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="n">fun</span> <span class="nf">weaveStream</span><span class="o">(</span><span class="n">target</span><span class="o">:</span> <span class="n">OutputStream</span><span class="o">):</span> <span class="n">OutputStream</span> <span class="o">{</span>
  <span class="k">return</span> <span class="n">inverseRead</span> <span class="o">{</span> <span class="n">reader</span> <span class="o">-&gt;</span>
    <span class="n">readStream</span><span class="o">(</span><span class="n">reader</span><span class="o">,</span> <span class="n">target</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="n">suspend</span> <span class="n">fun</span> <span class="nf">readStream</span><span class="o">(</span><span class="n">source</span><span class="o">:</span> <span class="n">DataReader</span><span class="o">,</span> <span class="n">target</span><span class="o">:</span> <span class="n">OutputStream</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">while</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">val</span> <span class="n">sz</span> <span class="o">=</span> <span class="n">extractSize</span><span class="o">(</span><span class="n">source</span><span class="o">.</span><span class="na">read</span><span class="o">(),</span> <span class="n">source</span><span class="o">.</span><span class="na">read</span><span class="o">(),</span> <span class="n">source</span><span class="o">.</span><span class="na">read</span><span class="o">(),</span> <span class="n">source</span><span class="o">.</span><span class="na">read</span><span class="o">())</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">isLastBlock</span><span class="o">(</span><span class="n">sz</span><span class="o">))</span> <span class="k">return</span>
    <span class="n">val</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">extractChannelId</span><span class="o">(</span><span class="n">source</span><span class="o">.</span><span class="na">read</span><span class="o">())</span>

    <span class="n">writeHeader</span><span class="o">(</span><span class="n">target</span><span class="o">,</span> <span class="n">sz</span><span class="o">,</span> <span class="n">ch</span><span class="o">)</span>
    <span class="n">source</span><span class="o">.</span><span class="na">pipe</span><span class="o">(</span><span class="n">sz</span><span class="o">,</span> <span class="n">target</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>Check the code above. It is quite similar to what we had in <em>A Trivial Java Implementation</em>. The difference
is huge. Every call to <code>suspend</code> function pauses the execution of a method, so the execution turns to
the <code>write</code> method implementation of <code>OutputStream</code> in <code>inverseRead</code>. We are able now to write
a linear looking code, that is executed in a piece-by-piece manner.</p>

<h1 id="implementation-of-the-coroutine">Implementation of the Coroutine</h1>

<p>The only missing part is the <code>inverseRead</code>. We follow the <a href="http://kotlinlang.org/docs/reference/coroutines.html">coroutines documentation</a>
to implement that. Great is there are many examples too.</p>

<p>We implement <code>DataReader#read</code> and <code>DataReader#pipe</code> functions to suspend execution until there is enough data
send to <code>OutputStream#write</code> method. We have the following state object for that:</p>

<figure class="highlight"><pre><code class="language-kotlin" data-lang="kotlin"><span></span><span class="k">class</span> <span class="nc">DataReaderState</span> <span class="p">{</span>
  <span class="k">var</span> <span class="py">readByteContinuation</span> <span class="p">=</span> <span class="k">null</span> <span class="k">as</span> <span class="n">Continuation</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">&gt;?</span>

  <span class="k">var</span> <span class="py">pipeContinuation</span> <span class="p">=</span> <span class="k">null</span> <span class="k">as</span> <span class="n">Continuation</span><span class="p">&lt;</span><span class="n">Unit</span><span class="p">&gt;?</span>
  <span class="k">var</span> <span class="py">pipeTarget</span> <span class="p">=</span> <span class="k">null</span> <span class="k">as</span> <span class="n">OutputStream</span><span class="p">?</span>
  <span class="k">var</span> <span class="py">pipeSizeToWrite</span> <span class="p">=</span> <span class="m">0</span>
<span class="p">}</span></code></pre></figure>

<p>Next, we are able to implement the <code>DataReader</code> interface in the following way:</p>

<figure class="highlight"><pre><code class="language-kotlin" data-lang="kotlin"><span></span><span class="k">class</span> <span class="nc">DataReaderImpl</span><span class="p">(</span><span class="k">val</span> <span class="py">state</span><span class="p">:</span> <span class="n">DataReaderState</span><span class="p">)</span> <span class="p">:</span> <span class="n">DataReader</span> <span class="p">{</span>
  <span class="n">suspend</span> <span class="k">override</span> <span class="k">fun</span> <span class="nf">pipe</span><span class="p">(</span><span class="n">sz</span><span class="p">:</span> <span class="n">Int</span><span class="p">,</span> <span class="n">to</span><span class="p">:</span> <span class="n">OutputStream</span><span class="p">):</span> <span class="n">Unit</span> <span class="p">=</span> <span class="n">suspendCoroutine</span><span class="p">&lt;</span><span class="n">Unit</span><span class="p">&gt;</span> <span class="p">{</span> <span class="n">c</span> <span class="p">-&gt;</span>
    <span class="n">state</span><span class="p">.</span><span class="n">pipeContinuation</span> <span class="p">=</span> <span class="n">c</span>
    <span class="n">state</span><span class="p">.</span><span class="n">pipeSizeToWrite</span> <span class="p">=</span> <span class="n">sz</span>
    <span class="n">state</span><span class="p">.</span><span class="n">pipeTarget</span> <span class="p">=</span> <span class="n">to</span>
  <span class="p">}</span>

  <span class="n">suspend</span> <span class="k">override</span> <span class="k">fun</span> <span class="nf">read</span><span class="p">():</span> <span class="n">Int</span> <span class="p">=</span> <span class="n">suspendCoroutine</span> <span class="p">{</span> <span class="n">c</span> <span class="p">-&gt;</span>
    <span class="n">state</span><span class="p">.</span><span class="n">readByteContinuation</span> <span class="p">=</span> <span class="n">c</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>All we have here is a call to the specific <code>suspendCoroutine</code> function in Kotlin, which does the suspend. I decided
to omit for simplicity a defensive asserts that one may have in both <code>pipe</code> and <code>read</code> function implementation.</p>

<p>The <code>OutputStream</code> implementation in the example is executing next suspended function in a loop. The current
implementation does not check the state at the end of data too. The straightforward implementation is as follows:</p>

<figure class="highlight"><pre><code class="language-kotlin" data-lang="kotlin"><span></span><span class="k">class</span> <span class="nc">DataReaderOutputStreamImpl</span><span class="p">(</span><span class="k">val</span> <span class="py">state</span><span class="p">:</span> <span class="n">DataReaderState</span><span class="p">)</span> <span class="p">:</span> <span class="n">OutputStream</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">override</span> <span class="k">fun</span> <span class="nf">write</span><span class="p">(</span><span class="n">b</span><span class="p">:</span> <span class="n">Int</span><span class="p">)</span> <span class="p">=</span> <span class="n">write</span><span class="p">(</span><span class="n">byteArrayOf</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">toByte</span><span class="p">()))</span>

  <span class="k">override</span> <span class="k">tailrec</span> <span class="k">fun</span> <span class="nf">write</span><span class="p">(</span><span class="n">b</span><span class="p">:</span> <span class="n">ByteArray</span><span class="p">,</span> <span class="n">off</span><span class="p">:</span> <span class="n">Int</span><span class="p">,</span> <span class="n">len</span><span class="p">:</span> <span class="n">Int</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="p">&lt;=</span> <span class="m">0</span><span class="p">)</span> <span class="k">return</span>

    <span class="k">val</span> <span class="py">readOneByte</span> <span class="p">=</span> <span class="n">state</span><span class="p">.</span><span class="n">readByteContinuation</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">readOneByte</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">readOneByte</span><span class="p">.</span><span class="n">resume</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">off</span><span class="p">].</span><span class="n">toInt</span><span class="p">())</span>
      <span class="k">return</span> <span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">off</span><span class="p">+</span><span class="m">1</span><span class="p">,</span> <span class="n">len</span><span class="p">-</span><span class="m">1</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">val</span> <span class="py">pipe</span> <span class="p">=</span> <span class="n">state</span><span class="p">.</span><span class="n">pipeContinuation</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pipe</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">val</span> <span class="py">toPipe</span> <span class="p">=</span> <span class="n">Math</span><span class="p">.</span><span class="n">min</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">state</span><span class="p">.</span><span class="n">pipeSizeToWrite</span><span class="p">)</span>
      <span class="n">state</span><span class="p">.</span><span class="n">pipeTarget</span><span class="o">!!</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">toPipe</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">off</span><span class="p">+</span><span class="n">toPipe</span><span class="p">,</span> <span class="n">len</span> <span class="p">-</span> <span class="n">toPipe</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">throw</span> <span class="n">Error</span><span class="p">(</span><span class="s">&quot;Illegal state&quot;</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>At that moment we are ready to implement the <code>inverseRead</code> function.</p>

<figure class="highlight"><pre><code class="language-kotlin" data-lang="kotlin"><span></span><span class="k">fun</span> <span class="nf">inverseRead</span><span class="p">(</span><span class="n">reader</span><span class="p">:</span> <span class="n">suspend</span> <span class="p">(</span><span class="n">DataReader</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">)</span> <span class="p">:</span> <span class="n">OutputStream</span> <span class="p">{</span>
  <span class="k">val</span> <span class="py">state</span> <span class="p">=</span> <span class="n">DataReaderState</span><span class="p">()</span>
  <span class="k">val</span> <span class="py">outputStream</span> <span class="p">=</span> <span class="n">DataReaderOutputStreamImpl</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
  <span class="k">val</span> <span class="py">dataReader</span> <span class="p">=</span> <span class="n">DataReaderImpl</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
  <span class="k">val</span> <span class="py">continuation</span> <span class="p">=</span> <span class="n">DataReaderContinuation</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

  <span class="n">reader</span><span class="p">.</span><span class="n">createCoroutine</span><span class="p">(</span><span class="n">dataReader</span><span class="p">,</span><span class="n">continuation</span><span class="p">).</span><span class="n">resume</span><span class="p">(</span><span class="n">Unit</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">outputStream</span>
<span class="p">}</span></code></pre></figure>

<h1 id="coroutine-vs-state-machine">Coroutine vs State Machine</h1>

<p>It turned out we still needed to implement a state machine (via <code>DataReaderState</code> class). It 
was necessary to add a state for each <code>suspend</code> function of <code>DataReader</code> interface. That was 
the code we need to write as building block (and there 
are <a href="https://github.com/Kotlin/kotlinx.coroutines">amazing libraries</a> for most 
of the cases)</p>

<p>The good part is that the rest part of the code, where we do the actual data decoding (the <code>readStream</code> function)
now free from an explicit state machine style programming. One can have code written as easy
as possible. It’s easier to understand and to check. And, for example, we may use loops, try-catches 
and any other code constructs we like using for ordinary programs.</p>

<p>In other words, with the help of Kotlin suspend functions we may minimize the number of complex functions and
concentrate on the actual development.</p>

<p>For more information on coroutines power in Kotlin, you may refer to 
<a href="https://vimeo.com/221264980/b3ac7f9001">GeekOut Talk by Roman Elizarov</a>
or to <a href="http://kotlinlang.org/docs/reference/coroutines.html">the documentation</a></p>


        
          <div id="disqus_thread"></div><!-- /#disqus_thread -->
          
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'jonnyzzz'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

        
      </div><!-- /.entry-content -->
    </div><!-- /.entry-wrapper -->
    <nav class="pagination" role="navigation">
      
        <a href="/blog/2017/06/07/a-post-every-two-weeks/" class="btn" title="A post per 2 weeks">Previous</a>
      
      
        <a href="/blog/2017/07/05/go-build/" class="btn" title="Building Go Project">Next</a>
      
    </nav><!-- /.pagination -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo" class="entry-wrapper">
    

<span>
  &copy; 2005—2018 Eugene Petrenko.
  <br />
  Unless otherwise noted, the content on the website is licensed under a
  <a href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a> license.
  <br />
  Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using
  the <a href="https://mademistakes.com/work/so-simple-jekyll-theme/" rel="nofollow">So Simple Theme</a>.
</span>
<div class="social-icons">
	<a href="https://twitter.com/jonnyzzz" title="Eugene Petrenko on Twitter" target="_blank"><i class="fa fa-twitter-square fa-2x"></i></a>
	<a href="https://facebook.com/jonnyzzz" title="Eugene Petrenko on Facebook" target="_blank"><i class="fa fa-facebook-square fa-2x"></i></a>
	<a href="https://plus.google.com/+EugenePetrenko_jonnyzzz" title="Eugene Petrenko on Google+" target="_blank"><i class="fa fa-google-plus-square fa-2x"></i></a>
	<a href="https://linkedin.com/in/jonnyzzz" title="Eugene Petrenko on LinkedIn" target="_blank"><i class="fa fa-linkedin-square fa-2x"></i></a>
	<a href="http://stackoverflow.com/users/49811/eugene-petrenko" title="Eugene Petrenko on StackExchange" target="_blank"><i class="fa fa-stack-exchange fa-2x"></i></a>
	<a href="https://instagram.com/jonnyzzz" title="Eugene Petrenko on Instagram" target="_blank"><i class="fa fa-instagram fa-2x"></i></a>
	<a href="https://www.flickr.com/photos/_jonny_" title="Eugene Petrenko on Flickr" target="_blank"><i class="fa fa-flickr fa-2x"></i></a>
	<a href="https://github.com/jonnyzzz" title="Eugene Petrenko on Github" target="_blank"><i class="fa fa-github-square fa-2x"></i></a>
	
  <a href="https://www.pinterest.com/jonnyzzz/" title="Eugene Petrenko on Pinterest" target="_blank"><i class="fa fa-pinterest fa-2x"></i></a>
	
  <a href="https://feeds.feedburner.com/jonnyzzz" title="Atom/RSS feed"><i class="fa fa-rss-square fa-2x"></i></a>
</div><!-- /.social-icons -->

  </footer>
</div><!-- /.footer-wrapper -->

<script type="text/javascript">
  var BASE_URL = '';
</script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="/assets/js/scripts.min.js"></script>


<!-- Asynchronous Google Analytics snippet -->
<script>
  var _gaq = _gaq || [];
  var pluginUrl =
 'https://www.google-analytics.com/plugins/ga/inpage_linkid.js';
  _gaq.push(['_require', 'inpage_linkid', pluginUrl]);
  _gaq.push(['_setAccount', 'UA-70104598-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = 'https://stats.g.doubleclick.net/dc.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>




<!-- MathJax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


<script type="text/javascript">
  window.cookieconsent_options = {"message":"This website uses cookies to ensure you get the best experience on our website","dismiss":"Got it!","learnMore":"More info","link":null,"theme":"light-bottom"};
</script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/1.0.9/cookieconsent.min.js"></script>



<!--SYNTAX HIGHLIGHTER BEGINS-->

<script src="/assets/syntax/syntax.js"></script>

<link rel="stylesheet" href="/assets/syntax/syntax.css" />

<!--SYNTAX HIGHLIGHTER ENDS-->



</body>
</html>
