<!doctype html>
<html class="no-js" lang="en">
<head>
<meta charset="utf-8" />
<title>A Kotlin Coroutine for an OutputStream Filtering &#8211; Eugene Petrenko</title>
<meta name="description" content="Kotlin coroutines for OutputStream.
"/>
<meta name="keywords" content="jonnyzzz, Евгений Петренко, Eugene Petrenko, kotlin, coroutine" />


<!-- Twitter Cards -->
<meta name="twitter:title" content="A Kotlin Coroutine for an OutputStream Filtering -- Eugene Petrenko" />
<meta name="twitter:description" content="Kotlin coroutines for OutputStream.
" />
<meta name="twitter:site" content="@jonnyzzz" />
<meta name="twitter:creator" content="@jonnyzzz" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="https://jonnyzzz.com/images/me.jpg" />

<!-- Open Graph -->

<meta property="og:type" content="article" />
<meta property="og:image" content="https://jonnyzzz.com/images/me.jpg" />
<meta property="og:title" content="A Kotlin Coroutine for an OutputStream Filtering -- Eugene Petrenko" />
<meta property="og:description" content="Kotlin coroutines for OutputStream.
" />
<meta property="og:url" content="https://jonnyzzz.com/blog/2017/06/21/coroutine-to-process-data/" />
<meta property="og:site_name" content="Eugene Petrenko" />

<meta property="article:tag" content="jonnyzzz" />

<meta property="article:tag" content="Евгений Петренко" />

<meta property="article:tag" content="Eugene Petrenko" />


<meta property="article:tag" content="kotlin" />

<meta property="article:tag" content="coroutine" />



<!-- Webmaster Tools verfication -->
<meta name="google-site-verification" content="MJZCyfst2Tx4KyxbOIQu1fZyOSwA_JkQu73zJcfsl2g" />




<link rel="canonical" href="https://jonnyzzz.com/blog/2017/06/21/coroutine-to-process-data/" />
<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="ATOM Feed" />

<meta name="HandheldFriendly" content="True" />
<meta name="MobileOptimized" content="320" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css" />

<link rel="apple-touch-icon" sizes="57x57" href="/images/apple-icon-57x57.png" />
<link rel="apple-touch-icon" sizes="60x60" href="/images/apple-icon-60x60.png" />
<link rel="apple-touch-icon" sizes="72x72" href="/images/apple-icon-72x72.png" />
<link rel="apple-touch-icon" sizes="76x76" href="/images/apple-icon-76x76.png" />
<link rel="apple-touch-icon" sizes="114x114" href="/images/apple-icon-114x114.png" />
<link rel="apple-touch-icon" sizes="120x120" href="/images/apple-icon-120x120.png" />
<link rel="apple-touch-icon" sizes="144x144" href="/images/apple-icon-144x144.png" />
<link rel="apple-touch-icon" sizes="152x152" href="/images/apple-icon-152x152.png" />
<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-icon-180x180.png" />
<link rel="icon" type="image/png" sizes="192x192"  href="/images/android-icon-192x192.png" />
<link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png" />
<link rel="icon" type="image/png" sizes="96x96" href="/images/favicon-96x96.png" />
<link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png" />
<link rel="manifest" href="/images/manifest.json" />
<meta name="msapplication-TileColor" content="#ffffff" />
<meta name="msapplication-TileImage" content="/images/ms-icon-144x144.png" />
<meta name="theme-color" content="#ffffff" />

</head>

<body id="post">

<div class="navigation-wrapper">
	<nav role="navigation" id="site-nav">
	    <ul>
      
		    <li><a href="/" >Home</a></li>
		  
		    <li><a href="/about/" >About</a></li>
		  
		    <li><a href="/blog/" >Blog</a></li>
		  
		    <li><a href="/projects/" >Projects</a></li>
		  
		    <li><a href="/talks/" >Talks</a></li>
		  
		    <li><a href="/tags/" >Tags</a></li>
		  
	    </ul>
	</nav>
</div><!-- /.navigation-wrapper -->

<header class="masthead">
	<div class="wrap">
      
      <h1 class="site-title"><a href="/">Eugene Petrenko</a></h1>
		<h2 class="site-description" itemprop="description">Founding Engineering Leader | Agentic AI DevTools & Experience</h2>
	</div>
</header><!-- /.masthead -->


<div id="main" role="main">
  <article class="hentry">
    
    <div class="entry-wrapper">
      <header class="entry-header">
        <ul class="entry-tags">
          <li><a href="/tags/#kotlin" title="Pages tagged kotlin">kotlin</a></li><li><a href="/tags/#coroutine" title="Pages tagged coroutine">coroutine</a></li>
        </ul>
        
          <h1 class="entry-title">A Kotlin Coroutine for an OutputStream Filtering</h1>
        
      </header>
      <footer class="entry-meta">
        
        
          <img src="/images/me.jpg" class="bio-photo" alt="Eugene Petrenko bio photo"></a>
        
        <span class="author vcard">By <span class="fn">Eugene Petrenko</span></span>
        <span class="entry-date date published"><time datetime="2017-06-21T00:00:00+00:00">June 21, 2017</time></span>
        
        
        <span class="social-share-x">
  <a href="https://x.com/intent/tweet?hashtags=kotlin,coroutine&amp;text=A%20Kotlin%20Coroutine%20for%20an%20OutputStream%20Filtering&amp;url=https://jonnyzzz.com/blog/2017/06/21/coroutine-to-process-data/&amp;via=jonnyzzz" title="Share on X" itemprop="X" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="14" height="14" style="vertical-align: middle; fill: currentColor;"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg> Post</a>
</span>
<span class="social-share-facebook">
  <a href="https://www.facebook.com/sharer/sharer.php?u=https://jonnyzzz.com/blog/2017/06/21/coroutine-to-process-data/" title="Share on Facebook" itemprop="Facebook" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="14" height="14" style="vertical-align: middle; fill: currentColor;"><path d="M22 12c0-5.52-4.48-10-10-10S2 6.48 2 12c0 4.84 3.44 8.87 8 9.8V15H8v-3h2V9.5C10 7.57 11.57 6 13.5 6H16v3h-2c-.55 0-1 .45-1 1v2h3v3h-3v6.95c5.05-.5 9-4.76 9-9.95z"/></svg> Like</a>
</span>
<!-- /.social-share -->

      </footer>
      <div class="entry-content">
        <p>Kotlin coroutines for OutputStream.</p>

<p>In this post, we consider a low-level implementation for specific 
coroutines that are used to process streams in a server-side Java application. 
There is an existing code that writes the output to a given <code class="language-plaintext highlighter-rouge">OutputStream</code> object. 
One may write it in Java as:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">interface</span> <span class="nc">ExistingService</span> <span class="o">{</span>
  <span class="kt">void</span> <span class="nf">callExistingCode</span><span class="o">(</span><span class="nc">OutputStream</span> <span class="n">resultOutput</span><span class="o">)</span>
<span class="o">}</span></code></pre></figure>

<p>We need to intercept the output that is bing written by the <code class="language-plaintext highlighter-rouge">#callExistingCode</code> function.</p>

<h1 id="example">Example</h1>
<p>Say the <code class="language-plaintext highlighter-rouge">ExistingService</code> replies with an HTML, and the goal is to extract some part of it, say a <code class="language-plaintext highlighter-rouge">&lt;div&gt;</code>
with a given <code class="language-plaintext highlighter-rouge">id</code>.
Or an <code class="language-plaintext highlighter-rouge">ExistingService</code> may be returning a ZIP archive, and the goal can be to add a file in it.</p>

<p>There are many similar cases, where an <code class="language-plaintext highlighter-rouge">OutputStream</code> post processing can be necessary.</p>

<h1 id="problem-statement">Problem Statement</h1>
<p>Suppose the <code class="language-plaintext highlighter-rouge">ExistingService</code> writes output in the following format:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">(&lt;SIZE&gt;&lt;CHANNEL-ID&gt;&lt;DATA&gt;)*</code></pre></figure>

<p>Where <code class="language-plaintext highlighter-rouge">&lt;SIZE&gt;</code> is 4 bytes length message. <code class="language-plaintext highlighter-rouge">&lt;CHANNEL-ID&gt;</code> is a one-byte message. <code class="language-plaintext highlighter-rouge">&lt;DATA&gt;</code> is a 
byte sequence of given size.</p>

<p>The such or similar format is widely used to send several streams within one connection. For example,
it is used in <a href="https://www.ietf.org/rfc/rfc4251.txt">SSH-2</a>, <a href="https://tools.ietf.org/html/rfc7540">HTTP/2</a>
or <a href="https://github.com/git/git/blob/master/Documentation/technical/pack-protocol.txt">Git</a>.</p>

<p>Out goal is to include additional messages to the stream on the fly, while it is being generated 
by the call to an <code class="language-plaintext highlighter-rouge">ExistingService</code>.
We just need to implement the method:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nc">OutputStream</span> <span class="nf">weaveStream</span><span class="o">(</span><span class="nc">OutputStream</span> <span class="n">target</span><span class="o">);</span></code></pre></figure>

<h1 id="a-trivial-java-implementation">A Trivial Java Implementation</h1>

<p>In Java we have <code class="language-plaintext highlighter-rouge">PipedOutputStream</code>/<code class="language-plaintext highlighter-rouge">PipedInputStream</code> classes that may turn an OutputStream 
into an <code class="language-plaintext highlighter-rouge">InputStream</code>. Next, the processing can be done easily.</p>

<p>We have a thread, that reads data from an <code class="language-plaintext highlighter-rouge">InputStream</code>, e.g.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nc">OutputStream</span> <span class="nf">weaveStream</span><span class="o">(</span><span class="nc">OutputStream</span> <span class="n">target</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
  <span class="nc">PipedOutputStream</span> <span class="n">pos</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PipeOutputStream</span><span class="o">();</span>
  <span class="nc">PipedInputStream</span> <span class="n">pis</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PipedInputStream</span><span class="o">(</span><span class="n">pos</span><span class="o">);</span>
  
  <span class="n">runInThread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">weaveStream</span><span class="o">(</span><span class="n">pis</span><span class="o">,</span> <span class="n">target</span><span class="o">));</span>
  <span class="k">return</span> <span class="n">pos</span><span class="o">;</span>
<span class="o">}</span>

<span class="kt">void</span> <span class="nf">weaveStream</span><span class="o">(</span><span class="nc">InputStream</span> <span class="n">source</span><span class="o">,</span> <span class="nc">OutputStream</span> <span class="n">target</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">//omitted error processing here</span>
      <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">extractSize</span><span class="o">(</span><span class="n">source</span><span class="o">.</span><span class="na">read</span><span class="o">(),</span> <span class="n">source</span><span class="o">.</span><span class="na">read</span><span class="o">(),</span> <span class="n">source</span><span class="o">.</span><span class="na">read</span><span class="o">(),</span> <span class="n">source</span><span class="o">.</span><span class="na">read</span><span class="o">());</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">isLastBlock</span><span class="o">(</span><span class="n">size</span><span class="o">))</span> <span class="k">return</span><span class="o">;</span>

      <span class="kt">int</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">extractChannelId</span><span class="o">(</span><span class="n">source</span><span class="o">.</span><span class="na">read</span><span class="o">());</span>

      <span class="n">writeHeader</span><span class="o">(</span><span class="n">target</span><span class="o">,</span> <span class="n">size</span><span class="o">,</span> <span class="n">ch</span><span class="o">);</span>
      <span class="n">copyBlock</span><span class="o">(</span><span class="n">target</span><span class="o">,</span> <span class="n">size</span><span class="o">,</span> <span class="n">source</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>The cost here is high. We need an additional thread to implement that. Additionally, 
the whole data is copied to a buffer from which a <code class="language-plaintext highlighter-rouge">PipedInputStream</code> is reading. 
Finally, piped streams implementation uses a level of synchronization to wait for 
next data portion to arrive. That can be problematic for some loads.</p>

<h1 id="a-smart-java-implementation">A Smart Java Implementation</h1>

<p>One can do a smarter implementation. Directly implement the <code class="language-plaintext highlighter-rouge">OutputStream</code> and do the processing
and patching the output in there.</p>

<p>What we do here is to add a state to our <code class="language-plaintext highlighter-rouge">OutputStream</code> implementation. Each call to <code class="language-plaintext highlighter-rouge">write</code> method
yields an update of the state.</p>

<p>A <em>State Machine</em>. That is what the code from here is about. It is up to programmer if to have a state
explicitly or not. Think about maintainability of such code first.</p>

<p>The implementation here can be quite complex. As an example, I show a byte-by-byte 
processing. In real cases, it can be way more efficient to implement 
<code class="language-plaintext highlighter-rouge">write(byte[], int, int)</code> method.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nc">OutputStream</span> <span class="nf">weaveStream</span><span class="o">(</span><span class="nc">OutputStream</span> <span class="n">target</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nf">OutputStream</span><span class="o">()</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="kt">int</span> <span class="n">b</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">isReadingSize</span><span class="o">())</span> <span class="o">{</span>
       <span class="n">readMoreSize</span><span class="o">(</span><span class="n">b</span><span class="o">);</span> 
      <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">isReadingChannelId</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">readMoreChannelId</span><span class="o">(</span><span class="n">b</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">isProcessingData</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">processModeData</span><span class="o">(</span><span class="n">b</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IOException</span><span class="o">(</span><span class="s">"Unexpected state"</span><span class="o">);</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">};</span>
<span class="o">}</span></code></pre></figure>

<p>The benefit here is that we no longer need an extra thread to pipe the output as input. Sill, code 
is getting more complex.</p>

<h1 id="a-coroutine-state-machine">A Coroutine State Machine</h1>

<p>In Kotlin 1.1 we have <a href="http://kotlinlang.org/docs/reference/coroutines.html">coroutines</a>. The alternative way 
to implement a state machine with the help of compiler, with way more readable, linear-looking code.</p>

<p>First, we need to declare an interface with <code class="language-plaintext highlighter-rouge">suspend</code> functions, e.g.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">interface</span> <span class="nc">DataReader</span> <span class="o">{</span>
  <span class="n">suspend</span> <span class="n">fun</span> <span class="nf">read</span><span class="o">()</span> <span class="o">:</span> <span class="nc">Int</span>
  
  <span class="n">suspend</span> <span class="n">fun</span> <span class="nf">pipe</span><span class="o">(</span><span class="n">sz</span> <span class="o">:</span> <span class="nc">Int</span><span class="o">,</span> <span class="nl">to:</span> <span class="nc">OutputStream</span><span class="o">)</span>
<span class="o">}</span></code></pre></figure>

<p>Also, we need an implementation of the <code class="language-plaintext highlighter-rouge">OutputStream</code> that allows us to use the <code class="language-plaintext highlighter-rouge">DataReader</code>. That is 
the function <code class="language-plaintext highlighter-rouge">inverseRead</code>. We’ll turn back to the implementation a bit later.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">fun</span> <span class="nf">inverseRead</span><span class="o">(</span><span class="nl">reader:</span> <span class="n">suspend</span> <span class="nc">DataReader</span><span class="o">.()</span> <span class="o">-&gt;</span> <span class="nc">Unit</span><span class="o">)</span> <span class="o">:</span> <span class="nc">OutputStream</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span></code></pre></figure>

<p>Finally, we are able to implement the data processing:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">fun</span> <span class="nf">weaveStream</span><span class="o">(</span><span class="nl">target:</span> <span class="nc">OutputStream</span><span class="o">):</span> <span class="nc">OutputStream</span> <span class="o">{</span>
  <span class="k">return</span> <span class="n">inverseRead</span> <span class="o">{</span> <span class="n">reader</span> <span class="o">-&gt;</span>
    <span class="n">readStream</span><span class="o">(</span><span class="n">reader</span><span class="o">,</span> <span class="n">target</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="n">suspend</span> <span class="n">fun</span> <span class="nf">readStream</span><span class="o">(</span><span class="nl">source:</span> <span class="nc">DataReader</span><span class="o">,</span> <span class="nl">target:</span> <span class="nc">OutputStream</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">while</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">val</span> <span class="n">sz</span> <span class="o">=</span> <span class="n">extractSize</span><span class="o">(</span><span class="n">source</span><span class="o">.</span><span class="na">read</span><span class="o">(),</span> <span class="n">source</span><span class="o">.</span><span class="na">read</span><span class="o">(),</span> <span class="n">source</span><span class="o">.</span><span class="na">read</span><span class="o">(),</span> <span class="n">source</span><span class="o">.</span><span class="na">read</span><span class="o">())</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">isLastBlock</span><span class="o">(</span><span class="n">sz</span><span class="o">))</span> <span class="k">return</span>
    <span class="n">val</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">extractChannelId</span><span class="o">(</span><span class="n">source</span><span class="o">.</span><span class="na">read</span><span class="o">())</span>

    <span class="n">writeHeader</span><span class="o">(</span><span class="n">target</span><span class="o">,</span> <span class="n">sz</span><span class="o">,</span> <span class="n">ch</span><span class="o">)</span>
    <span class="n">source</span><span class="o">.</span><span class="na">pipe</span><span class="o">(</span><span class="n">sz</span><span class="o">,</span> <span class="n">target</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>Check the code above. It is quite similar to what we had in <em>A Trivial Java Implementation</em>. The difference
is huge. Every call to <code class="language-plaintext highlighter-rouge">suspend</code> function pauses the execution of a method, so the execution turns to
the <code class="language-plaintext highlighter-rouge">write</code> method implementation of <code class="language-plaintext highlighter-rouge">OutputStream</code> in <code class="language-plaintext highlighter-rouge">inverseRead</code>. We are able now to write
a linear looking code, that is executed in a piece-by-piece manner.</p>

<h1 id="implementation-of-the-coroutine">Implementation of the Coroutine</h1>

<p>The only missing part is the <code class="language-plaintext highlighter-rouge">inverseRead</code>. We follow the <a href="http://kotlinlang.org/docs/reference/coroutines.html">coroutines documentation</a>
to implement that. Great is there are many examples too.</p>

<p>We implement <code class="language-plaintext highlighter-rouge">DataReader#read</code> and <code class="language-plaintext highlighter-rouge">DataReader#pipe</code> functions to suspend execution until there is enough data
send to <code class="language-plaintext highlighter-rouge">OutputStream#write</code> method. We have the following state object for that:</p>

<figure class="highlight"><pre><code class="language-kotlin" data-lang="kotlin"><span class="kd">class</span> <span class="nc">DataReaderState</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="py">readByteContinuation</span> <span class="p">=</span> <span class="k">null</span> <span class="k">as</span> <span class="nc">Continuation</span><span class="p">&lt;</span><span class="nc">Int</span><span class="p">&gt;?</span>

  <span class="kd">var</span> <span class="py">pipeContinuation</span> <span class="p">=</span> <span class="k">null</span> <span class="k">as</span> <span class="nc">Continuation</span><span class="p">&lt;</span><span class="nc">Unit</span><span class="p">&gt;?</span>
  <span class="kd">var</span> <span class="py">pipeTarget</span> <span class="p">=</span> <span class="k">null</span> <span class="k">as</span> <span class="nc">OutputStream</span><span class="p">?</span>
  <span class="kd">var</span> <span class="py">pipeSizeToWrite</span> <span class="p">=</span> <span class="mi">0</span>
<span class="p">}</span></code></pre></figure>

<p>Next, we are able to implement the <code class="language-plaintext highlighter-rouge">DataReader</code> interface in the following way:</p>

<figure class="highlight"><pre><code class="language-kotlin" data-lang="kotlin"><span class="kd">class</span> <span class="nc">DataReaderImpl</span><span class="p">(</span><span class="kd">val</span> <span class="py">state</span><span class="p">:</span> <span class="nc">DataReaderState</span><span class="p">)</span> <span class="p">:</span> <span class="nc">DataReader</span> <span class="p">{</span>
  <span class="k">suspend</span> <span class="k">override</span> <span class="k">fun</span> <span class="nf">pipe</span><span class="p">(</span><span class="n">sz</span><span class="p">:</span> <span class="nc">Int</span><span class="p">,</span> <span class="n">to</span><span class="p">:</span> <span class="nc">OutputStream</span><span class="p">):</span> <span class="nc">Unit</span> <span class="p">=</span> <span class="n">suspendCoroutine</span><span class="p">&lt;</span><span class="nc">Unit</span><span class="p">&gt;</span> <span class="p">{</span> <span class="n">c</span> <span class="p">-&gt;</span>
    <span class="n">state</span><span class="p">.</span><span class="n">pipeContinuation</span> <span class="p">=</span> <span class="n">c</span>
    <span class="n">state</span><span class="p">.</span><span class="n">pipeSizeToWrite</span> <span class="p">=</span> <span class="n">sz</span>
    <span class="n">state</span><span class="p">.</span><span class="n">pipeTarget</span> <span class="p">=</span> <span class="n">to</span>
  <span class="p">}</span>

  <span class="k">suspend</span> <span class="k">override</span> <span class="k">fun</span> <span class="nf">read</span><span class="p">():</span> <span class="nc">Int</span> <span class="p">=</span> <span class="nf">suspendCoroutine</span> <span class="p">{</span> <span class="n">c</span> <span class="p">-&gt;</span>
    <span class="n">state</span><span class="p">.</span><span class="n">readByteContinuation</span> <span class="p">=</span> <span class="n">c</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>All we have here is a call to the specific <code class="language-plaintext highlighter-rouge">suspendCoroutine</code> function in Kotlin, which does the suspend. I decided
to omit for simplicity a defensive asserts that one may have in both <code class="language-plaintext highlighter-rouge">pipe</code> and <code class="language-plaintext highlighter-rouge">read</code> function implementation.</p>

<p>The <code class="language-plaintext highlighter-rouge">OutputStream</code> implementation in the example is executing next suspended function in a loop. The current
implementation does not check the state at the end of data too. The straightforward implementation is as follows:</p>

<figure class="highlight"><pre><code class="language-kotlin" data-lang="kotlin"><span class="kd">class</span> <span class="nc">DataReaderOutputStreamImpl</span><span class="p">(</span><span class="kd">val</span> <span class="py">state</span><span class="p">:</span> <span class="nc">DataReaderState</span><span class="p">)</span> <span class="p">:</span> <span class="nc">OutputStream</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">override</span> <span class="k">fun</span> <span class="nf">write</span><span class="p">(</span><span class="n">b</span><span class="p">:</span> <span class="nc">Int</span><span class="p">)</span> <span class="p">=</span> <span class="nf">write</span><span class="p">(</span><span class="nf">byteArrayOf</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="nf">toByte</span><span class="p">()))</span>

  <span class="k">override</span> <span class="k">tailrec</span> <span class="k">fun</span> <span class="nf">write</span><span class="p">(</span><span class="n">b</span><span class="p">:</span> <span class="nc">ByteArray</span><span class="p">,</span> <span class="n">off</span><span class="p">:</span> <span class="nc">Int</span><span class="p">,</span> <span class="n">len</span><span class="p">:</span> <span class="nc">Int</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="p">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span>

    <span class="kd">val</span> <span class="py">readOneByte</span> <span class="p">=</span> <span class="n">state</span><span class="p">.</span><span class="n">readByteContinuation</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">readOneByte</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">readOneByte</span><span class="p">.</span><span class="nf">resume</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">off</span><span class="p">].</span><span class="nf">toInt</span><span class="p">())</span>
      <span class="k">return</span> <span class="nf">write</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">off</span><span class="p">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">len-1</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">val</span> <span class="py">pipe</span> <span class="p">=</span> <span class="n">state</span><span class="p">.</span><span class="n">pipeContinuation</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pipe</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">val</span> <span class="py">toPipe</span> <span class="p">=</span> <span class="nc">Math</span><span class="p">.</span><span class="nf">min</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">state</span><span class="p">.</span><span class="n">pipeSizeToWrite</span><span class="p">)</span>
      <span class="n">state</span><span class="p">.</span><span class="n">pipeTarget</span><span class="o">!!</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">toPipe</span><span class="p">)</span>
      <span class="k">return</span> <span class="nf">write</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">off</span><span class="p">+</span><span class="n">toPipe</span><span class="p">,</span> <span class="n">len</span> <span class="p">-</span> <span class="n">toPipe</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">throw</span> <span class="nc">Error</span><span class="p">(</span><span class="s">"Illegal state"</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>At that moment we are ready to implement the <code class="language-plaintext highlighter-rouge">inverseRead</code> function.</p>

<figure class="highlight"><pre><code class="language-kotlin" data-lang="kotlin"><span class="k">fun</span> <span class="nf">inverseRead</span><span class="p">(</span><span class="n">reader</span><span class="p">:</span> <span class="k">suspend</span> <span class="p">(</span><span class="nc">DataReader</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nc">Unit</span><span class="p">)</span> <span class="p">:</span> <span class="nc">OutputStream</span> <span class="p">{</span>
  <span class="kd">val</span> <span class="py">state</span> <span class="p">=</span> <span class="nc">DataReaderState</span><span class="p">()</span>
  <span class="kd">val</span> <span class="py">outputStream</span> <span class="p">=</span> <span class="nc">DataReaderOutputStreamImpl</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
  <span class="kd">val</span> <span class="py">dataReader</span> <span class="p">=</span> <span class="nc">DataReaderImpl</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
  <span class="kd">val</span> <span class="py">continuation</span> <span class="p">=</span> <span class="nc">DataReaderContinuation</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

  <span class="n">reader</span><span class="p">.</span><span class="nf">createCoroutine</span><span class="p">(</span><span class="n">dataReader</span><span class="p">,</span><span class="n">continuation</span><span class="p">).</span><span class="nf">resume</span><span class="p">(</span><span class="nc">Unit</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">outputStream</span>
<span class="p">}</span></code></pre></figure>

<h1 id="coroutine-vs-state-machine">Coroutine vs State Machine</h1>

<p>It turned out we still needed to implement a state machine (via <code class="language-plaintext highlighter-rouge">DataReaderState</code> class). It 
was necessary to add a state for each <code class="language-plaintext highlighter-rouge">suspend</code> function of <code class="language-plaintext highlighter-rouge">DataReader</code> interface. That was 
the code we need to write as building block (and there 
are <a href="https://github.com/Kotlin/kotlinx.coroutines">amazing libraries</a> for most 
of the cases)</p>

<p>The good part is that the rest part of the code, where we do the actual data decoding (the <code class="language-plaintext highlighter-rouge">readStream</code> function)
now free from an explicit state machine style programming. One can have code written as easy
as possible. It’s easier to understand and to check. And, for example, we may use loops, try-catches 
and any other code constructs we like using for ordinary programs.</p>

<p>In other words, with the help of Kotlin suspend functions we may minimize the number of complex functions and
concentrate on the actual development.</p>

<p>For more information on coroutines power in Kotlin, you may refer to 
<a href="https://vimeo.com/221264980/b3ac7f9001">GeekOut Talk by Roman Elizarov</a>
or to <a href="http://kotlinlang.org/docs/reference/coroutines.html">the documentation</a></p>


        
      </div><!-- /.entry-content -->
    </div><!-- /.entry-wrapper -->
    <nav class="pagination" role="navigation">
      
        <a href="/blog/2017/06/07/a-post-every-two-weeks/" class="btn" title="A post per 2 weeks">Previous</a>
      
      
        <a href="/blog/2017/07/05/go-build/" class="btn" title="Building Go Project">Next</a>
      
    </nav><!-- /.pagination -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo" class="entry-wrapper">
    

<span>
  &copy; 2005—2026 Eugene Petrenko.
  <br />
  Unless otherwise noted, the content on the website is licensed under a
  <a href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a> license.
  <br />
  Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using
  the <a href="https://mademistakes.com/work/so-simple-jekyll-theme/" rel="nofollow">So Simple Theme</a>.
</span>
<div class="social-icons">
  <a href="https://x.com/jonnyzzz" title="Eugene Petrenko on X" target="_blank"><svg class="social-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg></a>
  <a href="https://linkedin.com/in/jonnyzzz" title="Eugene Petrenko on LinkedIn" target="_blank"><svg class="social-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 3a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14m-.5 15.5v-5.3a3.26 3.26 0 0 0-3.26-3.26c-.85 0-1.84.52-2.32 1.3v-1.11h-2.79v8.37h2.79v-4.93c0-.77.62-1.4 1.39-1.4a1.4 1.4 0 0 1 1.4 1.4v4.93h2.79M6.88 8.56a1.68 1.68 0 0 0 1.68-1.68c0-.93-.75-1.69-1.68-1.69a1.69 1.69 0 0 0-1.69 1.69c0 .93.76 1.68 1.69 1.68m1.39 9.94v-8.37H5.5v8.37h2.77z"/></svg></a>
  <a href="https://github.com/jonnyzzz" title="Eugene Petrenko on Github" target="_blank"><svg class="social-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33.85 0 1.71.11 2.5.33 1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2z"/></svg></a>
  <a href="/feed.xml" title="Atom/RSS feed"><svg class="social-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6.18 15.64a2.18 2.18 0 0 1 2.18 2.18C8.36 19 7.38 20 6.18 20C5 20 4 19 4 17.82a2.18 2.18 0 0 1 2.18-2.18M4 4.44A15.56 15.56 0 0 1 19.56 20h-2.83A12.73 12.73 0 0 0 4 7.27V4.44m0 5.66a9.9 9.9 0 0 1 9.9 9.9h-2.83A7.07 7.07 0 0 0 4 12.93V10.1z"/></svg></a>
</div><!-- /.social-icons -->

  </footer>
</div><!-- /.footer-wrapper -->

<script>
  // Open external links in new tab
  Array.from(document.links).forEach(link => {
    // For development: 0.0.0.0, localhost, 127.0.0.1 are all local
    const localHosts = ['localhost', '127.0.0.1', '0.0.0.0'];
    const linkIsLocal = localHosts.includes(link.hostname);
    const pageIsLocal = localHosts.includes(window.location.hostname);

    // Internal if: both are local dev hosts, or hostnames match exactly
    const isInternal = (linkIsLocal && pageIsLocal) ||
                       (link.hostname === window.location.hostname);

    if (!isInternal) {
      link.target = '_blank';
    }
  });
</script>


<!-- Google Analytics (gtag.js) -->
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('consent', 'default', {
    'ad_storage': 'denied',
    'ad_user_data': 'denied',
    'ad_personalization': 'denied',
    'analytics_storage': 'denied'
  });
</script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-BXXDX0ERFP"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-BXXDX0ERFP');
</script>
<!-- End Google Analytics -->




<!--SYNTAX HIGHLIGHTER - Lazy loads PrismJS only when code blocks are present-->
<script>
(function() {
  // Check if page has any code blocks that need highlighting
  if (!document.querySelector('pre code, code[class*="language-"]')) return;

  // Load CSS
  var cssFiles = [
    'https://cdn.jsdelivr.net/npm/prismjs@1.30.0/themes/prism.min.css',
    'https://cdn.jsdelivr.net/npm/prismjs@1.30.0/plugins/line-numbers/prism-line-numbers.min.css',
    'https://cdn.jsdelivr.net/npm/prismjs@1.30.0/plugins/toolbar/prism-toolbar.min.css'
  ];
  cssFiles.forEach(function(href) {
    var link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = href;
    document.head.appendChild(link);
  });

  // Load JS in sequence (core first, then plugins)
  var jsFiles = [
    'https://cdn.jsdelivr.net/npm/prismjs@1.30.0/components/prism-core.min.js',
    'https://cdn.jsdelivr.net/npm/prismjs@1.30.0/plugins/autoloader/prism-autoloader.min.js',
    'https://cdn.jsdelivr.net/npm/prismjs@1.30.0/plugins/line-numbers/prism-line-numbers.min.js',
    'https://cdn.jsdelivr.net/npm/prismjs@1.30.0/plugins/toolbar/prism-toolbar.min.js',
    'https://cdn.jsdelivr.net/npm/prismjs@1.30.0/plugins/show-language/prism-show-language.min.js',
    'https://cdn.jsdelivr.net/npm/prismjs@1.30.0/plugins/normalize-whitespace/prism-normalize-whitespace.min.js'
  ];

  function loadScript(index) {
    if (index >= jsFiles.length) {
      // All scripts loaded, highlight code
      if (window.Prism) Prism.highlightAll();
      return;
    }
    var script = document.createElement('script');
    script.src = jsFiles[index];
    script.onload = function() { loadScript(index + 1); };
    document.head.appendChild(script);
  }
  loadScript(0);
})();
</script>



</body>
</html>
