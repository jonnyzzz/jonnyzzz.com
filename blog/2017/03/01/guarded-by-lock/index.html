<!doctype html>
<html class="no-js" lang="en">
<head>
<meta charset="utf-8" />
<title>Guard access by lock in Kotlin &#8211; Eugene Petrenko</title>
<meta name="description" content="GuardedByLock a simple helper to make sure variable is only accessed with lock
"/>
<meta name="keywords" content="jonnyzzz, Евгений Петренко, Eugene Petrenko, kotlin, kotlin-bytecode, jvm, tip" />


<!-- Twitter Cards -->
<meta name="twitter:title" content="Guard access by lock in Kotlin -- Eugene Petrenko" />
<meta name="twitter:description" content="GuardedByLock a simple helper to make sure variable is only accessed with lock
" />
<meta name="twitter:site" content="@jonnyzzz" />
<meta name="twitter:creator" content="@jonnyzzz" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="https://jonnyzzz.com/images/me.jpg" />

<!-- Open Graph -->

<meta property="og:type" content="article" />
<meta property="og:image" content="https://jonnyzzz.com/images/me.jpg" />
<meta property="og:title" content="Guard access by lock in Kotlin -- Eugene Petrenko" />
<meta property="og:description" content="GuardedByLock a simple helper to make sure variable is only accessed with lock
" />
<meta property="og:url" content="https://jonnyzzz.com/blog/2017/03/01/guarded-by-lock/" />
<meta property="og:site_name" content="Eugene Petrenko" />

<meta property="article:tag" content="jonnyzzz" />

<meta property="article:tag" content="Евгений Петренко" />

<meta property="article:tag" content="Eugene Petrenko" />


<meta property="article:tag" content="kotlin" />

<meta property="article:tag" content="kotlin-bytecode" />

<meta property="article:tag" content="jvm" />

<meta property="article:tag" content="tip" />



<!-- Webmaster Tools verfication -->
<meta name="google-site-verification" content="MJZCyfst2Tx4KyxbOIQu1fZyOSwA_JkQu73zJcfsl2g" />




<link rel="canonical" href="https://jonnyzzz.com/blog/2017/03/01/guarded-by-lock/" />
<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="ATOM Feed" />

<meta name="HandheldFriendly" content="True" />
<meta name="MobileOptimized" content="320" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css" />

<link rel="apple-touch-icon" sizes="57x57" href="/images/apple-icon-57x57.png" />
<link rel="apple-touch-icon" sizes="60x60" href="/images/apple-icon-60x60.png" />
<link rel="apple-touch-icon" sizes="72x72" href="/images/apple-icon-72x72.png" />
<link rel="apple-touch-icon" sizes="76x76" href="/images/apple-icon-76x76.png" />
<link rel="apple-touch-icon" sizes="114x114" href="/images/apple-icon-114x114.png" />
<link rel="apple-touch-icon" sizes="120x120" href="/images/apple-icon-120x120.png" />
<link rel="apple-touch-icon" sizes="144x144" href="/images/apple-icon-144x144.png" />
<link rel="apple-touch-icon" sizes="152x152" href="/images/apple-icon-152x152.png" />
<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-icon-180x180.png" />
<link rel="icon" type="image/png" sizes="192x192"  href="/images/android-icon-192x192.png" />
<link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png" />
<link rel="icon" type="image/png" sizes="96x96" href="/images/favicon-96x96.png" />
<link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png" />
<link rel="manifest" href="/images/manifest.json" />
<meta name="msapplication-TileColor" content="#ffffff" />
<meta name="msapplication-TileImage" content="/images/ms-icon-144x144.png" />
<meta name="theme-color" content="#ffffff" />

</head>

<body id="post">

<div class="navigation-wrapper">
	<nav role="navigation" id="site-nav">
	    <ul>
      
		    <li><a href="/" >Home</a></li>
		  
		    <li><a href="/about/" >About</a></li>
		  
		    <li><a href="/blog/" >Blog</a></li>
		  
		    <li><a href="/projects/" >Projects</a></li>
		  
		    <li><a href="/talks/" >Talks</a></li>
		  
		    <li><a href="/tags/" >Tags</a></li>
		  
	    </ul>
	</nav>
</div><!-- /.navigation-wrapper -->

<header class="masthead">
	<div class="wrap">
      
      <h1 class="site-title"><a href="/">Eugene Petrenko</a></h1>
		<h2 class="site-description" itemprop="description">Founding Engineering Leader | Agentic AI DevTools & Experience</h2>
	</div>
</header><!-- /.masthead -->


<div id="main" role="main">
  <article class="hentry">
    
    <div class="entry-wrapper">
      <header class="entry-header">
        <ul class="entry-tags">
          <li><a href="/tags/#kotlin" title="Pages tagged kotlin">kotlin</a></li><li><a href="/tags/#kotlin-bytecode" title="Pages tagged kotlin-bytecode">kotlin-bytecode</a></li><li><a href="/tags/#jvm" title="Pages tagged jvm">jvm</a></li><li><a href="/tags/#tip" title="Pages tagged tip">tip</a></li>
        </ul>
        
          <h1 class="entry-title">Guard access by lock in Kotlin</h1>
        
      </header>
      <footer class="entry-meta">
        
        
          <img src="/images/me.jpg" class="bio-photo" alt="Eugene Petrenko bio photo"></a>
        
        <span class="author vcard">By <span class="fn">Eugene Petrenko</span></span>
        <span class="entry-date date published"><time datetime="2017-03-01T00:00:00+00:00">March 01, 2017</time></span>
        
        
        <span class="social-share-x">
  <a href="https://x.com/intent/tweet?hashtags=kotlin,kotlin-bytecode,jvm,tip&amp;text=Guard%20access%20by%20lock%20in%20Kotlin&amp;url=https://jonnyzzz.com/blog/2017/03/01/guarded-by-lock/&amp;via=jonnyzzz" title="Share on X" itemprop="X" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="14" height="14" style="vertical-align: middle; fill: currentColor;"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg> Post</a>
</span>
<span class="social-share-facebook">
  <a href="https://www.facebook.com/sharer/sharer.php?u=https://jonnyzzz.com/blog/2017/03/01/guarded-by-lock/" title="Share on Facebook" itemprop="Facebook" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="14" height="14" style="vertical-align: middle; fill: currentColor;"><path d="M22 12c0-5.52-4.48-10-10-10S2 6.48 2 12c0 4.84 3.44 8.87 8 9.8V15H8v-3h2V9.5C10 7.57 11.57 6 13.5 6H16v3h-2c-.55 0-1 .45-1 1v2h3v3h-3v6.95c5.05-.5 9-4.76 9-9.95z"/></svg> Like</a>
</span>
<!-- /.social-share -->

      </footer>
      <div class="entry-content">
        <p>GuardedByLock a simple helper to make sure variable is only accessed with lock</p>

<p>A topic of ownership is better covered in <a href="https://www.rust-lang.org">Rust Language</a>. Still, such problems
are not solved well enough in the JVM world. Let’s consider a trivial shared state access example</p>

<figure class="highlight"><pre><code class="language-kotlin" data-lang="kotlin">  <span class="k">private</span> <span class="kd">val</span> <span class="py">lock</span> <span class="p">=</span> <span class="nc">ReentrantLock</span><span class="p">()</span>
  <span class="k">private</span> <span class="kd">var</span> <span class="py">value</span> <span class="p">=</span> <span class="mi">42</span>
  
  <span class="k">fun</span> <span class="nf">method</span><span class="p">(</span><span class="n">v</span> <span class="p">:</span> <span class="nc">Int</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">lock</span><span class="p">.</span><span class="nf">lock</span><span class="p">()</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="nf">updateStateWithNewValue</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
      <span class="n">lock</span><span class="p">.</span><span class="nf">unlock</span><span class="p">()</span>
    <span class="p">}</span>
  <span class="p">}</span></code></pre></figure>

<p>We all know the best state is no state. And we tend to decouple tricky things. But of course, there are 
some places in programs where one finally needs to deal with a state. In reality, it can easily be a 
complicated state with several different locks in one object.</p>

<p>The common problem here is to make sure fields are accessed with correct locks taken. It is tricky 
to ensure in Java. It is double tricky to ensure future changes will not break the contract.</p>

<p><a href="https://jcp.org/en/jsr/detail?id=305">JSR-305</a> and <a href="http://jcip.net/annotations/doc/net/jcip/annotations/GuardedBy.html">GuardedBy</a>
annotations are created to make a binding between state and guards. But those are only to 
help an IDE to be smarter, those annotations will not turn a mistake into a compilation error.</p>

<p>I’m looking the way to make a compiler to ensure the access is correct.</p>

<h1 id="java-style-solution">Java Style solution</h1>

<p>In Java, this can be done in the following way. Create a function <code class="language-plaintext highlighter-rouge">runWithLock</code> and make this function accept
an interface with a method like <code class="language-plaintext highlighter-rouge">run(State s)</code>. If necessary a generics can be added to simplify usages.</p>

<p>To implement that one need to extract a state object (which I call <code class="language-plaintext highlighter-rouge">State</code>). Happy Java 1.8 users may benefit
from Lambda syntax. But the approach itself requires a creation of tiny objects (for lambdas, in most cases) on every call.
Such overhead is small, but one may not like it.</p>

<p>An example call code would look like</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java">  <span class="kd">class</span> <span class="nc">State</span> <span class="o">{</span> <span class="cm">/*...*/</span> <span class="o">}</span>
  <span class="kt">void</span> <span class="nf">runWithLock</span><span class="o">(</span><span class="nc">Consumer</span><span class="o">&lt;</span><span class="nc">State</span><span class="o">&gt;</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span> <span class="cm">/*...*/</span> <span class="o">}</span>


  <span class="kt">void</span> <span class="nf">main</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">runWithLock</span><span class="o">((</span><span class="n">s</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span> <span class="n">s</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="mi">5</span><span class="o">;</span>  <span class="o">});</span>
  <span class="o">}</span></code></pre></figure>

<p>Let’s try avoid lambdas overhead and to yield a bit better syntax.</p>

<h1 id="kotlin-style-solution">Kotlin Style solution</h1>

<p>Consider the following implementation in Kotlin</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">class</span> <span class="nc">GuardedByLock</span><span class="o">&lt;</span><span class="n">out</span> <span class="nl">L:</span> <span class="nc">Lock</span><span class="o">,</span> <span class="n">out</span> <span class="no">T</span><span class="o">&gt;(</span>
        <span class="n">val</span> <span class="nl">lock:</span> <span class="no">L</span><span class="o">,</span>
        <span class="n">val</span> <span class="nl">state:</span> <span class="no">T</span>
<span class="o">)</span> <span class="o">{</span>
  <span class="n">inline</span> <span class="n">fun</span> <span class="o">&lt;</span><span class="no">Y</span><span class="o">&gt;</span> <span class="nf">runWithLock</span><span class="o">(</span><span class="nl">action:</span> <span class="no">T</span><span class="o">.()</span> <span class="o">-&gt;</span> <span class="no">Y</span><span class="o">)</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="na">withLock</span> <span class="o">{</span> <span class="n">state</span><span class="o">.</span><span class="na">action</span><span class="o">()</span> <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>The usage is as follows:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java">   <span class="kd">class</span> <span class="nf">State</span><span class="o">(</span><span class="kt">var</span> <span class="nl">value:</span> <span class="nc">Int</span> <span class="o">=</span> <span class="mi">42</span><span class="o">)</span>
   <span class="n">val</span> <span class="n">lock</span> <span class="o">=</span> <span class="nc">GuardedByLock</span><span class="o">(</span><span class="nc">ReentrantLock</span><span class="o">(),</span> <span class="nc">State</span><span class="o">())</span>
   
   <span class="n">fun</span> <span class="nf">main</span><span class="o">()</span> <span class="o">{</span>
     <span class="n">lock</span><span class="o">.</span><span class="na">runWithLock</span> <span class="o">{</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">}</span>
   <span class="o">}</span>  </code></pre></figure>

<p>Let’s take a look closer to the <code class="language-plaintext highlighter-rouge">runWithLock</code> call. Here <code class="language-plaintext highlighter-rouge">{</code> and <code class="language-plaintext highlighter-rouge">}</code> are used to 
declare an <a href="https://kotlinlang.org/docs/reference/lambdas.html">anonymous extension function</a> 
of type <code class="language-plaintext highlighter-rouge">State.() -&gt; Y</code> (<code class="language-plaintext highlighter-rouge">Y</code> is a generic type parameter).
Extension function means that in the body of the function we have <code class="language-plaintext highlighter-rouge">this</code> keyword pointing to <code class="language-plaintext highlighter-rouge">State</code> object
instance. And the part <code class="language-plaintext highlighter-rouge">value = 5</code> means we assign the value to <code class="language-plaintext highlighter-rouge">State</code> object property/field.</p>

<p>The <code class="language-plaintext highlighter-rouge">inline</code> keyword here makes Kotlin compiler to 
<a href="https://kotlinlang.org/docs/reference/inline-functions.html">inline</a>
the function body to avoid creating an anonymous function in the compiled code. You may refer to 
<a href="/blog/2017/02/15/catchall/">the previous post</a> for bytecode listing of inline function calls.</p>

<p>With this approach, we avoid creation anonymous classes for Lambdas from one hand. From the other hand,
the Kotlin compiler is in charge of checking a <code class="language-plaintext highlighter-rouge">State</code> object instance in only accessible after necessary
locks are held.</p>

<p>Finally, the bytecode for the <code class="language-plaintext highlighter-rouge">main</code> function is the following. Note. I use IntelliJ IDEA 2017.1 EAP with Kotlin 
1.0.6 plugin. The generated bytecode may change with a future version of tools.</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">  // access flags 0x19
  public final static main()V
    TRYCATCHBLOCK L0 L1 L2 null
    TRYCATCHBLOCK L2 L3 L2 null
   L4
    LINENUMBER 27 L4
    GETSTATIC GlKt.lock : LGuardedByLock;
    ASTORE 0
    NOP
   L5
    LINENUMBER 30 L5
    ALOAD 0
    INVOKEVIRTUAL GuardedByLock.getLock ()Ljava/util/concurrent/locks/Lock;
    ASTORE 1
    NOP
   L6
    ALOAD 1
    INVOKEINTERFACE java/util/concurrent/locks/Lock.lock ()V
   L7
   L0
    NOP
   L8
    NOP
   L9
    LINENUMBER 30 L9
    ALOAD 0
    INVOKEVIRTUAL GuardedByLock.getState ()Ljava/lang/Object;
    CHECKCAST State
    ASTORE 2
    NOP
   L10
    LINENUMBER 27 L10
    ALOAD 2
    ICONST_5
    INVOKEVIRTUAL State.setValue (I)V
   L11
   L12
    GETSTATIC kotlin/Unit.INSTANCE : Lkotlin/Unit;
   L13
   L14
    LINENUMBER 30 L14
    ASTORE 2
   L1
    ALOAD 1
    INVOKEINTERFACE java/util/concurrent/locks/Lock.unlock ()V
    ALOAD 2
    GOTO L15
   L2
    ASTORE 2
   L3
    ALOAD 1
    INVOKEINTERFACE java/util/concurrent/locks/Lock.unlock ()V
    ALOAD 2
    ATHROW
   L15
    LINENUMBER 30 L15
   L16
    POP
   L17
    LINENUMBER 28 L17
    RETURN
   L18
    LOCALVARIABLE $receiver LState; L10 L12 2
    LOCALVARIABLE $i$a$1$runWithLock I L10 L12 3
    LOCALVARIABLE $i$a$1$withLock I L9 L14 4
    LOCALVARIABLE this_$iv LGuardedByLock; L5 L16 0
    LOCALVARIABLE $i$f$runWithLock I L5 L16 5
    MAXSTACK = 2
    MAXLOCALS = 6</code></pre></figure>

<p>As we see from the code, there is NO anonymous class creation.A call to <code class="language-plaintext highlighter-rouge">GuardedByLock#runWithLock</code> was inlined into 
the <code class="language-plaintext highlighter-rouge">main</code> function body, meaning less overhead (who’d measure it :).</p>

<h1 id="conclusion">Conclusion</h1>

<p>In the post, I presented <code class="language-plaintext highlighter-rouge">GuardedByLock</code> class in Kotlin. Using it in your project may help to 
correctly isolate state and make Kotlin complier checking all possible violations for you. 
The only cost is 2 additional object instances: one for <code class="language-plaintext highlighter-rouge">GuardedByLock</code>, and the other one for the <code class="language-plaintext highlighter-rouge">State</code>.</p>

        
      </div><!-- /.entry-content -->
    </div><!-- /.entry-wrapper -->
    <nav class="pagination" role="navigation">
      
        <a href="/blog/2017/02/15/catchall/" class="btn" title="Catching exceptions with less code in Kotlin">Previous</a>
      
      
        <a href="/blog/2017/03/15/switch-to-when/" class="btn" title="Switch to when">Next</a>
      
    </nav><!-- /.pagination -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo" class="entry-wrapper">
    

<span>
  &copy; 2005—2026 Eugene Petrenko.
  <br />
  Unless otherwise noted, the content on the website is licensed under a
  <a href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a> license.
  <br />
  Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using
  the <a href="https://mademistakes.com/work/so-simple-jekyll-theme/" rel="nofollow">So Simple Theme</a>.
</span>
<div class="social-icons">
  <a href="https://x.com/jonnyzzz" title="Eugene Petrenko on X" target="_blank"><svg class="social-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg></a>
  <a href="https://linkedin.com/in/jonnyzzz" title="Eugene Petrenko on LinkedIn" target="_blank"><svg class="social-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 3a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14m-.5 15.5v-5.3a3.26 3.26 0 0 0-3.26-3.26c-.85 0-1.84.52-2.32 1.3v-1.11h-2.79v8.37h2.79v-4.93c0-.77.62-1.4 1.39-1.4a1.4 1.4 0 0 1 1.4 1.4v4.93h2.79M6.88 8.56a1.68 1.68 0 0 0 1.68-1.68c0-.93-.75-1.69-1.68-1.69a1.69 1.69 0 0 0-1.69 1.69c0 .93.76 1.68 1.69 1.68m1.39 9.94v-8.37H5.5v8.37h2.77z"/></svg></a>
  <a href="https://github.com/jonnyzzz" title="Eugene Petrenko on Github" target="_blank"><svg class="social-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33.85 0 1.71.11 2.5.33 1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2z"/></svg></a>
  <a href="https://www.youtube.com/@jonnyzzz" title="Eugene Petrenko on YouTube" target="_blank"><svg class="social-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M23.498 6.186a2.959 2.959 0 0 0-2.079-2.08C19.58 3.6 12 3.6 12 3.6s-7.58 0-9.419.507a2.959 2.959 0 0 0-2.08 2.079C0 8.025 0 12 0 12s0 3.975.501 5.814a2.959 2.959 0 0 0 2.08 2.079C4.42 20.4 12 20.4 12 20.4s7.58 0 9.419-.507a2.959 2.959 0 0 0 2.08-2.079C24 15.975 24 12 24 12s0-3.975-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg></a>
  <a href="/feed.xml" title="Atom/RSS feed"><svg class="social-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6.18 15.64a2.18 2.18 0 0 1 2.18 2.18C8.36 19 7.38 20 6.18 20C5 20 4 19 4 17.82a2.18 2.18 0 0 1 2.18-2.18M4 4.44A15.56 15.56 0 0 1 19.56 20h-2.83A12.73 12.73 0 0 0 4 7.27V4.44m0 5.66a9.9 9.9 0 0 1 9.9 9.9h-2.83A7.07 7.07 0 0 0 4 12.93V10.1z"/></svg></a>
</div><!-- /.social-icons -->

  </footer>
</div><!-- /.footer-wrapper -->

<script>
  // Open external links in new tab
  Array.from(document.links).forEach(link => {
    // For development: 0.0.0.0, localhost, 127.0.0.1 are all local
    const localHosts = ['localhost', '127.0.0.1', '0.0.0.0'];
    const linkIsLocal = localHosts.includes(link.hostname);
    const pageIsLocal = localHosts.includes(window.location.hostname);

    // Internal if: both are local dev hosts, or hostnames match exactly
    const isInternal = (linkIsLocal && pageIsLocal) ||
                       (link.hostname === window.location.hostname);

    if (!isInternal) {
      link.target = '_blank';
    }
  });
</script>


<!-- Google Analytics (gtag.js) -->
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('consent', 'default', {
    'ad_storage': 'denied',
    'ad_user_data': 'denied',
    'ad_personalization': 'denied',
    'analytics_storage': 'denied'
  });
</script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-BXXDX0ERFP"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-BXXDX0ERFP');
</script>
<!-- End Google Analytics -->

<!-- PostHog Analytics -->
<script>
    !function(t,e){var o,n,p,r;e.__SV||(window.posthog && window.posthog.__loaded)||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.crossOrigin="anonymous",p.async=!0,p.src=s.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="init rs ls wi ns us ts ss capture calculateEventProperties vs register register_once register_for_session unregister unregister_for_session gs getFeatureFlag getFeatureFlagPayload getFeatureFlagResult isFeatureEnabled reloadFeatureFlags updateFlags updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures on onFeatureFlags onSurveysLoaded onSessionId getSurveys getActiveMatchingSurveys renderSurvey displaySurvey cancelPendingSurvey canRenderSurvey canRenderSurveyAsync identify setPersonProperties group resetGroups setPersonPropertiesForFlags resetPersonPropertiesForFlags setGroupPropertiesForFlags resetGroupPropertiesForFlags reset get_distinct_id getGroups get_session_id get_session_replay_url alias set_config startSessionRecording stopSessionRecording sessionRecordingStarted captureException startExceptionAutocapture stopExceptionAutocapture loadToolbar get_property getSessionProperty fs ds createPersonProfile setInternalOrTestUser ps Qr opt_in_capturing opt_out_capturing has_opted_in_capturing has_opted_out_capturing get_explicit_consent_status is_capturing clear_opt_in_out_capturing hs debug M cs getPageViewId captureTraceFeedback captureTraceMetric Kr".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
    posthog.init('phc_IPtbjwwy9YIGg0YNHNxYBePijvTvHEcKAjohah6obYW', {
        api_host: 'https://us.i.posthog.com',
        defaults: '2025-11-30',
        person_profiles: 'identified_only',
    })
</script>
<!-- End PostHog Analytics -->




<!--SYNTAX HIGHLIGHTER - Lazy loads PrismJS only when code blocks are present-->
<script>
(function() {
  // Check if page has any code blocks that need highlighting
  if (!document.querySelector('pre code, code[class*="language-"]')) return;

  // Load CSS
  var cssFiles = [
    'https://cdn.jsdelivr.net/npm/prismjs@1.30.0/themes/prism.min.css',
    'https://cdn.jsdelivr.net/npm/prismjs@1.30.0/plugins/line-numbers/prism-line-numbers.min.css',
    'https://cdn.jsdelivr.net/npm/prismjs@1.30.0/plugins/toolbar/prism-toolbar.min.css'
  ];
  cssFiles.forEach(function(href) {
    var link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = href;
    document.head.appendChild(link);
  });

  // Load JS in sequence (core first, then plugins)
  var jsFiles = [
    'https://cdn.jsdelivr.net/npm/prismjs@1.30.0/components/prism-core.min.js',
    'https://cdn.jsdelivr.net/npm/prismjs@1.30.0/plugins/autoloader/prism-autoloader.min.js',
    'https://cdn.jsdelivr.net/npm/prismjs@1.30.0/plugins/line-numbers/prism-line-numbers.min.js',
    'https://cdn.jsdelivr.net/npm/prismjs@1.30.0/plugins/toolbar/prism-toolbar.min.js',
    'https://cdn.jsdelivr.net/npm/prismjs@1.30.0/plugins/show-language/prism-show-language.min.js',
    'https://cdn.jsdelivr.net/npm/prismjs@1.30.0/plugins/normalize-whitespace/prism-normalize-whitespace.min.js'
  ];

  function loadScript(index) {
    if (index >= jsFiles.length) {
      // All scripts loaded, highlight code
      if (window.Prism) Prism.highlightAll();
      return;
    }
    var script = document.createElement('script');
    script.src = jsFiles[index];
    script.onload = function() { loadScript(index + 1); };
    document.head.appendChild(script);
  }
  loadScript(0);
})();
</script>



</body>
</html>
