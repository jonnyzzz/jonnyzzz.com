<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8" />
<title>A Bash Test Runner for TeamCity &#8211; Eugene Petrenko</title>
<meta name="description" content="An ad-hoc bash test runner with TeamCity support

"/>
<meta name="keywords" content="jonnyzzz, Евгений Петренко, Eugene Petrenko, teamcity, test, testrunner, shell, bash, ci, go, build" />


<!-- Twitter Cards -->
<meta name="twitter:title" content="A Bash Test Runner for TeamCity -- Eugene Petrenko" />
<meta name="twitter:description" content="An ad-hoc bash test runner with TeamCity support

" />
<meta name="twitter:site" content="@jonnyzzz" />
<meta name="twitter:creator" content="@jonnyzzz" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="https://jonnyzzz.com/images/me.jpg" />

<!-- Open Graph -->

<meta property="og:type" content="article" />
<meta property="og:image" content="https://jonnyzzz.com/images/me.jpg" />
<meta property="og:title" content="A Bash Test Runner for TeamCity -- Eugene Petrenko" />
<meta property="og:description" content="An ad-hoc bash test runner with TeamCity support

" />
<meta property="og:url" content="https://jonnyzzz.com/blog/2017/08/09/test-runner/" />
<meta property="og:site_name" content="Eugene Petrenko" />

<meta property="article:tag" content="jonnyzzz" />

<meta property="article:tag" content="Евгений Петренко" />

<meta property="article:tag" content="Eugene Petrenko" />


<meta property="article:tag" content="teamcity" />

<meta property="article:tag" content="test" />

<meta property="article:tag" content="testrunner" />

<meta property="article:tag" content="shell" />

<meta property="article:tag" content="bash" />

<meta property="article:tag" content="ci" />

<meta property="article:tag" content="go" />

<meta property="article:tag" content="build" />



<!-- Webmaster Tools verfication -->
<meta name="google-site-verification" content="MJZCyfst2Tx4KyxbOIQu1fZyOSwA_JkQu73zJcfsl2g" />




<link rel="canonical" href="https://jonnyzzz.com/blog/2017/08/09/test-runner/" />
<link href="https://feeds.feedburner.com/jonnyzzz" type="application/atom+xml" rel="alternate" title="ATOM Feed" />

<meta name="HandheldFriendly" content="True" />
<meta name="MobileOptimized" content="320" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css" />

<!-- Webfonts -->
<script src="https://use.edgefonts.net/source-sans-pro:n2,i2,n3,i3,n4,i4,n6,i6,n7,i7,n9,i9;source-code-pro:n4,n7;volkhov.js"></script>

<meta http-equiv="cleartype" content="on" />

<!-- HTML5 Shiv and Media Query Support -->
<!--[if lt IE 9]>
  <script src="/assets/js/vendor/html5shiv.min.js"></script>
  <script src="/assets/js/vendor/respond.min.js"></script>
<![endif]-->

<!-- Modernizr -->
<script src="/assets/js/vendor/modernizr-2.7.1.custom.min.js"></script>

<link rel="apple-touch-icon" sizes="57x57" href="/images/apple-icon-57x57.png" />
<link rel="apple-touch-icon" sizes="60x60" href="/images/apple-icon-60x60.png" />
<link rel="apple-touch-icon" sizes="72x72" href="/images/apple-icon-72x72.png" />
<link rel="apple-touch-icon" sizes="76x76" href="/images/apple-icon-76x76.png" />
<link rel="apple-touch-icon" sizes="114x114" href="/images/apple-icon-114x114.png" />
<link rel="apple-touch-icon" sizes="120x120" href="/images/apple-icon-120x120.png" />
<link rel="apple-touch-icon" sizes="144x144" href="/images/apple-icon-144x144.png" />
<link rel="apple-touch-icon" sizes="152x152" href="/images/apple-icon-152x152.png" />
<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-icon-180x180.png" />
<link rel="icon" type="image/png" sizes="192x192"  href="/images/android-icon-192x192.png" />
<link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png" />
<link rel="icon" type="image/png" sizes="96x96" href="/images/favicon-96x96.png" />
<link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png" />
<link rel="manifest" href="/images/manifest.json" />
<meta name="msapplication-TileColor" content="#ffffff" />
<meta name="msapplication-TileImage" content="/images/ms-icon-144x144.png" />
<meta name="theme-color" content="#ffffff" />

</head>

<body id="post">

<div class="navigation-wrapper">
	<nav role="navigation" id="site-nav" class="animated drop">
	    <ul>
      
		    
		    <li><a href="/about/" >About</a></li>
		  
		    
		    <li><a href="/blog/" >Blog</a></li>
		  
		    
		    <li><a href="/projects/" >Projects</a></li>
		  
		    
		    <li><a href="/talks/" >Talks</a></li>
		  
		    
		    <li><a href="/tags/" >Tags</a></li>
		  
	    </ul>
	</nav>
</div><!-- /.navigation-wrapper -->

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->

<header class="masthead">
	<div class="wrap">
      
      <h1 class="site-title animated fadeIn"><a href="/">Eugene Petrenko</a></h1>
		<h2 class="site-description animated fadeIn" itemprop="description">@jonnyzzz personal page and blog</h2>
	</div>
</header><!-- /.masthead -->

<div class="js-menu-screen menu-screen"></div>


<div id="main" role="main">
  <article class="hentry">
    
    <div class="entry-wrapper">
      <header class="entry-header">
        <ul class="entry-tags">
          <li><a href="/tags/#teamcity" title="Pages tagged teamcity">teamcity</a></li><li><a href="/tags/#test" title="Pages tagged test">test</a></li><li><a href="/tags/#testrunner" title="Pages tagged testrunner">testrunner</a></li><li><a href="/tags/#shell" title="Pages tagged shell">shell</a></li><li><a href="/tags/#bash" title="Pages tagged bash">bash</a></li><li><a href="/tags/#ci" title="Pages tagged ci">ci</a></li><li><a href="/tags/#go" title="Pages tagged go">go</a></li><li><a href="/tags/#build" title="Pages tagged build">build</a></li>
        </ul>
        
          <h1 class="entry-title">A Bash Test Runner for TeamCity</h1>
        
      </header>
      <footer class="entry-meta">
        
        
          <img src="/images/me.jpg" class="bio-photo" alt="Eugene Petrenko bio photo"></a>
        
        <span class="author vcard">By <span class="fn">Eugene Petrenko</span></span>
        <span class="entry-date date published"><time datetime="2017-08-09T00:00:00+00:00"><i class="fa fa-calendar-o"></i> August 09, 2017</time></span>
        
        <span class="entry-comments"><i class="fa fa-comment-o"></i> <a href="#disqus_thread">Comment</a></span>
        <span class="social-share-twitter">
  <a href="https://twitter.com/intent/tweet?hashtags=teamcity,test,testrunner,shell,bash,ci,go,build&amp;text=A%20Bash%20Test%20Runner%20for%20TeamCity&amp;url=https://jonnyzzz.com/blog/2017/08/09/test-runner/&amp;via=jonnyzzz" title="Share on Twitter" itemprop="Twitter" target="_blank"><i class="fa fa-twitter-square"></i> Tweet</a>
</span>
<span class="social-share-facebook">
  <a href="https://www.facebook.com/sharer/sharer.php?u=https://jonnyzzz.com/blog/2017/08/09/test-runner/" title="Share on Facebook" itemprop="Facebook" target="_blank"><i class="fa fa-facebook-square"></i> Like</a>
</span>

<!-- /.social-share -->

        
      </footer>
      <div class="entry-content">
        <p>An ad-hoc bash test runner with TeamCity support</p>

<p>That time I was playing with a tiny <a href="https://golang.org">Go</a> project. I was doing a console tool 
to update <a href="https://www.consul.io/">Consul KV</a> in the required way, with transaction and domain specifics.</p>

<p>Why the tool? Well, I was needed to update several keys from our <a href="https://www.ansible.com/">Ansible</a> deployment
scripts. And <a href="https://www.consul.io/api/txn.html">transactions</a> were the nice way
to run an atomic update. Secondly, it is better to offload tricky domain specific code to a dedicated 
place, which has better tests and build process. The alternative in my case was to 
use <code class="highlighter-rouge">curl</code> or similar to run Consul KV transactions with no easy way to test it easily.</p>

<p>By the time I realized it is better to call the tool from a command line to test it
does correct changed to the KV. So I was looking for a test runner.</p>

<p>After some research, I decided to use 
<a href="https://confluence.jetbrains.com/display/TCD10/Build+Script+Interaction+with+TeamCity">TeamCity Service Messages</a>
to report test progress back to the CI.</p>

<p>The idea of tests is as follows. Each test is created as an <code class="highlighter-rouge">.sh</code> file under <code class="highlighter-rouge">tests</code> folder. Exit code is used to tell 
a failure from success. That is necessary to be able to run every test and only one test locally while developing.</p>

<p>Finally, I created the following test runner:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#!/bin/bash</span>
<span class="nb">set</span> <span class="nt">-e</span> <span class="nt">-x</span> <span class="nt">-u</span>
<span class="nb">cd</span> <span class="s2">"</span><span class="k">$(</span> <span class="nb">cd</span> <span class="s2">"</span><span class="k">$(</span> <span class="nb">dirname</span> <span class="s2">"</span><span class="k">${</span><span class="nv">BASH_SOURCE</span><span class="p">[0]</span><span class="k">}</span><span class="s2">"</span> <span class="k">)</span><span class="s2">"</span> <span class="o">&amp;&amp;</span> <span class="nb">pwd</span> <span class="k">)</span><span class="s2">"</span>

<span class="nb">echo</span> <span class="s2">"Running integration tests..."</span>
<span class="nv">FAILED</span><span class="o">=</span>0
<span class="nv">TC</span><span class="o">=</span><span class="c">##teamcity</span>
<span class="nb">echo</span> <span class="s2">" </span><span class="k">${</span><span class="nv">TC</span><span class="k">}</span><span class="s2">[testSuiteStarted name='integration-tests'] "</span>

<span class="k">for </span>TEST <span class="k">in </span>tests/<span class="k">*</span> <span class="p">;</span> <span class="k">do
  </span><span class="nv">TEST_NAME</span><span class="o">=</span><span class="k">$(</span><span class="nb">basename</span> <span class="nv">$TEST</span><span class="k">)</span>
  <span class="nb">echo</span> <span class="s2">" </span><span class="k">${</span><span class="nv">TC</span><span class="k">}</span><span class="s2">[testStarted name='</span><span class="nv">$TEST_NAME</span><span class="s2">' captureStandardOutput='true'] "</span>
  ./<span class="nv">$TEST</span> <span class="o">||</span> <span class="o">{</span>
    <span class="nb">echo</span> <span class="s2">" </span><span class="k">${</span><span class="nv">TC</span><span class="k">}</span><span class="s2">[testFailed name='</span><span class="nv">$TEST_NAME</span><span class="s2">'] "</span>
  <span class="o">}</span>
  <span class="nb">echo</span> <span class="s2">" </span><span class="k">${</span><span class="nv">TC</span><span class="k">}</span><span class="s2">[testFinished name='</span><span class="nv">$TEST_NAME</span><span class="s2">'] "</span>
<span class="k">done

</span><span class="nb">echo</span> <span class="s2">" </span><span class="k">${</span><span class="nv">TC</span><span class="k">}</span><span class="s2">[testSuiteFinished name='integration-tests'] "</span></code></pre></figure>

<p>By the time, I’m still uncertain, if I need to use this one. Or, maybe I should switch to <code class="highlighter-rouge">go test</code> in the future. 
The best feature of the test above is it supported by <a href="https://jetbrains.com/teamcity">TeamCity</a>.</p>

<p>Yoy may find the actual version of it on GitHub. 
<a href="https://github.com/jonnyzzz/teamcity-test-script">https://github.com/jonnyzzz/teamcity-test-script</a>.</p>

<p>UPD. I have re-evaluated approaches and decided to implement integration tests with 
<a href="https://golang.org/pkg/testing/">go test</a> instead. The main problem was that I need to pass many 
parameters to my tool to start it in a test. Hard-coding those parameters for every test was not worth it. 
In Go it was easier to create an assertions API to check Consul KV state too. The API helps to setup 
necessary KV state too. The whole approach makes it simpler to write tests.</p>

<p>I’m able to run all of my tests from <a href="https://www.jetbrains.com/go/">Gogland</a>. 
The test assumes Consul is running by checking a particular file under the <code class="highlighter-rouge">GOPATH</code>. 
There is a setup bash script that downloads and starts Consul dev server both for development and continuous integration. 
I extended the <a href="/blog/2017/07/05/go-build/">bash script</a> for that.</p>

        
          <div id="disqus_thread"></div><!-- /#disqus_thread -->
          
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'jonnyzzz'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

        
      </div><!-- /.entry-content -->
    </div><!-- /.entry-wrapper -->
    <nav class="pagination" role="navigation">
      
        <a href="/blog/2017/07/05/go-build/" class="btn" title="Building Go Project">Previous</a>
      
      
        <a href="/blog/2017/08/23/ssh-oom/" class="btn" title="A Sudden SSH out-of-memory">Next</a>
      
    </nav><!-- /.pagination -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo" class="entry-wrapper">
    

<span>
  &copy; 2005—2019 Eugene Petrenko.
  <br />
  Unless otherwise noted, the content on the website is licensed under a
  <a href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a> license.
  <br />
  Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using
  the <a href="https://mademistakes.com/work/so-simple-jekyll-theme/" rel="nofollow">So Simple Theme</a>.
</span>
<div class="social-icons">
	<a href="https://twitter.com/jonnyzzz" title="Eugene Petrenko on Twitter" target="_blank"><i class="fa fa-twitter-square fa-2x"></i></a>
	<a href="https://facebook.com/jonnyzzz" title="Eugene Petrenko on Facebook" target="_blank"><i class="fa fa-facebook-square fa-2x"></i></a>
	<a href="https://plus.google.com/+EugenePetrenko_jonnyzzz" title="Eugene Petrenko on Google+" target="_blank"><i class="fa fa-google-plus-square fa-2x"></i></a>
	<a href="https://linkedin.com/in/jonnyzzz" title="Eugene Petrenko on LinkedIn" target="_blank"><i class="fa fa-linkedin-square fa-2x"></i></a>
	<a href="http://stackoverflow.com/users/49811/eugene-petrenko" title="Eugene Petrenko on StackExchange" target="_blank"><i class="fa fa-stack-exchange fa-2x"></i></a>
	<a href="https://instagram.com/jonnyzzz" title="Eugene Petrenko on Instagram" target="_blank"><i class="fa fa-instagram fa-2x"></i></a>
	<a href="https://www.flickr.com/photos/_jonny_" title="Eugene Petrenko on Flickr" target="_blank"><i class="fa fa-flickr fa-2x"></i></a>
	<a href="https://github.com/jonnyzzz" title="Eugene Petrenko on Github" target="_blank"><i class="fa fa-github-square fa-2x"></i></a>
	
  <a href="https://www.pinterest.com/jonnyzzz/" title="Eugene Petrenko on Pinterest" target="_blank"><i class="fa fa-pinterest fa-2x"></i></a>
	
  <a href="https://feeds.feedburner.com/jonnyzzz" title="Atom/RSS feed"><i class="fa fa-rss-square fa-2x"></i></a>
</div><!-- /.social-icons -->

  </footer>
</div><!-- /.footer-wrapper -->

<script type="text/javascript">
  var BASE_URL = '';
</script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="/assets/js/scripts.min.js"></script>


<!-- Asynchronous Google Analytics snippet -->
<script>
  var _gaq = _gaq || [];
  var pluginUrl =
 'https://www.google-analytics.com/plugins/ga/inpage_linkid.js';
  _gaq.push(['_require', 'inpage_linkid', pluginUrl]);
  _gaq.push(['_setAccount', 'UA-70104598-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = 'https://stats.g.doubleclick.net/dc.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>




<!-- MathJax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


<script type="text/javascript">
  window.cookieconsent_options = {"message":"This website uses cookies to ensure you get the best experience on our website","dismiss":"Got it!","learnMore":"More info","link":null,"theme":"light-bottom"};
</script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/1.0.9/cookieconsent.min.js"></script>



<!--SYNTAX HIGHLIGHTER BEGINS-->

<script src="/assets/syntax/syntax.js"></script>

<link rel="stylesheet" href="/assets/syntax/syntax.css" />

<!--SYNTAX HIGHLIGHTER ENDS-->



</body>
</html>
