<!doctype html>
<html class="no-js" lang="en">
<head>
<meta charset="utf-8" />
<title>A Bash Test Runner for TeamCity &#8211; Eugene Petrenko</title>
<meta name="description" content="An ad-hoc bash test runner with TeamCity support
"/>
<meta name="keywords" content="jonnyzzz, Евгений Петренко, Eugene Petrenko, teamcity, test, testrunner, shell, bash, ci, go, build" />


<!-- Twitter Cards -->
<meta name="twitter:title" content="A Bash Test Runner for TeamCity -- Eugene Petrenko" />
<meta name="twitter:description" content="An ad-hoc bash test runner with TeamCity support
" />
<meta name="twitter:site" content="@jonnyzzz" />
<meta name="twitter:creator" content="@jonnyzzz" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="https://jonnyzzz.com/images/me.jpg" />

<!-- Open Graph -->

<meta property="og:type" content="article" />
<meta property="og:image" content="https://jonnyzzz.com/images/me.jpg" />
<meta property="og:title" content="A Bash Test Runner for TeamCity -- Eugene Petrenko" />
<meta property="og:description" content="An ad-hoc bash test runner with TeamCity support
" />
<meta property="og:url" content="https://jonnyzzz.com/blog/2017/08/09/test-runner/" />
<meta property="og:site_name" content="Eugene Petrenko" />

<meta property="article:tag" content="jonnyzzz" />

<meta property="article:tag" content="Евгений Петренко" />

<meta property="article:tag" content="Eugene Petrenko" />


<meta property="article:tag" content="teamcity" />

<meta property="article:tag" content="test" />

<meta property="article:tag" content="testrunner" />

<meta property="article:tag" content="shell" />

<meta property="article:tag" content="bash" />

<meta property="article:tag" content="ci" />

<meta property="article:tag" content="go" />

<meta property="article:tag" content="build" />



<!-- Webmaster Tools verfication -->
<meta name="google-site-verification" content="MJZCyfst2Tx4KyxbOIQu1fZyOSwA_JkQu73zJcfsl2g" />




<link rel="canonical" href="https://jonnyzzz.com/blog/2017/08/09/test-runner/" />
<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="ATOM Feed" />

<meta name="HandheldFriendly" content="True" />
<meta name="MobileOptimized" content="320" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css" />

<link rel="apple-touch-icon" sizes="57x57" href="/images/apple-icon-57x57.png" />
<link rel="apple-touch-icon" sizes="60x60" href="/images/apple-icon-60x60.png" />
<link rel="apple-touch-icon" sizes="72x72" href="/images/apple-icon-72x72.png" />
<link rel="apple-touch-icon" sizes="76x76" href="/images/apple-icon-76x76.png" />
<link rel="apple-touch-icon" sizes="114x114" href="/images/apple-icon-114x114.png" />
<link rel="apple-touch-icon" sizes="120x120" href="/images/apple-icon-120x120.png" />
<link rel="apple-touch-icon" sizes="144x144" href="/images/apple-icon-144x144.png" />
<link rel="apple-touch-icon" sizes="152x152" href="/images/apple-icon-152x152.png" />
<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-icon-180x180.png" />
<link rel="icon" type="image/png" sizes="192x192"  href="/images/android-icon-192x192.png" />
<link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png" />
<link rel="icon" type="image/png" sizes="96x96" href="/images/favicon-96x96.png" />
<link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png" />
<link rel="manifest" href="/images/manifest.json" />
<meta name="msapplication-TileColor" content="#ffffff" />
<meta name="msapplication-TileImage" content="/images/ms-icon-144x144.png" />
<meta name="theme-color" content="#ffffff" />

</head>

<body id="post">

<div class="navigation-wrapper">
	<nav role="navigation" id="site-nav">
	    <ul>
      
		    <li><a href="/" >Home</a></li>
		  
		    <li><a href="/about/" >About</a></li>
		  
		    <li><a href="/blog/" >Blog</a></li>
		  
		    <li><a href="/projects/" >Projects</a></li>
		  
		    <li><a href="/talks/" >Talks</a></li>
		  
		    <li><a href="/tags/" >Tags</a></li>
		  
	    </ul>
	</nav>
</div><!-- /.navigation-wrapper -->

<header class="masthead">
	<div class="wrap">
      
      <h1 class="site-title"><a href="/">Eugene Petrenko</a></h1>
		<h2 class="site-description" itemprop="description">Founding Engineering Leader | Agentic AI DevTools & Experience</h2>
	</div>
</header><!-- /.masthead -->


<div id="main" role="main">
  <article class="hentry">
    
    <div class="entry-wrapper">
      <header class="entry-header">
        <ul class="entry-tags">
          <li><a href="/tags/#teamcity" title="Pages tagged teamcity">teamcity</a></li><li><a href="/tags/#test" title="Pages tagged test">test</a></li><li><a href="/tags/#testrunner" title="Pages tagged testrunner">testrunner</a></li><li><a href="/tags/#shell" title="Pages tagged shell">shell</a></li><li><a href="/tags/#bash" title="Pages tagged bash">bash</a></li><li><a href="/tags/#ci" title="Pages tagged ci">ci</a></li><li><a href="/tags/#go" title="Pages tagged go">go</a></li><li><a href="/tags/#build" title="Pages tagged build">build</a></li>
        </ul>
        
          <h1 class="entry-title">A Bash Test Runner for TeamCity</h1>
        
      </header>
      <footer class="entry-meta">
        
        
          <img src="/images/me.jpg" class="bio-photo" alt="Eugene Petrenko bio photo"></a>
        
        <span class="author vcard">By <span class="fn">Eugene Petrenko</span></span>
        <span class="entry-date date published"><time datetime="2017-08-09T00:00:00+00:00">August 09, 2017</time></span>
        
        
        <span class="social-share-x">
  <a href="https://x.com/intent/tweet?hashtags=teamcity,test,testrunner,shell,bash,ci,go,build&amp;text=A%20Bash%20Test%20Runner%20for%20TeamCity&amp;url=https://jonnyzzz.com/blog/2017/08/09/test-runner/&amp;via=jonnyzzz" title="Share on X" itemprop="X" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="14" height="14" style="vertical-align: middle; fill: currentColor;"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg> Post</a>
</span>
<span class="social-share-facebook">
  <a href="https://www.facebook.com/sharer/sharer.php?u=https://jonnyzzz.com/blog/2017/08/09/test-runner/" title="Share on Facebook" itemprop="Facebook" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="14" height="14" style="vertical-align: middle; fill: currentColor;"><path d="M22 12c0-5.52-4.48-10-10-10S2 6.48 2 12c0 4.84 3.44 8.87 8 9.8V15H8v-3h2V9.5C10 7.57 11.57 6 13.5 6H16v3h-2c-.55 0-1 .45-1 1v2h3v3h-3v6.95c5.05-.5 9-4.76 9-9.95z"/></svg> Like</a>
</span>
<!-- /.social-share -->

      </footer>
      <div class="entry-content">
        <p>An ad-hoc bash test runner with TeamCity support</p>

<p>That time I was playing with a tiny <a href="https://golang.org">Go</a> project. I was doing a console tool 
to update <a href="https://www.consul.io/">Consul KV</a> in the required way, with transaction and domain specifics.</p>

<p>Why the tool? Well, I was needed to update several keys from our <a href="https://www.ansible.com/">Ansible</a> deployment
scripts. And <a href="https://www.consul.io/api/txn.html">transactions</a> were the nice way
to run an atomic update. Secondly, it is better to offload tricky domain specific code to a dedicated 
place, which has better tests and build process. The alternative in my case was to 
use <code class="language-plaintext highlighter-rouge">curl</code> or similar to run Consul KV transactions with no easy way to test it easily.</p>

<p>By the time I realized it is better to call the tool from a command line to test it
does correct changed to the KV. So I was looking for a test runner.</p>

<p>After some research, I decided to use 
<a href="https://confluence.jetbrains.com/display/TCD10/Build+Script+Interaction+with+TeamCity">TeamCity Service Messages</a>
to report test progress back to the CI.</p>

<p>The idea of tests is as follows. Each test is created as an <code class="language-plaintext highlighter-rouge">.sh</code> file under <code class="language-plaintext highlighter-rouge">tests</code> folder. Exit code is used to tell 
a failure from success. That is necessary to be able to run every test and only one test locally while developing.</p>

<p>Finally, I created the following test runner:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#!/bin/bash</span>
<span class="nb">set</span> <span class="nt">-e</span> <span class="nt">-x</span> <span class="nt">-u</span>
<span class="nb">cd</span> <span class="s2">"</span><span class="si">$(</span> <span class="nb">cd</span> <span class="s2">"</span><span class="si">$(</span> <span class="nb">dirname</span> <span class="s2">"</span><span class="k">${</span><span class="nv">BASH_SOURCE</span><span class="p">[0]</span><span class="k">}</span><span class="s2">"</span> <span class="si">)</span><span class="s2">"</span> <span class="o">&amp;&amp;</span> <span class="nb">pwd</span> <span class="si">)</span><span class="s2">"</span>

<span class="nb">echo</span> <span class="s2">"Running integration tests..."</span>
<span class="nv">FAILED</span><span class="o">=</span>0
<span class="nv">TC</span><span class="o">=</span><span class="c">##teamcity</span>
<span class="nb">echo</span> <span class="s2">" </span><span class="k">${</span><span class="nv">TC</span><span class="k">}</span><span class="s2">[testSuiteStarted name='integration-tests'] "</span>

<span class="k">for </span>TEST <span class="k">in </span>tests/<span class="k">*</span> <span class="p">;</span> <span class="k">do
  </span><span class="nv">TEST_NAME</span><span class="o">=</span><span class="si">$(</span><span class="nb">basename</span> <span class="nv">$TEST</span><span class="si">)</span>
  <span class="nb">echo</span> <span class="s2">" </span><span class="k">${</span><span class="nv">TC</span><span class="k">}</span><span class="s2">[testStarted name='</span><span class="nv">$TEST_NAME</span><span class="s2">' captureStandardOutput='true'] "</span>
  ./<span class="nv">$TEST</span> <span class="o">||</span> <span class="o">{</span>
    <span class="nb">echo</span> <span class="s2">" </span><span class="k">${</span><span class="nv">TC</span><span class="k">}</span><span class="s2">[testFailed name='</span><span class="nv">$TEST_NAME</span><span class="s2">'] "</span>
  <span class="o">}</span>
  <span class="nb">echo</span> <span class="s2">" </span><span class="k">${</span><span class="nv">TC</span><span class="k">}</span><span class="s2">[testFinished name='</span><span class="nv">$TEST_NAME</span><span class="s2">'] "</span>
<span class="k">done

</span><span class="nb">echo</span> <span class="s2">" </span><span class="k">${</span><span class="nv">TC</span><span class="k">}</span><span class="s2">[testSuiteFinished name='integration-tests'] "</span></code></pre></figure>

<p>By the time, I’m still uncertain, if I need to use this one. Or, maybe I should switch to <code class="language-plaintext highlighter-rouge">go test</code> in the future. 
The best feature of the test above is it supported by <a href="https://jetbrains.com/teamcity">TeamCity</a>.</p>

<p>Yoy may find the actual version of it on GitHub. 
<a href="https://github.com/jonnyzzz/teamcity-test-script">https://github.com/jonnyzzz/teamcity-test-script</a>.</p>

<p>UPD. I have re-evaluated approaches and decided to implement integration tests with 
<a href="https://golang.org/pkg/testing/">go test</a> instead. The main problem was that I need to pass many 
parameters to my tool to start it in a test. Hard-coding those parameters for every test was not worth it. 
In Go it was easier to create an assertions API to check Consul KV state too. The API helps to setup 
necessary KV state too. The whole approach makes it simpler to write tests.</p>

<p>I’m able to run all of my tests from <a href="https://www.jetbrains.com/go/">Gogland</a>. 
The test assumes Consul is running by checking a particular file under the <code class="language-plaintext highlighter-rouge">GOPATH</code>. 
There is a setup bash script that downloads and starts Consul dev server both for development and continuous integration. 
I extended the <a href="/blog/2017/07/05/go-build/">bash script</a> for that.</p>

        
      </div><!-- /.entry-content -->
    </div><!-- /.entry-wrapper -->
    <nav class="pagination" role="navigation">
      
        <a href="/blog/2017/07/05/go-build/" class="btn" title="Building Go Project">Previous</a>
      
      
        <a href="/blog/2017/08/23/ssh-oom/" class="btn" title="A Sudden SSH out-of-memory">Next</a>
      
    </nav><!-- /.pagination -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo" class="entry-wrapper">
    

<span>
  &copy; 2005—2026 Eugene Petrenko.
  <br />
  Unless otherwise noted, the content on the website is licensed under a
  <a href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a> license.
  <br />
  Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using
  the <a href="https://mademistakes.com/work/so-simple-jekyll-theme/" rel="nofollow">So Simple Theme</a>.
</span>
<div class="social-icons">
  <a href="https://x.com/jonnyzzz" title="Eugene Petrenko on X" target="_blank"><svg class="social-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg></a>
  <a href="https://linkedin.com/in/jonnyzzz" title="Eugene Petrenko on LinkedIn" target="_blank"><svg class="social-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 3a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14m-.5 15.5v-5.3a3.26 3.26 0 0 0-3.26-3.26c-.85 0-1.84.52-2.32 1.3v-1.11h-2.79v8.37h2.79v-4.93c0-.77.62-1.4 1.39-1.4a1.4 1.4 0 0 1 1.4 1.4v4.93h2.79M6.88 8.56a1.68 1.68 0 0 0 1.68-1.68c0-.93-.75-1.69-1.68-1.69a1.69 1.69 0 0 0-1.69 1.69c0 .93.76 1.68 1.69 1.68m1.39 9.94v-8.37H5.5v8.37h2.77z"/></svg></a>
  <a href="https://github.com/jonnyzzz" title="Eugene Petrenko on Github" target="_blank"><svg class="social-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33.85 0 1.71.11 2.5.33 1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2z"/></svg></a>
  <a href="https://www.youtube.com/channel/UC9Q18kLRzcJ1xtOJ3GGvxBw" title="Eugene Petrenko on YouTube" target="_blank"><svg class="social-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M23.498 6.186a2.959 2.959 0 0 0-2.079-2.08C19.58 3.6 12 3.6 12 3.6s-7.58 0-9.419.507a2.959 2.959 0 0 0-2.08 2.079C0 8.025 0 12 0 12s0 3.975.501 5.814a2.959 2.959 0 0 0 2.08 2.079C4.42 20.4 12 20.4 12 20.4s7.58 0 9.419-.507a2.959 2.959 0 0 0 2.08-2.079C24 15.975 24 12 24 12s0-3.975-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg></a>
  <a href="/feed.xml" title="Atom/RSS feed"><svg class="social-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6.18 15.64a2.18 2.18 0 0 1 2.18 2.18C8.36 19 7.38 20 6.18 20C5 20 4 19 4 17.82a2.18 2.18 0 0 1 2.18-2.18M4 4.44A15.56 15.56 0 0 1 19.56 20h-2.83A12.73 12.73 0 0 0 4 7.27V4.44m0 5.66a9.9 9.9 0 0 1 9.9 9.9h-2.83A7.07 7.07 0 0 0 4 12.93V10.1z"/></svg></a>
</div><!-- /.social-icons -->

  </footer>
</div><!-- /.footer-wrapper -->

<script>
  // Open external links in new tab
  Array.from(document.links).forEach(link => {
    // For development: 0.0.0.0, localhost, 127.0.0.1 are all local
    const localHosts = ['localhost', '127.0.0.1', '0.0.0.0'];
    const linkIsLocal = localHosts.includes(link.hostname);
    const pageIsLocal = localHosts.includes(window.location.hostname);

    // Internal if: both are local dev hosts, or hostnames match exactly
    const isInternal = (linkIsLocal && pageIsLocal) ||
                       (link.hostname === window.location.hostname);

    if (!isInternal) {
      link.target = '_blank';
    }
  });
</script>


<!-- Google Analytics (gtag.js) -->
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('consent', 'default', {
    'ad_storage': 'denied',
    'ad_user_data': 'denied',
    'ad_personalization': 'denied',
    'analytics_storage': 'denied'
  });
</script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-BXXDX0ERFP"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-BXXDX0ERFP');
</script>
<!-- End Google Analytics -->




<!--SYNTAX HIGHLIGHTER - Lazy loads PrismJS only when code blocks are present-->
<script>
(function() {
  // Check if page has any code blocks that need highlighting
  if (!document.querySelector('pre code, code[class*="language-"]')) return;

  // Load CSS
  var cssFiles = [
    'https://cdn.jsdelivr.net/npm/prismjs@1.30.0/themes/prism.min.css',
    'https://cdn.jsdelivr.net/npm/prismjs@1.30.0/plugins/line-numbers/prism-line-numbers.min.css',
    'https://cdn.jsdelivr.net/npm/prismjs@1.30.0/plugins/toolbar/prism-toolbar.min.css'
  ];
  cssFiles.forEach(function(href) {
    var link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = href;
    document.head.appendChild(link);
  });

  // Load JS in sequence (core first, then plugins)
  var jsFiles = [
    'https://cdn.jsdelivr.net/npm/prismjs@1.30.0/components/prism-core.min.js',
    'https://cdn.jsdelivr.net/npm/prismjs@1.30.0/plugins/autoloader/prism-autoloader.min.js',
    'https://cdn.jsdelivr.net/npm/prismjs@1.30.0/plugins/line-numbers/prism-line-numbers.min.js',
    'https://cdn.jsdelivr.net/npm/prismjs@1.30.0/plugins/toolbar/prism-toolbar.min.js',
    'https://cdn.jsdelivr.net/npm/prismjs@1.30.0/plugins/show-language/prism-show-language.min.js',
    'https://cdn.jsdelivr.net/npm/prismjs@1.30.0/plugins/normalize-whitespace/prism-normalize-whitespace.min.js'
  ];

  function loadScript(index) {
    if (index >= jsFiles.length) {
      // All scripts loaded, highlight code
      if (window.Prism) Prism.highlightAll();
      return;
    }
    var script = document.createElement('script');
    script.src = jsFiles[index];
    script.onload = function() { loadScript(index + 1); };
    document.head.appendChild(script);
  }
  loadScript(0);
})();
</script>



</body>
</html>
