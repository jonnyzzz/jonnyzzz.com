<!doctype html>
<html class="no-js" lang="en">
<head>
<meta charset="utf-8" />
<title>A Sudden SSH out-of-memory &#8211; Eugene Petrenko</title>
<meta name="description" content="An accident and investigation of the server failure
"/>
<meta name="keywords" content="jonnyzzz, Евгений Петренко, Eugene Petrenko, git, ssh, java, oom, putty, opensource, debug, service" />


<!-- Twitter Cards -->
<meta name="twitter:title" content="A Sudden SSH out-of-memory -- Eugene Petrenko" />
<meta name="twitter:description" content="An accident and investigation of the server failure
" />
<meta name="twitter:site" content="@jonnyzzz" />
<meta name="twitter:creator" content="@jonnyzzz" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="https://jonnyzzz.com/images/me.jpg" />

<!-- Open Graph -->

<meta property="og:type" content="article" />
<meta property="og:image" content="https://jonnyzzz.com/images/me.jpg" />
<meta property="og:title" content="A Sudden SSH out-of-memory -- Eugene Petrenko" />
<meta property="og:description" content="An accident and investigation of the server failure
" />
<meta property="og:url" content="https://jonnyzzz.com/blog/2017/08/23/ssh-oom/" />
<meta property="og:site_name" content="Eugene Petrenko" />

<meta property="article:tag" content="jonnyzzz" />

<meta property="article:tag" content="Евгений Петренко" />

<meta property="article:tag" content="Eugene Petrenko" />


<meta property="article:tag" content="git" />

<meta property="article:tag" content="ssh" />

<meta property="article:tag" content="java" />

<meta property="article:tag" content="oom" />

<meta property="article:tag" content="putty" />

<meta property="article:tag" content="opensource" />

<meta property="article:tag" content="debug" />

<meta property="article:tag" content="service" />



<!-- Webmaster Tools verfication -->
<meta name="google-site-verification" content="MJZCyfst2Tx4KyxbOIQu1fZyOSwA_JkQu73zJcfsl2g" />




<link rel="canonical" href="https://jonnyzzz.com/blog/2017/08/23/ssh-oom/" />
<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="ATOM Feed" />

<meta name="HandheldFriendly" content="True" />
<meta name="MobileOptimized" content="320" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css" />

<link rel="apple-touch-icon" sizes="57x57" href="/images/apple-icon-57x57.png" />
<link rel="apple-touch-icon" sizes="60x60" href="/images/apple-icon-60x60.png" />
<link rel="apple-touch-icon" sizes="72x72" href="/images/apple-icon-72x72.png" />
<link rel="apple-touch-icon" sizes="76x76" href="/images/apple-icon-76x76.png" />
<link rel="apple-touch-icon" sizes="114x114" href="/images/apple-icon-114x114.png" />
<link rel="apple-touch-icon" sizes="120x120" href="/images/apple-icon-120x120.png" />
<link rel="apple-touch-icon" sizes="144x144" href="/images/apple-icon-144x144.png" />
<link rel="apple-touch-icon" sizes="152x152" href="/images/apple-icon-152x152.png" />
<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-icon-180x180.png" />
<link rel="icon" type="image/png" sizes="192x192"  href="/images/android-icon-192x192.png" />
<link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png" />
<link rel="icon" type="image/png" sizes="96x96" href="/images/favicon-96x96.png" />
<link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png" />
<link rel="manifest" href="/images/manifest.json" />
<meta name="msapplication-TileColor" content="#ffffff" />
<meta name="msapplication-TileImage" content="/images/ms-icon-144x144.png" />
<meta name="theme-color" content="#ffffff" />

</head>

<body id="post">

<div class="navigation-wrapper">
	<nav role="navigation" id="site-nav">
	    <ul>
      
		    <li><a href="/" >Home</a></li>
		  
		    <li><a href="/about/" >About</a></li>
		  
		    <li><a href="/blog/" >Blog</a></li>
		  
		    <li><a href="/projects/" >Projects</a></li>
		  
		    <li><a href="/talks/" >Talks</a></li>
		  
		    <li><a href="/tags/" >Tags</a></li>
		  
	    </ul>
	</nav>
</div><!-- /.navigation-wrapper -->

<header class="masthead">
	<div class="wrap">
      
      <h1 class="site-title"><a href="/">Eugene Petrenko</a></h1>
		<h2 class="site-description" itemprop="description">@jonnyzzz personal page and blog</h2>
	</div>
</header><!-- /.masthead -->

<div class="js-menu-screen menu-screen"></div>


<div id="main" role="main">
  <article class="hentry">
    
    <div class="entry-wrapper">
      <header class="entry-header">
        <ul class="entry-tags">
          <li><a href="/tags/#git" title="Pages tagged git">git</a></li><li><a href="/tags/#ssh" title="Pages tagged ssh">ssh</a></li><li><a href="/tags/#java" title="Pages tagged java">java</a></li><li><a href="/tags/#oom" title="Pages tagged oom">oom</a></li><li><a href="/tags/#putty" title="Pages tagged putty">putty</a></li><li><a href="/tags/#opensource" title="Pages tagged opensource">opensource</a></li><li><a href="/tags/#debug" title="Pages tagged debug">debug</a></li><li><a href="/tags/#service" title="Pages tagged service">service</a></li>
        </ul>
        
          <h1 class="entry-title">A Sudden SSH out-of-memory</h1>
        
      </header>
      <footer class="entry-meta">
        
        
          <img src="/images/me.jpg" class="bio-photo" alt="Eugene Petrenko bio photo"></a>
        
        <span class="author vcard">By <span class="fn">Eugene Petrenko</span></span>
        <span class="entry-date date published"><time datetime="2017-08-23T00:00:00+00:00"><i class="fa fa-calendar-o"></i> August 23, 2017</time></span>
        
        
        <span class="social-share-x">
  <a href="https://x.com/intent/tweet?hashtags=git,ssh,java,oom,putty,opensource,debug,service&amp;text=A%20Sudden%20SSH%20out-of-memory&amp;url=https://jonnyzzz.com/blog/2017/08/23/ssh-oom/&amp;via=jonnyzzz" title="Share on X" itemprop="X" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="14" height="14" style="vertical-align: middle; fill: currentColor;"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg> Post</a>
</span>
<span class="social-share-facebook">
  <a href="https://www.facebook.com/sharer/sharer.php?u=https://jonnyzzz.com/blog/2017/08/23/ssh-oom/" title="Share on Facebook" itemprop="Facebook" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="14" height="14" style="vertical-align: middle; fill: currentColor;"><path d="M22 12c0-5.52-4.48-10-10-10S2 6.48 2 12c0 4.84 3.44 8.87 8 9.8V15H8v-3h2V9.5C10 7.57 11.57 6 13.5 6H16v3h-2c-.55 0-1 .45-1 1v2h3v3h-3v6.95c5.05-.5 9-4.76 9-9.95z"/></svg> Like</a>
</span>
<!-- /.social-share -->

        
      </footer>
      <div class="entry-content">
        <p>An accident and investigation of the server failure</p>

<p>In this post, I am going to share an accident I had recently with
in-house production.</p>

<p>Let’s assume we have an SSH server. Clients who call
commands through it. Quite simple, right?</p>

<p>Of course, we cannot have only one SSH server. Instead, we run 
several SSH servers and use HAProxy to load-balance traffic 
to them. It is way more safe to have several servers, 
instead of one. For example, it simplifies maintenance, allows 
to easily implement 
<a href="https://en.wikipedia.org/wiki/Rolling_release">Rolling Updates</a>
or say 
<a href="https://en.wikipedia.org/wiki/A/B_testing">A/B Testing</a>.
I <a href="/blog/2017/05/24/ssh-haproxy/">wrote in a previous post</a>
more details on our HAProxy setup some time ago</p>

<h1 id="the-outage-as-seen-by-users">The outage as seen by users</h1>

<p>At some day, our users (as I can recreate from reports) started to see
strange connection timeouts from SSH server calls. The call they did was 
to download several gigabytes of data.</p>

<p>From a user perspective, it’s totally OK to retry a command once it failed 
for the very first time. So they did it.</p>

<p>After several retries, they tend to give up. At that time our system
was no longer capable of serving any SSH requests at all</p>

<h1 id="the-outage-as-seen-from-the-server-side">The outage as seen from the server-side</h1>

<p>We are running several SSH servers behind HAProxy. Servers were running 
in JVM. I use amazing <a href="https://mina.apache.org/sshd-project/">Apache Mina SSHD</a>
to implement our <a href="https://jonnyzzz.com/contrib/#apache-mina-sshd">SSH server</a>.</p>

<p>Alerts appeared for our SSH servers. HAProxy started to drain traffic from dead SSH 
servers, based on health checks. It was good since other requests were still 
able to execute on still live servers.</p>

<p>There were only two servers in our setup. So the system was too fast to be killed.</p>

<p>All dead server had an out-of-memory (OOM) before death. Sadly, but it is 
hard to write an application that is can survive OOMs and continue to function. In our case, OOM
tended to kill either SSH server socket processing for either SSH or HTTP.</p>

<p>The good side was that those SSH servers had not sensible state. Thus it was easy to restart
them to be back in business. So we had the workaround</p>

<h1 id="java-heap-dump-analysis">Java heap dump analysis</h1>

<p>By that time I had several memory dumps (.hprof) files from failed servers. It was
time to analyze what is there. 
All those failures were only because a send buffer was full of data, consuming the 
rest of heap memory. More detailed, I found a massive SSH session object.</p>

<p>With more analysis, I found the whole memory was consumed by the write queue.</p>

<p>A closer look in memory dumps and I was able to figure out the outage was caused by
a fresh <a href="https://www.chiark.greenend.org.uk/~sgtatham/putty/">Putty</a> client on Windows, e.g. 
<code class="language-plaintext highlighter-rouge">SSH-2.0-PuTTY_Release_0.69</code>. At the time of the accident, it was the most recent version.</p>

<p>The state was that I had an OOM issue downloading several gigabytes of data over the 
SSH with Putty client. It was time to write integration tests to reproduce the problem. 
I did it. I was able to test every putty client version. I tried <code class="language-plaintext highlighter-rouge">0.67</code>, <code class="language-plaintext highlighter-rouge">0.68</code> and <code class="language-plaintext highlighter-rouge">0.69</code>.
The OOM problem was likely to be introduced in <code class="language-plaintext highlighter-rouge">0.68</code>.</p>

<h1 id="client-problem-and-users">Client problem and users</h1>

<p>Memory snapshot analysis was helpful to realize the problem was with a specific 
version of an SSH client. I also knew, only users with fresh computers we reporting 
the issue too.</p>

<p>It was evident I cannot do anything with the client. Users decided to use it for 
their reasons. Also, my SSH server implementation did not support the client 
filtering. Anyway, I’d be too hard to explain everyone the problem is probably with 
recent update of their software.</p>

<h1 id="debugging-the-problem">Debugging the problem</h1>

<p>Thanks to integration tests I did, I was also able to debug the problem and realize
the cause of the issue.</p>

<p>I found the method, which handles all writes on the server: 
<code class="language-plaintext highlighter-rouge">org.apache.sshd.common.session.AbstractSession#writePacket(org.apache.sshd.common.util.buffer.Buffer)</code></p>

<p>Apache Mina SSHD server is async. Instead of writing data directly to the socket it 
enqueues the data and sends once the OS is ready for it.</p>

<p>Also, the implementation writes messages to a dedicated queue while 
re-key process is running. This method is called for every SSH command 
channel writes too. SSH window size is checked before calling the method, so
the command writer is blocked to wait while queued messages are sent.</p>

<p>In memory dumps of the session object, I saw the window was barely unlimited.
<img src="/images/posts/2017-08-23-snapshot.jpg" alt="Memory Snapshot" /></p>

<p>Having unlimited window and a slow network is enough for a server to consume all memory
with messages queue. In my case SSH, command was streaming several gigabytes of data from memory.</p>

<p>There are two questions:</p>
<ul>
  <li>Why is it happening only now?</li>
  <li>How can we avoid the problem?</li>
</ul>

<h1 id="ssh-window-abuse">SSH window abuse</h1>

<p>As we know, SSH protocol uses windows to limit the number of data being queued. Why didn’t it work?</p>

<p>It was easy to debug. I found out Putty was sending 2GB (e.g., signed integer max value) as the size 
of the receive window. Well, I saw no reason why. But having such a huge send window makes 
SSH server enqueue up to 2GB of data per session.</p>

<p>An optimistic approach, as we are a victim of it, is to trust SSH client and use the window as-is.</p>

<p>A defensive approach is to have an additional send window in SSH server to avoid blindly trusting a client.</p>

<h1 id="sshd-patch">SSHD patch</h1>

<p>Now it was more or less clear. The problem was in unlimited write queue and infinite send window. 
I created an issue for the Apache Mina SSHD project to let anyone know there is such a problem.</p>

<p><a href="https://issues.apache.org/jira/browse/SSHD-754">https://issues.apache.org/jira/browse/SSHD-754</a></p>

<p>I did a trivial patch on for the server. I decided to limit write queue for channel messages
to block the sender even in the case send window is unlimited. I simply use a semaphore for it:</p>

<figure class="highlight"><pre><code class="language-kotlin" data-lang="kotlin">  <span class="k">private</span> <span class="kd">val</span> <span class="py">CHANNEL_STDOUT_LOCK</span> <span class="p">=</span> <span class="nc">PressureLock</span><span class="p">()</span>
  <span class="k">private</span> <span class="kd">val</span> <span class="py">CHANNEL_STDERR_LOCK</span> <span class="p">=</span> <span class="nc">PressureLock</span><span class="p">()</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">writePacket</span><span class="p">(</span><span class="n">buffer</span><span class="p">:</span> <span class="nc">Buffer</span><span class="p">):</span> <span class="nc">IoWriteFuture</span> <span class="p">{</span>
    <span class="c1">// The workaround for</span>
    <span class="c1">// https://issues.apache.org/jira/browse/SSHD-754</span>
    <span class="c1">// the trick is to block writer thread once there are more</span>
    <span class="c1">// than 100 messages in either rekey wait queue or nio write queue</span>
    <span class="kd">val</span> <span class="py">lock</span> <span class="p">=</span> <span class="k">when</span> <span class="p">(</span><span class="n">buffer</span><span class="p">.</span><span class="nf">array</span><span class="p">()[</span><span class="n">buffer</span><span class="p">.</span><span class="nf">rpos</span><span class="p">()])</span> <span class="p">{</span>
      <span class="nc">SshConstants</span><span class="p">.</span><span class="nc">SSH_MSG_CHANNEL_DATA</span> <span class="p">-&gt;</span> <span class="nc">CHANNEL_STDOUT_LOCK</span>
      <span class="nc">SshConstants</span><span class="p">.</span><span class="nc">SSH_MSG_CHANNEL_EXTENDED_DATA</span> <span class="p">-&gt;</span> <span class="nc">CHANNEL_STDERR_LOCK</span>
      <span class="k">else</span> <span class="p">-&gt;</span> <span class="k">null</span>
    <span class="p">}</span><span class="o">?.</span><span class="nf">acquire</span><span class="p">()</span>

    <span class="kd">val</span> <span class="py">future</span> <span class="p">=</span> <span class="k">super</span><span class="p">.</span><span class="nf">writePacket</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">lock</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">future</span><span class="p">.</span><span class="nf">addListener</span><span class="p">(</span><span class="n">lock</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">future</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>The code above is included in my inheritor of the <code class="language-plaintext highlighter-rouge">org.apache.sshd.common.session.AbstractSession</code>.
I like Apache Mina SSHD library is designed in an extensible way making such workaround possible.</p>

<p>And the <code class="language-plaintext highlighter-rouge">PressureLock</code> was implemented this way:</p>

<figure class="highlight"><pre><code class="language-kotlin" data-lang="kotlin"><span class="kd">class</span> <span class="nc">PressureLock</span> <span class="p">{</span>
  <span class="k">private</span> <span class="kd">val</span> <span class="py">semaphore</span> <span class="p">=</span> <span class="nc">Semaphore</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>

  <span class="k">private</span> <span class="kd">val</span> <span class="py">listener</span> <span class="p">=</span> <span class="kd">object</span> <span class="err">: </span><span class="nc">SshFutureListener</span><span class="p">&lt;</span><span class="nc">IoWriteFuture</span><span class="p">?&gt;</span> <span class="p">{</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">operationComplete</span><span class="p">(</span><span class="n">future</span><span class="p">:</span> <span class="nc">IoWriteFuture</span><span class="p">?)</span> <span class="p">{</span>
      <span class="n">semaphore</span><span class="p">.</span><span class="nf">release</span><span class="p">()</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">fun</span> <span class="nf">acquire</span><span class="p">()</span> <span class="p">:</span> <span class="nc">SshFutureListener</span><span class="p">&lt;</span><span class="nc">IoWriteFuture</span><span class="p">?&gt;</span> <span class="p">{</span>
    <span class="n">semaphore</span><span class="p">.</span><span class="nf">acquire</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">listener</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>I checked the fix with my tests. The problem was solved.</p>

<h1 id="putty-changes">Putty changes</h1>

<p>With integration tests, I was able to detect that it started 
to fail only with Putty 0.68. Putty 0.67 was working great. 
Also, all our problems were only from putty SSH clients on Windows.</p>

<p>I decided to dig dipper and see, that change was it. 
Sadly, there were so many changes between 0.67 and 0.68. 
Also, it took several years for them too.</p>

<p>I knew I was looking the change to windows size. I confirmed in debugger,
Putty 0.67 was using 16K for it.</p>

<p>And I found the change <a href="https://git.tartarus.org/?p=simon/putty.git;a=commit;h=b22c0b6f3e6f5254270a89f86df3edfc4da829d2">b22c0b6f3e6f5254270a89f86df3edfc4da829d2</a>
and the <a href="https://git.tartarus.org/?p=simon/putty.git;a=blobdiff;f=windows/winplink.c;h=99e269fdc106687e7edff5c51fb778ee22d545b7;hp=a0458b39a878b0ad8af99d9a7294e2129b3bf787;hb=b22c0b6f3e6f5254270a89f86df3edfc4da829d2;hpb=34add87ad249205d4ed36381bfb506a431dc0e7a">winplink.c file</a></p>

<figure class="highlight"><pre><code class="language-diff" data-lang="diff"><span class="gd">--- a/windows/winplink.c
</span><span class="gi">+++ b/windows/winplink.c
</span><span class="p">@@ -618,6 +618,17 @@</span> int main(int argc, char **argv)
        return 1;
     }
 
<span class="gi">+    /*
+     * Plink doesn't provide any way to add forwardings after the
+     * connection is set up, so if there are none now, we can safely set
+     * the "simple" flag.
+     */
+    if (conf_get_int(conf, CONF_protocol) == PROT_SSH &amp;&amp;
+       !conf_get_int(conf, CONF_x11_forward) &amp;&amp;
+       !conf_get_int(conf, CONF_agentfwd) &amp;&amp;
+       !conf_get_str_nthstrkey(conf, CONF_portfwd, 0))
+       conf_set_int(conf, CONF_ssh_simple, TRUE);
+</span></code></pre></figure>

<p>The change was to flip <code class="language-plaintext highlighter-rouge">CONF_ssh_simple</code> mode on Windows. The change 
did enable 2GB receive window, as you may see from the usages.</p>

<p>In <code class="language-plaintext highlighter-rouge">ssh.c</code> in <a href="https://the.earth.li/~sgtatham/putty/latest/putty-0.70.tar.gz">Putty 0.70</a> we have defines:</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="cp">#define OUR_V2_BIGWIN 0x7fffffff
#define OUR_V2_WINSIZE 16384</span></code></pre></figure>

<p>And the code-block:</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="k">static</span> <span class="kt">int</span> <span class="nf">ssh_is_simple</span><span class="p">(</span><span class="n">Ssh</span> <span class="n">ssh</span><span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/*
     * We use the 'simple' variant of the SSH protocol if we're asked
     * to, except not if we're also doing connection-sharing (either
     * tunnelling our packets over an upstream or expecting to be
     * tunnelled over ourselves), since then the assumption that we
     * have only one channel to worry about is not true after all.
     */</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">conf_get_int</span><span class="p">(</span><span class="n">ssh</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">,</span> <span class="n">CONF_ssh_simple</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
            <span class="o">!</span><span class="n">ssh</span><span class="o">-&gt;</span><span class="n">bare_connection</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ssh</span><span class="o">-&gt;</span><span class="n">connshare</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*
 * Set up most of a new ssh_channel.
 */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ssh_channel_init</span><span class="p">(</span><span class="k">struct</span> <span class="nc">ssh_channel</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Ssh</span> <span class="n">ssh</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">ssh</span><span class="p">;</span>
    <span class="n">c</span><span class="o">-&gt;</span><span class="n">localid</span> <span class="o">=</span> <span class="n">alloc_channel_id</span><span class="p">(</span><span class="n">ssh</span><span class="p">);</span>
    <span class="n">c</span><span class="o">-&gt;</span><span class="n">closes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">c</span><span class="o">-&gt;</span><span class="n">pending_eof</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">c</span><span class="o">-&gt;</span><span class="n">throttling_conn</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ssh</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">locwindow</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">locmaxwin</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">remlocwin</span> <span class="o">=</span>
	    <span class="n">ssh_is_simple</span><span class="p">(</span><span class="n">ssh</span><span class="p">)</span> <span class="o">?</span> <span class="n">OUR_V2_BIGWIN</span> <span class="o">:</span> <span class="n">OUR_V2_WINSIZE</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">chanreq_head</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">throttle_state</span> <span class="o">=</span> <span class="n">UNTHROTTLED</span><span class="p">;</span>
	<span class="n">bufchain_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">outbuffer</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">add234</span><span class="p">(</span><span class="n">ssh</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>The windows size is computed by the following expression:</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp">	<span class="n">c</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">locwindow</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">locmaxwin</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">v2</span><span class="p">.</span><span class="n">remlocwin</span> <span class="o">=</span>
	    <span class="n">ssh_is_simple</span><span class="p">(</span><span class="n">ssh</span><span class="p">)</span> <span class="o">?</span> <span class="n">OUR_V2_BIGWIN</span> <span class="o">:</span> <span class="n">OUR_V2_WINSIZE</span><span class="p">;</span></code></pre></figure>

<p>The windows sizes are exactly the same as I saw in debugger both for
<code class="language-plaintext highlighter-rouge">0.67</code> and <code class="language-plaintext highlighter-rouge">0.69</code> versions.</p>

<p>That was it. And it was in April 2016. It took more than a year 
for the change to cause the issues I was debugging.</p>

<p>Thanks to the opensource, I was able to dig that deep to see the source
of the problem. I liked it.</p>

<h1 id="conclusion">Conclusion</h1>

<p>I was running these SSH servers for more than a year. I like people 
say, ‘Hey, I did no changes to anything, why is it failing now?’</p>

<p>It was indeed the change. And the system started to fail. It was
the outer world that changed.</p>

<p>I found the source of the issue and did a patch to make the server
work again with new SSH clients. That was fun!</p>

        
      </div><!-- /.entry-content -->
    </div><!-- /.entry-wrapper -->
    <nav class="pagination" role="navigation">
      
        <a href="/blog/2017/08/09/test-runner/" class="btn" title="A Bash Test Runner for TeamCity">Previous</a>
      
      
        <a href="/blog/2017/10/18/java9c/" class="btn" title="A Gradle Plugin to Detect Package Conflicts for Migration to Java 9 Modules">Next</a>
      
    </nav><!-- /.pagination -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo" class="entry-wrapper">
    

<span>
  &copy; 2005—2026 Eugene Petrenko.
  <br />
  Unless otherwise noted, the content on the website is licensed under a
  <a href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a> license.
  <br />
  Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using
  the <a href="https://mademistakes.com/work/so-simple-jekyll-theme/" rel="nofollow">So Simple Theme</a>.
</span>
<div class="social-icons">
  <a href="https://x.com/jonnyzzz" title="Eugene Petrenko on X" target="_blank"><svg class="social-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg></a>
  <a href="https://linkedin.com/in/jonnyzzz" title="Eugene Petrenko on LinkedIn" target="_blank"><svg class="social-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 3a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14m-.5 15.5v-5.3a3.26 3.26 0 0 0-3.26-3.26c-.85 0-1.84.52-2.32 1.3v-1.11h-2.79v8.37h2.79v-4.93c0-.77.62-1.4 1.39-1.4a1.4 1.4 0 0 1 1.4 1.4v4.93h2.79M6.88 8.56a1.68 1.68 0 0 0 1.68-1.68c0-.93-.75-1.69-1.68-1.69a1.69 1.69 0 0 0-1.69 1.69c0 .93.76 1.68 1.69 1.68m1.39 9.94v-8.37H5.5v8.37h2.77z"/></svg></a>
  <a href="https://github.com/jonnyzzz" title="Eugene Petrenko on Github" target="_blank"><svg class="social-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33.85 0 1.71.11 2.5.33 1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2z"/></svg></a>
  <a href="/feed.xml" title="Atom/RSS feed"><svg class="social-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6.18 15.64a2.18 2.18 0 0 1 2.18 2.18C8.36 19 7.38 20 6.18 20C5 20 4 19 4 17.82a2.18 2.18 0 0 1 2.18-2.18M4 4.44A15.56 15.56 0 0 1 19.56 20h-2.83A12.73 12.73 0 0 0 4 7.27V4.44m0 5.66a9.9 9.9 0 0 1 9.9 9.9h-2.83A7.07 7.07 0 0 0 4 12.93V10.1z"/></svg></a>
</div><!-- /.social-icons -->

  </footer>
</div><!-- /.footer-wrapper -->

<script>
  // Open external links in new tab
  Array.from(document.links).forEach(link => {
    // For development: 0.0.0.0, localhost, 127.0.0.1 are all local
    const localHosts = ['localhost', '127.0.0.1', '0.0.0.0'];
    const linkIsLocal = localHosts.includes(link.hostname);
    const pageIsLocal = localHosts.includes(window.location.hostname);

    // Internal if: both are local dev hosts, or hostnames match exactly
    const isInternal = (linkIsLocal && pageIsLocal) ||
                       (link.hostname === window.location.hostname);

    if (!isInternal) {
      link.target = '_blank';
    }
  });
</script>


<!-- Google Analytics (gtag.js) -->
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('consent', 'default', {
    'ad_storage': 'denied',
    'ad_user_data': 'denied',
    'ad_personalization': 'denied',
    'analytics_storage': 'denied'
  });
</script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-BXXDX0ERFP"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-BXXDX0ERFP');
</script>
<!-- End Google Analytics -->




<!--SYNTAX HIGHLIGHTER - Lazy loads PrismJS only when code blocks are present-->
<script>
(function() {
  // Check if page has any code blocks that need highlighting
  if (!document.querySelector('pre code, code[class*="language-"]')) return;

  // Load CSS
  var cssFiles = [
    'https://cdn.jsdelivr.net/npm/prismjs@1.30.0/themes/prism.min.css',
    'https://cdn.jsdelivr.net/npm/prismjs@1.30.0/plugins/line-numbers/prism-line-numbers.min.css',
    'https://cdn.jsdelivr.net/npm/prismjs@1.30.0/plugins/toolbar/prism-toolbar.min.css'
  ];
  cssFiles.forEach(function(href) {
    var link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = href;
    document.head.appendChild(link);
  });

  // Load JS in sequence (core first, then plugins)
  var jsFiles = [
    'https://cdn.jsdelivr.net/npm/prismjs@1.30.0/components/prism-core.min.js',
    'https://cdn.jsdelivr.net/npm/prismjs@1.30.0/plugins/autoloader/prism-autoloader.min.js',
    'https://cdn.jsdelivr.net/npm/prismjs@1.30.0/plugins/line-numbers/prism-line-numbers.min.js',
    'https://cdn.jsdelivr.net/npm/prismjs@1.30.0/plugins/toolbar/prism-toolbar.min.js',
    'https://cdn.jsdelivr.net/npm/prismjs@1.30.0/plugins/show-language/prism-show-language.min.js',
    'https://cdn.jsdelivr.net/npm/prismjs@1.30.0/plugins/normalize-whitespace/prism-normalize-whitespace.min.js'
  ];

  function loadScript(index) {
    if (index >= jsFiles.length) {
      // All scripts loaded, highlight code
      if (window.Prism) Prism.highlightAll();
      return;
    }
    var script = document.createElement('script');
    script.src = jsFiles[index];
    script.onload = function() { loadScript(index + 1); };
    document.head.appendChild(script);
  }
  loadScript(0);
})();
</script>



</body>
</html>
