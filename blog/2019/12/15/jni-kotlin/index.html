<!doctype html>
<html class="no-js" lang="en">
<head>
<meta charset="utf-8" />
<title>JNI with Kotlin/Native &#8211; Eugene Petrenko</title>
<meta name="description" content="Kotlin both sides: Native and JVM"/>
<meta name="keywords" content="jonnyzzz, Евгений Петренко, Eugene Petrenko, jvm, java, kotlin, kotlin-native, jni, native" />


<!-- Twitter Cards -->
<meta name="twitter:title" content="JNI with Kotlin/Native -- Eugene Petrenko" />
<meta name="twitter:description" content="Kotlin both sides: Native and JVM" />
<meta name="twitter:site" content="@jonnyzzz" />
<meta name="twitter:creator" content="@jonnyzzz" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="https://jonnyzzz.com/images/me.jpg" />

<!-- Open Graph -->

<meta property="og:type" content="article" />
<meta property="og:image" content="https://jonnyzzz.com/images/me.jpg" />
<meta property="og:title" content="JNI with Kotlin/Native -- Eugene Petrenko" />
<meta property="og:description" content="Kotlin both sides: Native and JVM" />
<meta property="og:url" content="https://jonnyzzz.com/blog/2019/12/15/jni-kotlin/" />
<meta property="og:site_name" content="Eugene Petrenko" />

<meta property="article:tag" content="jonnyzzz" />

<meta property="article:tag" content="Евгений Петренко" />

<meta property="article:tag" content="Eugene Petrenko" />


<meta property="article:tag" content="jvm" />

<meta property="article:tag" content="java" />

<meta property="article:tag" content="kotlin" />

<meta property="article:tag" content="kotlin-native" />

<meta property="article:tag" content="jni" />

<meta property="article:tag" content="native" />



<!-- Webmaster Tools verfication -->
<meta name="google-site-verification" content="MJZCyfst2Tx4KyxbOIQu1fZyOSwA_JkQu73zJcfsl2g" />




<link rel="canonical" href="https://jonnyzzz.com/blog/2019/12/15/jni-kotlin/" />
<link href="https://feeds.feedburner.com/jonnyzzz" type="application/atom+xml" rel="alternate" title="ATOM Feed" />

<meta name="HandheldFriendly" content="True" />
<meta name="MobileOptimized" content="320" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css" />

<link rel="apple-touch-icon" sizes="57x57" href="/images/apple-icon-57x57.png" />
<link rel="apple-touch-icon" sizes="60x60" href="/images/apple-icon-60x60.png" />
<link rel="apple-touch-icon" sizes="72x72" href="/images/apple-icon-72x72.png" />
<link rel="apple-touch-icon" sizes="76x76" href="/images/apple-icon-76x76.png" />
<link rel="apple-touch-icon" sizes="114x114" href="/images/apple-icon-114x114.png" />
<link rel="apple-touch-icon" sizes="120x120" href="/images/apple-icon-120x120.png" />
<link rel="apple-touch-icon" sizes="144x144" href="/images/apple-icon-144x144.png" />
<link rel="apple-touch-icon" sizes="152x152" href="/images/apple-icon-152x152.png" />
<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-icon-180x180.png" />
<link rel="icon" type="image/png" sizes="192x192"  href="/images/android-icon-192x192.png" />
<link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png" />
<link rel="icon" type="image/png" sizes="96x96" href="/images/favicon-96x96.png" />
<link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png" />
<link rel="manifest" href="/images/manifest.json" />
<meta name="msapplication-TileColor" content="#ffffff" />
<meta name="msapplication-TileImage" content="/images/ms-icon-144x144.png" />
<meta name="theme-color" content="#ffffff" />

</head>

<body id="post">

<div class="navigation-wrapper">
	<nav role="navigation" id="site-nav">
	    <ul>
      
		    
		    <li><a href="/about/" >About</a></li>
		  
		    
		    <li><a href="/blog/" >Blog</a></li>
		  
		    
		    <li><a href="/projects/" >Projects</a></li>
		  
		    
		    <li><a href="/talks/" >Talks</a></li>
		  
		    
		    <li><a href="/tags/" >Tags</a></li>
		  
	    </ul>
	</nav>
</div><!-- /.navigation-wrapper -->

<header class="masthead">
	<div class="wrap">
      
      <h1 class="site-title"><a href="/">Eugene Petrenko</a></h1>
		<h2 class="site-description" itemprop="description">@jonnyzzz personal page and blog</h2>
	</div>
</header><!-- /.masthead -->

<div class="js-menu-screen menu-screen"></div>


<div id="main" role="main">
  <article class="hentry">
    
    <div class="entry-wrapper">
      <header class="entry-header">
        <ul class="entry-tags">
          <li><a href="/tags/#jvm" title="Pages tagged jvm">jvm</a></li><li><a href="/tags/#java" title="Pages tagged java">java</a></li><li><a href="/tags/#kotlin" title="Pages tagged kotlin">kotlin</a></li><li><a href="/tags/#kotlin-native" title="Pages tagged kotlin-native">kotlin-native</a></li><li><a href="/tags/#jni" title="Pages tagged jni">jni</a></li><li><a href="/tags/#native" title="Pages tagged native">native</a></li>
        </ul>
        
          <h1 class="entry-title">JNI with Kotlin/Native</h1>
        
      </header>
      <footer class="entry-meta">
        
        
          <img src="/images/me.jpg" class="bio-photo" alt="Eugene Petrenko bio photo"></a>
        
        <span class="author vcard">By <span class="fn">Eugene Petrenko</span></span>
        <span class="entry-date date published"><time datetime="2019-12-15T00:00:00+00:00"><i class="fa fa-calendar-o"></i> December 15, 2019</time></span>
        
        <span class="entry-comments"><i class="fa fa-comment-o"></i> <a href="#disqus_thread">Comment</a></span>
        <span class="social-share-twitter">
  <a href="https://twitter.com/intent/tweet?hashtags=jvm,java,kotlin,kotlin-native,jni,native&amp;text=JNI%20with%20Kotlin/Native&amp;url=https://jonnyzzz.com/blog/2019/12/15/jni-kotlin/&amp;via=jonnyzzz" title="Share on Twitter" itemprop="Twitter" target="_blank"><i class="fa fa-twitter-square"></i> Tweet</a>
</span>
<span class="social-share-facebook">
  <a href="https://www.facebook.com/sharer/sharer.php?u=https://jonnyzzz.com/blog/2019/12/15/jni-kotlin/" title="Share on Facebook" itemprop="Facebook" target="_blank"><i class="fa fa-facebook-square"></i> Like</a>
</span>

<!-- /.social-share -->

        
      </footer>
      <div class="entry-content">
        <p>Calling native code from our cosy JVM environment was and is possible. JVM comes with
the magical JNI APIs layer to make that. In this post we show how to use the JNI
from a Kotlin/JVM program and how to implement the native
counter-part with Kotlin/Native.</p>

<p>The example project contains several parts:</p>
<ul>
  <li>The JVM part (define a native method, load native library, call the API)</li>
  <li>The Native part (build as shared library, register callback in the JVM, have fun)</li>
</ul>

<h2 id="the-jvm-side">The JVM Side</h2>

<p>Let’s implement the JVM side in Kotlin. It will be enough to have the following code:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="nn">org.jonnyzzz.jni.java</span>

<span class="kd">class</span> <span class="nc">NativeHost</span> <span class="p">{</span>
  <span class="k">external</span> <span class="k">fun</span> <span class="nf">callInt</span><span class="p">(</span><span class="nv">x</span><span class="p">:</span> <span class="nc">Int</span><span class="p">)</span> <span class="p">:</span> <span class="nc">Int</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The <code class="highlighter-rouge">external</code> keyword in Kotlin is the same as the <code class="highlighter-rouge">native</code> keyword in Java. Both mean
the implementation of the method comes from the native library.</p>

<h2 id="the-kotlinnative-shared-library">The Kotlin/Native Shared Library</h2>

<p>The experiment was to use the same programming language to implement the native
part too. We use <a href="https://kotlinlang.org/docs/reference/native-overview.html">Kotlin/Native</a>
for that.</p>

<p>The second point to try Kotlin/Native is to use the
<a href="https://kotlinlang.org/docs/reference/multiplatform.html">Kotlin Multiplatform Programming</a>
to share some code between Native and JVM worlds. I will omit examples of that
in the current post.</p>

<p>JVM looks for specific symbol names to resolve native methods. We may find 
<a href="https://docs.oracle.com/en/java/javase/11/docs/specs/jni/design.html#resolving-native-method-names">the full spec</a>
in the documentation. The <code class="highlighter-rouge">callInt</code> function has the following symbol name:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">jint</span> <span class="n">Java_org_jonnyzzz_jni_java_NativeHost_callInt</span><span class="p">(</span><span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span>
                                                   <span class="n">jobject</span> <span class="n">obj</span><span class="p">,</span> 
                                                   <span class="n">jint</span> <span class="n">i</span><span class="p">);</span>
</code></pre></div></div>
<p>The first two parameters are added for all JNI calls. The <code class="highlighter-rouge">JNIEnv</code> allows
accessing the JVM to say create an object or throw an exception. We do
not need these parameters for our example, but we have to keep them for
binary compatibility. The function name in our example is generated
as follows:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Java_&lt;package name&gt;_&lt;class name&gt;_&lt;method_name&gt;
</code></pre></div></div>

<p>That encoding does not work for overloaded functions (there is on support for
overloads in C). The
<a href="https://docs.oracle.com/en/java/javase/11/docs/specs/jni/design.html#resolving-native-method-names">JNI specification</a>
defines how to create a longer names with mangling to overcome the limitation.</p>

<p>The following declaration in Kotlin/Native code
will implement it:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@CName</span><span class="p">(</span><span class="s">"Java_org_jonnyzzz_jni_java_NativeHost_callInt"</span><span class="p">)</span>
<span class="k">fun</span> <span class="nf">callInt</span><span class="p">(</span><span class="nv">env</span><span class="p">:</span> <span class="nc">CPointer</span><span class="p">&lt;</span><span class="nc">JNIEnvVar</span><span class="p">&gt;,</span> <span class="nv">clazz</span><span class="p">:</span> <span class="nc">jclass</span><span class="p">,</span> <span class="nv">it</span><span class="p">:</span> <span class="nc">jint</span><span class="p">):</span> <span class="nc">jint</span> <span class="p">{</span>
  <span class="n">initRuntimeIfNeeded</span><span class="p">()</span>
  <span class="n">Platform</span><span class="p">.</span><span class="n">isMemoryLeakCheckerActive</span> <span class="p">=</span> <span class="k">false</span>

  <span class="n">println</span><span class="p">(</span><span class="s">"Native function is executed with: $it"</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">it</span> <span class="p">+</span> <span class="m">1</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Here we use the <code class="highlighter-rouge">@CName</code> annotation to instruct
<a href="https://kotlinlang.org/docs/reference/native/c_interop.html">the cinterop</a>
to export the function as a symbol of the shared library.</p>

<h2 id="the-c-interop-setup">The C interop Setup</h2>

<p>The example above requires a project setup to work. 
We need to import the <code class="highlighter-rouge">jni.h</code> header into Kotlin/Native.
<a href="https://kotlinlang.org/docs/reference/native/c_interop.html">The cinterop</a>
tool helps us to generate Kotlin code from a C library definitions.</p>

<h2 id="the-project-setup">The Project Setup</h2>

<p>Before we jump into the native world, let’s create a project. We’ll use Gradle project,
written in Kotlin. You may <a href="https://github.com/jonnyzzz/kotlin-jni-mix">see the code</a> from
my GitHub or create a new one from a scratch. It will the
<a href="https://kotlinlang.org/docs/reference/building-mpp-with-gradle.html">kotlin multiplatform</a> plugin.</p>

<p>The initial project setup in a <code class="highlighter-rouge">build.gradle.kts</code> file could look like that:</p>
<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plugins</span> <span class="p">{</span>
  <span class="n">kotlin</span><span class="p">(</span><span class="s">"multiplatform"</span><span class="p">)</span> <span class="n">version</span> <span class="s">"1.3.61"</span>
<span class="p">}</span>

<span class="n">repositories</span> <span class="p">{</span>
  <span class="n">mavenCentral</span><span class="p">()</span>
<span class="p">}</span>

<span class="n">kotlin</span> <span class="p">{</span>
  <span class="n">jvm</span><span class="p">()</span>

  <span class="n">macosX64</span><span class="p">(</span><span class="s">"native"</span><span class="p">)</span> <span class="p">{</span><span class="o">..</span><span class="p">}</span> <span class="c1">// see below</span>

  <span class="n">sourceSets</span><span class="p">[</span><span class="s">"jvmMain"</span><span class="p">].</span><span class="n">dependencies</span> <span class="p">{</span>
    <span class="n">implementation</span><span class="p">(</span><span class="n">kotlin</span><span class="p">(</span><span class="s">"stdlib-jdk8"</span><span class="p">))</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The <code class="highlighter-rouge">macosX64</code> block defined the macOS shared library target. Rename it to
<code class="highlighter-rouge">mingwX64</code> for Windows, and <code class="highlighter-rouge">linuxX64</code> for Linux. Find more explanations on that
<a href="https://kotlinlang.org/docs/tutorials/native/dynamic-libraries.html">in the tutorial</a>
for Kotlin/Native. We use <a href="https://twitter.com/jonnyzzz/status/1206242931058892802?s=20">a script</a>
in the example repository to avoid manual configuration need.</p>

<p>We use the Kotlin/Native’s <code class="highlighter-rouge">cinterop</code> tool to import the <code class="highlighter-rouge">jni.h</code> declarations to Kotlin, 
e.g  <code class="highlighter-rouge">JNIEnv</code> or <code class="highlighter-rouge">jint</code> symbols. The whole script looks like that:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  macosX64("native") { // use linuxX64 or mingwX64 on other OS
    binaries {
      sharedLib()
    }

    compilations["main"].cinterops.create("jni") {
      val javaHome = File(System.getProperty("java.home")!!)
      packageName = "org.jonnyzzz.jni"
      includeDirs(
              Callable { File(javaHome, "include") },
              Callable { File(javaHome, "include/darwin") },
              Callable { File(javaHome, "include/linux") },
              Callable { File(javaHome, "include/win32") }
      )
    }
  }
</code></pre></div></div>

<p>The <code class="highlighter-rouge">src/nativeInterop/cinterop/jni.def</code> file contains the definitions for the c interop, 
it should container the only one line to instruct the interop tool what headers to use:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>headers = jni.h
</code></pre></div></div>

<h2 id="putting-all-together">Putting all Together</h2>

<p>The example is ready. We use Kotlin/JVM to talk to Kotlin/Native in the same project.
The project sources are <a href="https://github.com/jonnyzzz/kotlin-jni-mix">on my GitHub</a>, 
try it, open in IntelliJ and have fun.</p>

<p>You’ll have the following code in the console:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  kotlin-jni-mix git:(master) ✗ ./gradlew run

&gt; Configure project :
Kotlin Multiplatform Projects are an experimental feature.

&gt; Task :linkDebugSharedNative
Produced library API in libkotlin_jni_mix_api.h

&gt; Task :linkReleaseSharedNative
Produced library API in libkotlin_jni_mix_api.h

&gt; Task :run
Native function is executed with: 42
ret from the native: 43
</code></pre></div></div>

        
          <div id="disqus_thread"></div><!-- /#disqus_thread -->
          
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'jonnyzzz'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

        
      </div><!-- /.entry-content -->
    </div><!-- /.entry-wrapper -->
    <nav class="pagination" role="navigation">
      
        <a href="/blog/2019/06/25/gradle-kotlin-migration-4/" class="btn" title="Migrating to Gradle Kotlin DSL - Groovy Closure">Previous</a>
      
      
        <a href="/blog/2020/04/06/delegated-property/" class="btn" title="Delegated Properties in Kotlin">Next</a>
      
    </nav><!-- /.pagination -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo" class="entry-wrapper">
    

<span>
  &copy; 2005—2025 Eugene Petrenko.
  <br />
  Unless otherwise noted, the content on the website is licensed under a
  <a href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a> license.
  <br />
  Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using
  the <a href="https://mademistakes.com/work/so-simple-jekyll-theme/" rel="nofollow">So Simple Theme</a>.
</span>
<div class="social-icons">
	<a href="https://twitter.com/jonnyzzz" title="Eugene Petrenko on Twitter" target="_blank"><i class="fa fa-twitter-square fa-2x"></i></a>
	<a href="https://facebook.com/jonnyzzz" title="Eugene Petrenko on Facebook" target="_blank"><i class="fa fa-facebook-square fa-2x"></i></a>
	
	<a href="https://linkedin.com/in/jonnyzzz" title="Eugene Petrenko on LinkedIn" target="_blank"><i class="fa fa-linkedin-square fa-2x"></i></a>
	<a href="http://stackoverflow.com/users/49811/eugene-petrenko" title="Eugene Petrenko on StackExchange" target="_blank"><i class="fa fa-stack-exchange fa-2x"></i></a>
	<a href="https://instagram.com/jonnyzzz" title="Eugene Petrenko on Instagram" target="_blank"><i class="fa fa-instagram fa-2x"></i></a>
	<a href="https://www.flickr.com/photos/_jonny_" title="Eugene Petrenko on Flickr" target="_blank"><i class="fa fa-flickr fa-2x"></i></a>
	<a href="https://github.com/jonnyzzz" title="Eugene Petrenko on Github" target="_blank"><i class="fa fa-github-square fa-2x"></i></a>
	
  <a href="https://www.pinterest.com/jonnyzzz/" title="Eugene Petrenko on Pinterest" target="_blank"><i class="fa fa-pinterest fa-2x"></i></a>
	
  <a href="https://feeds.feedburner.com/jonnyzzz" title="Atom/RSS feed"><i class="fa fa-rss-square fa-2x"></i></a>
</div><!-- /.social-icons -->

  </footer>
</div><!-- /.footer-wrapper -->

<script type="text/javascript">
  var BASE_URL = '';
</script>

<script>
  // use links _blank by default
  Array.from(document.links).forEach(link => {
    if (link.hostname !== window.location.hostname) {
      link.target = '_blank';
    }
  });
</script>


<!-- Google Analytics (gtag.js) -->
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('consent', 'default', {
    'ad_storage': 'denied',
    'ad_user_data': 'denied',
    'ad_personalization': 'denied',
    'analytics_storage': 'denied'
  });
</script>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-70104598-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-70104598-1');
</script>
<!-- End Google Analytics -->





<!--SYNTAX HIGHLIGHTER BEGINS-->
<!-- see https://prismjs.com/ download generator -->
<link rel="stylesheet" href="/assets/prismjs/prism.css"/>

<script src="/assets/prismjs/prism.js" ></script>

<!--SYNTAX HIGHLIGHTER ENDS-->



</body>
</html>
