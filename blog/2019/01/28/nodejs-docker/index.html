<!doctype html>
<html class="no-js" lang="en">
<head>
<meta charset="utf-8" />
<title>Nodejs Builds &#8211; Eugene Petrenko</title>
<meta name="description" content="A build script to build a client-side web application in Docker

"/>
<meta name="keywords" content="jonnyzzz, Евгений Петренко, Eugene Petrenko, docker, javascript, nodejs, webpack, build" />


<!-- Twitter Cards -->
<meta name="twitter:title" content="Nodejs Builds -- Eugene Petrenko" />
<meta name="twitter:description" content="A build script to build a client-side web application in Docker

" />
<meta name="twitter:site" content="@jonnyzzz" />
<meta name="twitter:creator" content="@jonnyzzz" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="https://jonnyzzz.com/images/me.jpg" />

<!-- Open Graph -->

<meta property="og:type" content="article" />
<meta property="og:image" content="https://jonnyzzz.com/images/me.jpg" />
<meta property="og:title" content="Nodejs Builds -- Eugene Petrenko" />
<meta property="og:description" content="A build script to build a client-side web application in Docker

" />
<meta property="og:url" content="https://jonnyzzz.com/blog/2019/01/28/nodejs-docker/" />
<meta property="og:site_name" content="Eugene Petrenko" />

<meta property="article:tag" content="jonnyzzz" />

<meta property="article:tag" content="Евгений Петренко" />

<meta property="article:tag" content="Eugene Petrenko" />


<meta property="article:tag" content="docker" />

<meta property="article:tag" content="javascript" />

<meta property="article:tag" content="nodejs" />

<meta property="article:tag" content="webpack" />

<meta property="article:tag" content="build" />



<!-- Webmaster Tools verfication -->
<meta name="google-site-verification" content="MJZCyfst2Tx4KyxbOIQu1fZyOSwA_JkQu73zJcfsl2g" />




<link rel="canonical" href="https://jonnyzzz.com/blog/2019/01/28/nodejs-docker/" />
<link href="https://feeds.feedburner.com/jonnyzzz" type="application/atom+xml" rel="alternate" title="ATOM Feed" />

<meta name="HandheldFriendly" content="True" />
<meta name="MobileOptimized" content="320" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css" />

<link rel="apple-touch-icon" sizes="57x57" href="/images/apple-icon-57x57.png" />
<link rel="apple-touch-icon" sizes="60x60" href="/images/apple-icon-60x60.png" />
<link rel="apple-touch-icon" sizes="72x72" href="/images/apple-icon-72x72.png" />
<link rel="apple-touch-icon" sizes="76x76" href="/images/apple-icon-76x76.png" />
<link rel="apple-touch-icon" sizes="114x114" href="/images/apple-icon-114x114.png" />
<link rel="apple-touch-icon" sizes="120x120" href="/images/apple-icon-120x120.png" />
<link rel="apple-touch-icon" sizes="144x144" href="/images/apple-icon-144x144.png" />
<link rel="apple-touch-icon" sizes="152x152" href="/images/apple-icon-152x152.png" />
<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-icon-180x180.png" />
<link rel="icon" type="image/png" sizes="192x192"  href="/images/android-icon-192x192.png" />
<link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png" />
<link rel="icon" type="image/png" sizes="96x96" href="/images/favicon-96x96.png" />
<link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png" />
<link rel="manifest" href="/images/manifest.json" />
<meta name="msapplication-TileColor" content="#ffffff" />
<meta name="msapplication-TileImage" content="/images/ms-icon-144x144.png" />
<meta name="theme-color" content="#ffffff" />

</head>

<body id="post">

<div class="navigation-wrapper">
	<nav role="navigation" id="site-nav">
	    <ul>
      
		    
		    <li><a href="/about/" >About</a></li>
		  
		    
		    <li><a href="/blog/" >Blog</a></li>
		  
		    
		    <li><a href="/projects/" >Projects</a></li>
		  
		    
		    <li><a href="/talks/" >Talks</a></li>
		  
		    
		    <li><a href="/tags/" >Tags</a></li>
		  
	    </ul>
	</nav>
</div><!-- /.navigation-wrapper -->

<header class="masthead">
	<div class="wrap">
      
      <h1 class="site-title"><a href="/">Eugene Petrenko</a></h1>
		<h2 class="site-description" itemprop="description">@jonnyzzz personal page and blog</h2>
	</div>
</header><!-- /.masthead -->

<div class="js-menu-screen menu-screen"></div>


<div id="main" role="main">
  <article class="hentry">
    
    <div class="entry-wrapper">
      <header class="entry-header">
        <ul class="entry-tags">
          <li><a href="/tags/#docker" title="Pages tagged docker">docker</a></li><li><a href="/tags/#javascript" title="Pages tagged javascript">javascript</a></li><li><a href="/tags/#nodejs" title="Pages tagged nodejs">nodejs</a></li><li><a href="/tags/#webpack" title="Pages tagged webpack">webpack</a></li><li><a href="/tags/#build" title="Pages tagged build">build</a></li>
        </ul>
        
          <h1 class="entry-title">Nodejs Builds</h1>
        
      </header>
      <footer class="entry-meta">
        
        
          <img src="/images/me.jpg" class="bio-photo" alt="Eugene Petrenko bio photo"></a>
        
        <span class="author vcard">By <span class="fn">Eugene Petrenko</span></span>
        <span class="entry-date date published"><time datetime="2019-01-28T00:00:00+00:00"><i class="fa fa-calendar-o"></i> January 28, 2019</time></span>
        
        <span class="entry-comments"><i class="fa fa-comment-o"></i> <a href="#disqus_thread">Comment</a></span>
        <span class="social-share-twitter">
  <a href="https://twitter.com/intent/tweet?hashtags=docker,javascript,nodejs,webpack,build&amp;text=Nodejs%20Builds&amp;url=https://jonnyzzz.com/blog/2019/01/28/nodejs-docker/&amp;via=jonnyzzz" title="Share on Twitter" itemprop="Twitter" target="_blank"><i class="fa fa-twitter-square"></i> Tweet</a>
</span>
<span class="social-share-facebook">
  <a href="https://www.facebook.com/sharer/sharer.php?u=https://jonnyzzz.com/blog/2019/01/28/nodejs-docker/" title="Share on Facebook" itemprop="Facebook" target="_blank"><i class="fa fa-facebook-square"></i> Like</a>
</span>

<!-- /.social-share -->

        
      </footer>
      <div class="entry-content">
        <p>A build script to build a client-side web application in Docker</p>

<p>It was a challenge. I decided to try to create a web page to demo my HTTP API endpoint. I set myself a goal:
if I do a prototype in 1 hour - I’ll have it for my project. I made it in 1.5 hours thou. 
It will be another story, how I made it deployed (and it include AWS, Terraform, and gotchas). This time,
let’s focus on Node and NPM.</p>

<h2 id="backgrounds">Backgrounds</h2>

<p>The best for a hackathon like projects, when the time is limited, it to get the goal done. 
Surprise, it is not always the super-duper technology, or programming language. 
For me it was obvious - I need to make the site to demo the API endpoint.
Technology stack is up to me.</p>

<p>The time is limited. Pick a technology you know the best. Pick an option, you most
confident with. It is tricky, again, it should be technology that makes <em>goals</em> achievable 
faster. It is not the technology you know, but you cannot make it.</p>

<p>I’m not a web developer professional. I had nothing to pick from.</p>

<p>Ask an expert if you are doubts. <a href="https://www.linkedin.com/in/andrey-skladchikov-94336416a">Andrey</a>
suggested using <a href="https://jetbrains.github.io/ring-ui/master/index.html">Ring UI</a>
library. Right now I’m happy I decided using the library. Frankly, I like the way <a href="https://reactjs.org">React</a>
approaches to web pages.</p>

<p>The best part - Ring UI comes with the generator, the generator generates an alive skeleton
for the website. Now one can start, debug, and build the site. That is it. Of course,
<a href="https://nodejs.org">Node JS</a> is required on the machine. Awesome! I use <a href="https://jetbrains.com/idea">IntelliJ IDEA</a>
with the <a href="https://plugins.jetbrains.com/plugin/6098-nodejs">Node JS Plugin</a> to develop it.</p>

<h2 id="building">Building</h2>

<p>Back from the old days, I remember how painful it can be to build a web site
if you do not have right tooling on your machine. One needs similar tooling for
the CI builds too!</p>

<p>So I wrote few bash scripts to automate it for me. I use Docker image with Node JS. It helps a lot!</p>

<h3 id="dockerfile">Dockerfile</h3>

<p>The <code class="highlighter-rouge">Dockerfile</code>:</p>

<div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">FROM</span><span class="s"> node:11</span>

<span class="k">RUN </span>apt-get update <span class="o">&amp;&amp;</span> apt-get <span class="nb">install</span> <span class="nt">-y</span> rsync

<span class="k">RUN </span><span class="nb">mkdir</span> /build /build-src

<span class="k">COPY</span><span class="s"> package.json package-lock.json /build/</span>
<span class="k">RUN </span><span class="nb">cd</span> /build <span class="o">&amp;&amp;</span> npm <span class="nb">install</span>
</code></pre></div></div>

<p>All we need to build the project - is an environment with Node, NPM and warm <code class="highlighter-rouge">node_modules</code>. Let’s do it!
The <code class="highlighter-rouge">Dockerfile</code> uses <code class="highlighter-rouge">node:11</code> as the base image to have Node and NPM. Next, we add current <code class="highlighter-rouge">package.json</code>
to install <code class="highlighter-rouge">node_modules</code>. Now <code class="highlighter-rouge">node_modules</code> and NPM caches are pre-packed into the container!</p>

<h3 id="building-1">Building</h3>

<p>As you see from the <code class="highlighter-rouge">Dockerfile</code>, we have <code class="highlighter-rouge">node_modules</code> created in the <code class="highlighter-rouge">/build/</code> folder. Now we need
project sources to be in the folder to run the true build. We must not mix <code class="highlighter-rouge">node_modules</code> from the 
host computer with <code class="highlighter-rouge">node_modules</code> from our Docker container. The fact is, you may have OS-specific binaries
under <code class="highlighter-rouge">node_modules</code>, and it may not play nice if you mix them.</p>

<p>We mount original project sources under <code class="highlighter-rouge">/build-src/</code> folder in docker. We assume the build will
share the compiled site into <code class="highlighter-rouge">/build-dist/</code> folder. I use the following script to make it.</p>

<p>The <code class="highlighter-rouge">build-container.sh</code>:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="nb">set</span> <span class="nt">-e</span> <span class="nt">-x</span> <span class="nt">-u</span>


<span class="c">## copy sources into the right folder</span>
rsync <span class="nt">-ai</span> <span class="nt">--delete</span> <span class="nt">--progress</span> /build-src/ /build/ <span class="nt">--exclude</span> node_modules

<span class="c">## do the build</span>
<span class="nb">cd</span> /build
npm run build

<span class="c">## copy results back</span>
rsync <span class="nt">-ai</span> <span class="nt">--delete</span> <span class="nt">--progress</span> /build/dist/  /build-dist/

</code></pre></div></div>

<h3 id="running-in-the-container">Running in the Container</h3>

<p>Let’s start the build in the container. For that, I have the following script.</p>

<p><code class="highlighter-rouge">build.sh</code></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="nv">DIR</span><span class="o">=</span><span class="s2">"</span><span class="k">$(</span> <span class="nb">cd</span> <span class="s2">"</span><span class="k">$(</span> <span class="nb">dirname</span> <span class="s2">"</span><span class="k">${</span><span class="nv">BASH_SOURCE</span><span class="p">[0]</span><span class="k">}</span><span class="s2">"</span> <span class="k">)</span><span class="s2">"</span> <span class="o">&amp;&amp;</span> <span class="nb">pwd</span> <span class="k">)</span><span class="s2">"</span>
<span class="nb">set</span> <span class="nt">-e</span> <span class="nt">-x</span> <span class="nt">-u</span>

<span class="nv">IMAGE</span><span class="o">=</span>project-node-js

docker build <span class="nt">--tag</span> <span class="k">${</span><span class="nv">IMAGE</span><span class="k">}</span> <span class="nb">.</span>

<span class="nv">ROOT</span><span class="o">=</span><span class="s2">"</span><span class="k">$(</span><span class="nb">cd</span> <span class="nv">$DIR</span> <span class="o">&amp;&amp;</span> <span class="nb">pwd</span><span class="k">)</span><span class="s2">"</span>
<span class="nv">DIST</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">ROOT</span><span class="k">}</span><span class="s2">/dist"</span>

<span class="nb">rm</span> <span class="nt">-rf</span> <span class="k">${</span><span class="nv">DIST</span><span class="k">}</span>

docker run <span class="nt">-it</span> <span class="nt">--rm</span> <span class="se">\</span>
     <span class="nt">-v</span> <span class="k">${</span><span class="nv">ROOT</span><span class="k">}</span>:/build-src:ro <span class="se">\</span>
     <span class="nt">-v</span> <span class="k">${</span><span class="nv">DIST</span><span class="k">}</span>:/build-dist <span class="se">\</span>
     <span class="k">${</span><span class="nv">IMAGE</span><span class="k">}</span> /build-src/build-container.sh
</code></pre></div></div>

<p>You also need to add the host <code class="highlighter-rouge">node_modules</code> to the <code class="highlighter-rouge">.dockerignore</code> file. It will make <code class="highlighter-rouge">docker build</code> command
to run faster.</p>

<p>The first step - we build the docker container from the <code class="highlighter-rouge">Dockerfile</code>. Docker does incremental
builds for us. A change in <code class="highlighter-rouge">package.json</code> will trigger the container rebuild. Without changes in <code class="highlighter-rouge">package.json</code>,
it will do nothing pretty fast.</p>

<p>The second step - we run the build in the container.</p>

<p>It may be necessary to fix permissions of the files, that you have under the <code class="highlighter-rouge">${DIST}</code> folder on Linux.
That is not needed for builds on Mac, and I assume on Windows.</p>

<h2 id="conclusion">Conclusion</h2>

<p>Now I have a build script for my project. One needs only Docker to build the project. It is essential,
the version of Node is hard-coded in the build scripts, we will need to changes to the environment what it
changes. The CI builds simplified too! We have no duplication between local builds and CI builds. 
Everyone calls the same <code class="highlighter-rouge">build.sh</code> file to make it.</p>

<p>Do you like to try that? Here is a small exercise for you - add the development web server support into the scripts. 
I’ll be happy to see your code and update that post.</p>


        
          <div id="disqus_thread"></div><!-- /#disqus_thread -->
          
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'jonnyzzz'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

        
      </div><!-- /.entry-content -->
    </div><!-- /.entry-wrapper -->
    <nav class="pagination" role="navigation">
      
        <a href="/blog/2019/01/14/kn-intptr/" class="btn" title="Int ptr in Kotlin/Native">Previous</a>
      
      
        <a href="/blog/2019/02/04/companion-and-object/" class="btn" title="JVM Bytecode for Kotlin Object and Companion Object">Next</a>
      
    </nav><!-- /.pagination -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo" class="entry-wrapper">
    

<span>
  &copy; 2005—2025 Eugene Petrenko.
  <br />
  Unless otherwise noted, the content on the website is licensed under a
  <a href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a> license.
  <br />
  Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using
  the <a href="https://mademistakes.com/work/so-simple-jekyll-theme/" rel="nofollow">So Simple Theme</a>.
</span>
<div class="social-icons">
	<a href="https://twitter.com/jonnyzzz" title="Eugene Petrenko on Twitter" target="_blank"><i class="fa fa-twitter-square fa-2x"></i></a>
	<a href="https://facebook.com/jonnyzzz" title="Eugene Petrenko on Facebook" target="_blank"><i class="fa fa-facebook-square fa-2x"></i></a>
	
	<a href="https://linkedin.com/in/jonnyzzz" title="Eugene Petrenko on LinkedIn" target="_blank"><i class="fa fa-linkedin-square fa-2x"></i></a>
	<a href="http://stackoverflow.com/users/49811/eugene-petrenko" title="Eugene Petrenko on StackExchange" target="_blank"><i class="fa fa-stack-exchange fa-2x"></i></a>
	<a href="https://instagram.com/jonnyzzz" title="Eugene Petrenko on Instagram" target="_blank"><i class="fa fa-instagram fa-2x"></i></a>
	<a href="https://www.flickr.com/photos/_jonny_" title="Eugene Petrenko on Flickr" target="_blank"><i class="fa fa-flickr fa-2x"></i></a>
	<a href="https://github.com/jonnyzzz" title="Eugene Petrenko on Github" target="_blank"><i class="fa fa-github-square fa-2x"></i></a>
	
  <a href="https://www.pinterest.com/jonnyzzz/" title="Eugene Petrenko on Pinterest" target="_blank"><i class="fa fa-pinterest fa-2x"></i></a>
	
  <a href="https://feeds.feedburner.com/jonnyzzz" title="Atom/RSS feed"><i class="fa fa-rss-square fa-2x"></i></a>
</div><!-- /.social-icons -->

  </footer>
</div><!-- /.footer-wrapper -->

<script type="text/javascript">
  var BASE_URL = '';
</script>

<script>
  // use links _blank by default
  Array.from(document.links).forEach(link => {
    if (link.hostname !== window.location.hostname) {
      link.target = '_blank';
    }
  });
</script>


<!-- Google Analytics (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-70104598-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-70104598-1');
</script>
<!-- End Google Analytics -->





<!--SYNTAX HIGHLIGHTER BEGINS-->
<!-- see https://prismjs.com/ download generator -->
<link rel="stylesheet" href="/assets/prismjs/prism.css"/>

<script src="/assets/prismjs/prism.js" ></script>

<!--SYNTAX HIGHLIGHTER ENDS-->



</body>
</html>
