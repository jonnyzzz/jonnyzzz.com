<!doctype html>
<html class="no-js" lang="en">
<head>
<meta charset="utf-8" />
<title>Security Group for CloudFront &#8211; Eugene Petrenko</title>
<meta name="description" content="CloudFront IP addresses in AWS Security Group"/>
<meta name="keywords" content="jonnyzzz, Евгений Петренко, Eugene Petrenko, aws, security-group, infrastructure, terraform, devops, clouds" />


<!-- Twitter Cards -->
<meta name="twitter:title" content="Security Group for CloudFront -- Eugene Petrenko" />
<meta name="twitter:description" content="CloudFront IP addresses in AWS Security Group" />
<meta name="twitter:site" content="@jonnyzzz" />
<meta name="twitter:creator" content="@jonnyzzz" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="https://jonnyzzz.com/images/me.jpg" />

<!-- Open Graph -->

<meta property="og:type" content="article" />
<meta property="og:image" content="https://jonnyzzz.com/images/me.jpg" />
<meta property="og:title" content="Security Group for CloudFront -- Eugene Petrenko" />
<meta property="og:description" content="CloudFront IP addresses in AWS Security Group" />
<meta property="og:url" content="https://jonnyzzz.com/blog/2019/03/26/terraform-cloudfront-sg/" />
<meta property="og:site_name" content="Eugene Petrenko" />

<meta property="article:tag" content="jonnyzzz" />

<meta property="article:tag" content="Евгений Петренко" />

<meta property="article:tag" content="Eugene Petrenko" />


<meta property="article:tag" content="aws" />

<meta property="article:tag" content="security-group" />

<meta property="article:tag" content="infrastructure" />

<meta property="article:tag" content="terraform" />

<meta property="article:tag" content="devops" />

<meta property="article:tag" content="clouds" />



<!-- Webmaster Tools verfication -->
<meta name="google-site-verification" content="MJZCyfst2Tx4KyxbOIQu1fZyOSwA_JkQu73zJcfsl2g" />




<link rel="canonical" href="https://jonnyzzz.com/blog/2019/03/26/terraform-cloudfront-sg/" />
<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="ATOM Feed" />

<meta name="HandheldFriendly" content="True" />
<meta name="MobileOptimized" content="320" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css" />

<link rel="apple-touch-icon" sizes="57x57" href="/images/apple-icon-57x57.png" />
<link rel="apple-touch-icon" sizes="60x60" href="/images/apple-icon-60x60.png" />
<link rel="apple-touch-icon" sizes="72x72" href="/images/apple-icon-72x72.png" />
<link rel="apple-touch-icon" sizes="76x76" href="/images/apple-icon-76x76.png" />
<link rel="apple-touch-icon" sizes="114x114" href="/images/apple-icon-114x114.png" />
<link rel="apple-touch-icon" sizes="120x120" href="/images/apple-icon-120x120.png" />
<link rel="apple-touch-icon" sizes="144x144" href="/images/apple-icon-144x144.png" />
<link rel="apple-touch-icon" sizes="152x152" href="/images/apple-icon-152x152.png" />
<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-icon-180x180.png" />
<link rel="icon" type="image/png" sizes="192x192"  href="/images/android-icon-192x192.png" />
<link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png" />
<link rel="icon" type="image/png" sizes="96x96" href="/images/favicon-96x96.png" />
<link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png" />
<link rel="manifest" href="/images/manifest.json" />
<meta name="msapplication-TileColor" content="#ffffff" />
<meta name="msapplication-TileImage" content="/images/ms-icon-144x144.png" />
<meta name="theme-color" content="#ffffff" />

</head>

<body id="post">

<div class="navigation-wrapper">
	<nav role="navigation" id="site-nav">
	    <ul>
      
		    <li><a href="/" >Home</a></li>
		  
		    <li><a href="/about/" >About</a></li>
		  
		    <li><a href="/blog/" >Blog</a></li>
		  
		    <li><a href="/projects/" >Projects</a></li>
		  
		    <li><a href="/talks/" >Talks</a></li>
		  
		    <li><a href="/tags/" >Tags</a></li>
		  
	    </ul>
	</nav>
</div><!-- /.navigation-wrapper -->

<header class="masthead">
	<div class="wrap">
      
      <h1 class="site-title"><a href="/">Eugene Petrenko</a></h1>
		<h2 class="site-description" itemprop="description">Founding Engineering Leader | Agentic AI DevTools & Experience</h2>
	</div>
</header><!-- /.masthead -->


<div id="main" role="main">
  <article class="hentry">
    
    <div class="entry-wrapper">
      <header class="entry-header">
        <ul class="entry-tags">
          <li><a href="/tags/#aws" title="Pages tagged aws">aws</a></li><li><a href="/tags/#security-group" title="Pages tagged security-group">security-group</a></li><li><a href="/tags/#infrastructure" title="Pages tagged infrastructure">infrastructure</a></li><li><a href="/tags/#terraform" title="Pages tagged terraform">terraform</a></li><li><a href="/tags/#devops" title="Pages tagged devops">devops</a></li><li><a href="/tags/#clouds" title="Pages tagged clouds">clouds</a></li>
        </ul>
        
          <h1 class="entry-title">Security Group for CloudFront</h1>
        
      </header>
      <footer class="entry-meta">
        
        
          <img src="/images/me.jpg" class="bio-photo" alt="Eugene Petrenko bio photo"></a>
        
        <span class="author vcard">By <span class="fn">Eugene Petrenko</span></span>
        <span class="entry-date date published"><time datetime="2019-03-26T00:00:00+00:00">March 26, 2019</time></span>
        
        
        <span class="social-share-x">
  <a href="https://x.com/intent/tweet?hashtags=aws,security-group,infrastructure,terraform,devops,clouds&amp;text=Security%20Group%20for%20CloudFront&amp;url=https://jonnyzzz.com/blog/2019/03/26/terraform-cloudfront-sg/&amp;via=jonnyzzz" title="Share on X" itemprop="X" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="14" height="14" style="vertical-align: middle; fill: currentColor;"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg> Post</a>
</span>
<span class="social-share-facebook">
  <a href="https://www.facebook.com/sharer/sharer.php?u=https://jonnyzzz.com/blog/2019/03/26/terraform-cloudfront-sg/" title="Share on Facebook" itemprop="Facebook" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="14" height="14" style="vertical-align: middle; fill: currentColor;"><path d="M22 12c0-5.52-4.48-10-10-10S2 6.48 2 12c0 4.84 3.44 8.87 8 9.8V15H8v-3h2V9.5C10 7.57 11.57 6 13.5 6H16v3h-2c-.55 0-1 .45-1 1v2h3v3h-3v6.95c5.05-.5 9-4.76 9-9.95z"/></svg> Like</a>
</span>
<!-- /.social-share -->

      </footer>
      <div class="entry-content">
        <p>Have you ever tried to set up a Security Group
to allow access only from CloudFront IP
addresses? One Security Group will not be enough.
We’ll see how to use <a href="https://www.terraform.io/">Terraform</a>
to solve and to automate this task.</p>

<h2 id="the-application">The Application</h2>

<p>We have a traditional application on <a href="https://aws.amazon.com">AWS</a>, where
a <a href="https://aws.amazon.com/cloudfront/">CloudFront</a> distribution handles
the incoming traffic.
Behind it, we have static pages on
<a href="https://aws.amazon.com/s3">S3</a> and API endpoints
behind <a href="https://aws.amazon.com/elasticloadbalancing/">Application Load Balancer</a> (ALB).
I use <a href="https://www.terraform.io/">Terraform</a> to manage
production and staging environments.</p>

<p>Let’s say the project is new, and we are not ready to open it to the public.
We allow access to the project only from specific IP addresses.
<a href="https://aws.amazon.com/waf/">WAF</a> helps us to limit access
only for specific IP addresses with CloudFront.
The last step to set up
<a href="https://docs.aws.amazon.com/vpc/latest/userguide/VPC_SecurityGroups.html">Security Group</a>
for our API endpoint’s ALB to allow connections only from CloudFront IP addresses.</p>

<h2 id="security-groups">Security Groups</h2>

<p>We use 
<a href="https://docs.aws.amazon.com/vpc/latest/userguide/VPC_SecurityGroups.html">Security Groups</a>
to limit traffic coming to the ALB by IP addresses.
Right now we need to include CloudFront IP addresses
to the list.</p>

<p>AWS Security Group has the
<a href="https://docs.aws.amazon.com/vpc/latest/userguide/amazon-vpc-limits.html">limit</a>
for the number of ingress/egress rules, e.g. IP addresses.
You may need to create several security groups
to list all addresses, if you have more than 60 (state 2019-02-09).
You may guess, that there are more than 60 CloudFront IP addresses.</p>

<h2 id="cloudfront-ip-addresses">CloudFront IP Addresses</h2>

<p>AWS has the endpoint that
<a href="https://docs.aws.amazon.com/general/latest/gr/aws-ip-ranges.html">lists all IP addresses</a>
of their services. Terraform has the command to access the list:</p>

<pre><code class="language-terrafrom">data "aws_ip_ranges" "cloudfront" {
    services = ["cloudfront"]
}
</code></pre>

<p>The only downside — we will need to re-run the deployment to make sure we
have the correct configuration to make sure a new IP address may not be included
in the settings, and the service
may not be accessible for some customers. I have no idea, how frequent the
list may change, probably not too frequent. Let’s assume we run the deployment
frequent enough. A <a href="https://jetbrains.com/teamcity">CI</a> can be used to automate it.</p>

<h2 id="settings-up-security-groups">Settings up Security Groups</h2>

<p>Let’s create several security groups to overcome the
<a href="https://docs.aws.amazon.com/vpc/latest/userguide/amazon-vpc-limits.html">limit</a>.</p>

<p>Terraform has necessary functions for that. Here we use the <code class="language-plaintext highlighter-rouge">chunklist</code>
function to split the full list of CloudFront IP addresses into
a list of lists. We specify the number of elements, e.g. <code class="language-plaintext highlighter-rouge">30</code> and the function
returns us the a list, where every element of it is a list of not more than <code class="language-plaintext highlighter-rouge">30</code>
elements. Let’s use the following code in Terraform to split IP addresses by
future security groups:</p>

<div class="language-terraform highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">locals</span> <span class="p">{</span>
    <span class="nx">chunks_v4</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"</span><span class="k">${</span><span class="nx">chunklist</span><span class="p">(</span><span class="k">data</span><span class="p">.</span><span class="nx">aws_ip_ranges</span><span class="p">.</span><span class="nx">cloudfront</span><span class="p">.</span><span class="nx">cidr_blocks</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span><span class="k">}</span><span class="s2">"</span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="creating-security-groups">Creating Security Groups</h2>

<p>We need to instruct Terraform to create several
Security Groups for us to reach the goal. We use <code class="language-plaintext highlighter-rouge">count</code>
<a href="https://www.terraform.io/docs/configuration/resources.html">attribute</a>
in Terraform to instruct it to create several resources with
one declaration:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>resource "aws_security_group" "cloudfront" {
    count = "${length(local.chunks_v4)}"
    
    //...
    
    ingress {
        from_port = 443
        to_port   = 443
        protocol  = "tcp"
        cidr_blocks = ["${local.chunks_v4[count.index]}"]
    }

    egress {
        from_port = 0
        to_port   = 0
        protocol  = "-1"
        cidr_blocks = ["0.0.0.0/0"]
    }

    lifecycle {
        create_before_destroy = true
    }
}
</code></pre></div></div>

<p>Terraform creates <code class="language-plaintext highlighter-rouge">count</code> resources for us, for every resource,
the <code class="language-plaintext highlighter-rouge">count.index</code> expression returns the current index (from 0 to <code class="language-plaintext highlighter-rouge">count - 1</code>).
In <a href="/blog/2018/07/23/terraform-if/">the corner case</a>, when <code class="language-plaintext highlighter-rouge">count = 0</code>, it does not
create resources at all.</p>

<p>We need to create <code class="language-plaintext highlighter-rouge">count = length(local.chunks_v4)</code> Security Groups.
The <code class="language-plaintext highlighter-rouge">local.chunks_v4[count.index]</code> selects the next chunk of CloudFront
IP addresses to fill into the next security group.</p>

<h2 id="conclusion">Conclusion</h2>

<p>We found an easy way to configure IP addresses filter for an Application Load Balancer
to allow incoming traffic only from CloudFront IP addresses. We made Terraform to create
and maintain several Security Groups to overcome the limits.</p>

<p>You may also want to read my previous post on how to implement
<a href="/blog/2018/07/23/terraform-if/">an If Statement</a>
analog in Terraform.</p>


        
      </div><!-- /.entry-content -->
    </div><!-- /.entry-wrapper -->
    <nav class="pagination" role="navigation">
      
        <a href="/blog/2019/03/04/gradle-kotlin-migration-1/" class="btn" title="Migrating to Gradle Kotlin DSL - Basics">Previous</a>
      
      
        <a href="/blog/2019/04/02/gradle-kotlin-migration-2/" class="btn" title="Migrating to Gradle Kotlin DSL - Kotlin">Next</a>
      
    </nav><!-- /.pagination -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo" class="entry-wrapper">
    

<span>
  &copy; 2005—2026 Eugene Petrenko.
  <br />
  Unless otherwise noted, the content on the website is licensed under a
  <a href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a> license.
  <br />
  Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using
  the <a href="https://mademistakes.com/work/so-simple-jekyll-theme/" rel="nofollow">So Simple Theme</a>.
</span>
<div class="social-icons">
  <a href="https://x.com/jonnyzzz" title="Eugene Petrenko on X" target="_blank"><svg class="social-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg></a>
  <a href="https://linkedin.com/in/jonnyzzz" title="Eugene Petrenko on LinkedIn" target="_blank"><svg class="social-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 3a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14m-.5 15.5v-5.3a3.26 3.26 0 0 0-3.26-3.26c-.85 0-1.84.52-2.32 1.3v-1.11h-2.79v8.37h2.79v-4.93c0-.77.62-1.4 1.39-1.4a1.4 1.4 0 0 1 1.4 1.4v4.93h2.79M6.88 8.56a1.68 1.68 0 0 0 1.68-1.68c0-.93-.75-1.69-1.68-1.69a1.69 1.69 0 0 0-1.69 1.69c0 .93.76 1.68 1.69 1.68m1.39 9.94v-8.37H5.5v8.37h2.77z"/></svg></a>
  <a href="https://github.com/jonnyzzz" title="Eugene Petrenko on Github" target="_blank"><svg class="social-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33.85 0 1.71.11 2.5.33 1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2z"/></svg></a>
  <a href="https://www.youtube.com/channel/UCn5M0Ct8SxLlHq0za4kGG1A" title="Eugene Petrenko on YouTube" target="_blank"><svg class="social-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M23.498 6.186a2.959 2.959 0 0 0-2.079-2.08C19.58 3.6 12 3.6 12 3.6s-7.58 0-9.419.507a2.959 2.959 0 0 0-2.08 2.079C0 8.025 0 12 0 12s0 3.975.501 5.814a2.959 2.959 0 0 0 2.08 2.079C4.42 20.4 12 20.4 12 20.4s7.58 0 9.419-.507a2.959 2.959 0 0 0 2.08-2.079C24 15.975 24 12 24 12s0-3.975-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg></a>
  <a href="/feed.xml" title="Atom/RSS feed"><svg class="social-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6.18 15.64a2.18 2.18 0 0 1 2.18 2.18C8.36 19 7.38 20 6.18 20C5 20 4 19 4 17.82a2.18 2.18 0 0 1 2.18-2.18M4 4.44A15.56 15.56 0 0 1 19.56 20h-2.83A12.73 12.73 0 0 0 4 7.27V4.44m0 5.66a9.9 9.9 0 0 1 9.9 9.9h-2.83A7.07 7.07 0 0 0 4 12.93V10.1z"/></svg></a>
</div><!-- /.social-icons -->

  </footer>
</div><!-- /.footer-wrapper -->

<script>
  // Open external links in new tab
  Array.from(document.links).forEach(link => {
    // For development: 0.0.0.0, localhost, 127.0.0.1 are all local
    const localHosts = ['localhost', '127.0.0.1', '0.0.0.0'];
    const linkIsLocal = localHosts.includes(link.hostname);
    const pageIsLocal = localHosts.includes(window.location.hostname);

    // Internal if: both are local dev hosts, or hostnames match exactly
    const isInternal = (linkIsLocal && pageIsLocal) ||
                       (link.hostname === window.location.hostname);

    if (!isInternal) {
      link.target = '_blank';
    }
  });
</script>


<!-- Google Analytics (gtag.js) -->
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('consent', 'default', {
    'ad_storage': 'denied',
    'ad_user_data': 'denied',
    'ad_personalization': 'denied',
    'analytics_storage': 'denied'
  });
</script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-BXXDX0ERFP"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-BXXDX0ERFP');
</script>
<!-- End Google Analytics -->




<!--SYNTAX HIGHLIGHTER - Lazy loads PrismJS only when code blocks are present-->
<script>
(function() {
  // Check if page has any code blocks that need highlighting
  if (!document.querySelector('pre code, code[class*="language-"]')) return;

  // Load CSS
  var cssFiles = [
    'https://cdn.jsdelivr.net/npm/prismjs@1.30.0/themes/prism.min.css',
    'https://cdn.jsdelivr.net/npm/prismjs@1.30.0/plugins/line-numbers/prism-line-numbers.min.css',
    'https://cdn.jsdelivr.net/npm/prismjs@1.30.0/plugins/toolbar/prism-toolbar.min.css'
  ];
  cssFiles.forEach(function(href) {
    var link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = href;
    document.head.appendChild(link);
  });

  // Load JS in sequence (core first, then plugins)
  var jsFiles = [
    'https://cdn.jsdelivr.net/npm/prismjs@1.30.0/components/prism-core.min.js',
    'https://cdn.jsdelivr.net/npm/prismjs@1.30.0/plugins/autoloader/prism-autoloader.min.js',
    'https://cdn.jsdelivr.net/npm/prismjs@1.30.0/plugins/line-numbers/prism-line-numbers.min.js',
    'https://cdn.jsdelivr.net/npm/prismjs@1.30.0/plugins/toolbar/prism-toolbar.min.js',
    'https://cdn.jsdelivr.net/npm/prismjs@1.30.0/plugins/show-language/prism-show-language.min.js',
    'https://cdn.jsdelivr.net/npm/prismjs@1.30.0/plugins/normalize-whitespace/prism-normalize-whitespace.min.js'
  ];

  function loadScript(index) {
    if (index >= jsFiles.length) {
      // All scripts loaded, highlight code
      if (window.Prism) Prism.highlightAll();
      return;
    }
    var script = document.createElement('script');
    script.src = jsFiles[index];
    script.onload = function() { loadScript(index + 1); };
    document.head.appendChild(script);
  }
  loadScript(0);
})();
</script>



</body>
</html>
