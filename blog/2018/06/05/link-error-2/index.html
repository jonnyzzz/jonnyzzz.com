<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8" />
<title>Undefined isOSVersionAtLeast on macOS &#8211; Eugene Petrenko</title>
<meta name="description" content="Solving ___isOSVersionAtLeast is undefined or CLang intrinsics.

"/>
<meta name="keywords" content="jonnyzzz, Евгений Петренко, Eugene Petrenko, mac, macOS, linker, kotlin, kotlin/native" />


<!-- Twitter Cards -->
<meta name="twitter:title" content="Undefined isOSVersionAtLeast on macOS -- Eugene Petrenko" />
<meta name="twitter:description" content="Solving ___isOSVersionAtLeast is undefined or CLang intrinsics.

" />
<meta name="twitter:site" content="@jonnyzzz" />
<meta name="twitter:creator" content="@jonnyzzz" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="https://jonnyzzz.com/images/me.jpg" />

<!-- Open Graph -->

<meta property="og:type" content="article" />
<meta property="og:image" content="https://jonnyzzz.com/images/me.jpg" />
<meta property="og:title" content="Undefined isOSVersionAtLeast on macOS -- Eugene Petrenko" />
<meta property="og:description" content="Solving ___isOSVersionAtLeast is undefined or CLang intrinsics.

" />
<meta property="og:url" content="https://jonnyzzz.com/blog/2018/06/05/link-error-2/" />
<meta property="og:site_name" content="Eugene Petrenko" />

<meta property="article:tag" content="jonnyzzz" />

<meta property="article:tag" content="Евгений Петренко" />

<meta property="article:tag" content="Eugene Petrenko" />


<meta property="article:tag" content="mac" />

<meta property="article:tag" content="macOS" />

<meta property="article:tag" content="linker" />

<meta property="article:tag" content="kotlin" />

<meta property="article:tag" content="kotlin/native" />



<!-- Webmaster Tools verfication -->
<meta name="google-site-verification" content="MJZCyfst2Tx4KyxbOIQu1fZyOSwA_JkQu73zJcfsl2g" />




<link rel="canonical" href="https://jonnyzzz.com/blog/2018/06/05/link-error-2/" />
<link href="https://feeds.feedburner.com/jonnyzzz" type="application/atom+xml" rel="alternate" title="ATOM Feed" />

<meta name="HandheldFriendly" content="True" />
<meta name="MobileOptimized" content="320" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css" />

<!-- Webfonts -->
<script src="https://use.edgefonts.net/source-sans-pro:n2,i2,n3,i3,n4,i4,n6,i6,n7,i7,n9,i9;source-code-pro:n4,n7;volkhov.js"></script>

<meta http-equiv="cleartype" content="on" />

<!-- HTML5 Shiv and Media Query Support -->
<!--[if lt IE 9]>
  <script src="/assets/js/vendor/html5shiv.min.js"></script>
  <script src="/assets/js/vendor/respond.min.js"></script>
<![endif]-->

<!-- Modernizr -->
<script src="/assets/js/vendor/modernizr-2.7.1.custom.min.js"></script>

<link rel="apple-touch-icon" sizes="57x57" href="/images/apple-icon-57x57.png" />
<link rel="apple-touch-icon" sizes="60x60" href="/images/apple-icon-60x60.png" />
<link rel="apple-touch-icon" sizes="72x72" href="/images/apple-icon-72x72.png" />
<link rel="apple-touch-icon" sizes="76x76" href="/images/apple-icon-76x76.png" />
<link rel="apple-touch-icon" sizes="114x114" href="/images/apple-icon-114x114.png" />
<link rel="apple-touch-icon" sizes="120x120" href="/images/apple-icon-120x120.png" />
<link rel="apple-touch-icon" sizes="144x144" href="/images/apple-icon-144x144.png" />
<link rel="apple-touch-icon" sizes="152x152" href="/images/apple-icon-152x152.png" />
<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-icon-180x180.png" />
<link rel="icon" type="image/png" sizes="192x192"  href="/images/android-icon-192x192.png" />
<link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png" />
<link rel="icon" type="image/png" sizes="96x96" href="/images/favicon-96x96.png" />
<link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png" />
<link rel="manifest" href="/images/manifest.json" />
<meta name="msapplication-TileColor" content="#ffffff" />
<meta name="msapplication-TileImage" content="/images/ms-icon-144x144.png" />
<meta name="theme-color" content="#ffffff" />

</head>

<body id="post">

<div class="navigation-wrapper">
	<nav role="navigation" id="site-nav" class="animated drop">
	    <ul>
      
		    
		    <li><a href="/about/" >About</a></li>
		  
		    
		    <li><a href="/blog/" >Blog</a></li>
		  
		    
		    <li><a href="/projects/" >Projects</a></li>
		  
		    
		    <li><a href="/talks/" >Talks</a></li>
		  
		    
		    <li><a href="/tags/" >Tags</a></li>
		  
	    </ul>
	</nav>
</div><!-- /.navigation-wrapper -->

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->

<header class="masthead">
	<div class="wrap">
      
      <h1 class="site-title animated fadeIn"><a href="/">Eugene Petrenko</a></h1>
		<h2 class="site-description animated fadeIn" itemprop="description">@jonnyzzz personal page and blog</h2>
	</div>
</header><!-- /.masthead -->

<div class="js-menu-screen menu-screen"></div>


<div id="main" role="main">
  <article class="hentry">
    
    <div class="entry-wrapper">
      <header class="entry-header">
        <ul class="entry-tags">
          <li><a href="/tags/#mac" title="Pages tagged mac">mac</a></li><li><a href="/tags/#macOS" title="Pages tagged macOS">macOS</a></li><li><a href="/tags/#linker" title="Pages tagged linker">linker</a></li><li><a href="/tags/#kotlin" title="Pages tagged kotlin">kotlin</a></li><li><a href="/tags/#kotlin/native" title="Pages tagged kotlin/native">kotlin/native</a></li>
        </ul>
        
          <h1 class="entry-title">Undefined isOSVersionAtLeast on macOS</h1>
        
      </header>
      <footer class="entry-meta">
        
        
          <img src="/images/me.jpg" class="bio-photo" alt="Eugene Petrenko bio photo"></a>
        
        <span class="author vcard">By <span class="fn">Eugene Petrenko</span></span>
        <span class="entry-date date published"><time datetime="2018-06-05T00:00:00+00:00"><i class="fa fa-calendar-o"></i> June 05, 2018</time></span>
        
        <span class="entry-comments"><i class="fa fa-comment-o"></i> <a href="#disqus_thread">Comment</a></span>
        <span class="social-share-twitter">
  <a href="https://twitter.com/intent/tweet?hashtags=mac,macOS,linker,kotlin,kotlin/native&amp;text=Undefined%20isOSVersionAtLeast%20on%20macOS&amp;url=https://jonnyzzz.com/blog/2018/06/05/link-error-2/&amp;via=jonnyzzz" title="Share on Twitter" itemprop="Twitter" target="_blank"><i class="fa fa-twitter-square"></i> Tweet</a>
</span>
<span class="social-share-facebook">
  <a href="https://www.facebook.com/sharer/sharer.php?u=https://jonnyzzz.com/blog/2018/06/05/link-error-2/" title="Share on Facebook" itemprop="Facebook" target="_blank"><i class="fa fa-facebook-square"></i> Like</a>
</span>

<!-- /.social-share -->

        
      </footer>
      <div class="entry-content">
        <p>Solving ___isOSVersionAtLeast is undefined or CLang intrinsics.</p>

<p>A few weeks ago I wrote about <a href="/blog/2018/05/16/link-error/">___isOSVersionAtLeast is undefined</a> problem.
At some point I realized I did NOT find a solution.</p>

<p>That time I focused on reproducing the problem with a tiny library of only a 
few code lines. I did that. A tiny static library.
It wrote details in the recent post
<a href="/blog/2018/05/28/minimalistic-kn/">Minimalistic C library and Kotlin/Native</a>.
Now I can check the linking either with 
<a href="https://kotlinlang.org/docs/reference/native-overview.html">Kotlin/Native</a> 
or with a plain C.</p>

<p>The <code class="highlighter-rouge">main.c</code>:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#include "lib.h"
#include &lt;stdio.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">arg</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">z</span>  <span class="o">=</span> <span class="n">foo</span><span class="p">();</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"The result is %d"</span><span class="p">,</span> <span class="n">z</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>I call the following to compile and link <code class="highlighter-rouge">main.c</code> with my <code class="highlighter-rouge">lib.a</code> 
<a href="/blog/2018/05/28/minimalistic-kn/">library</a>:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">gcc <span class="nt">-c</span>  main.c <span class="nt">-o</span> main.o
ld <span class="nt">-macosx_version_min</span> 10.10  <span class="nt">-lc</span>  main.o lib.a</code></pre></figure>

<p>I do the on macOS 10.13.3 with Xcode 9.3.1 and macOS 10.13.5, Xcode 9.4.</p>

<h2 id="the-linkage-error">The Linkage Error</h2>

<p>It was an assumption of mine to check for 
<a href="https://clang.llvm.org/docs/LanguageExtensions.html">Clang Language Extensions</a>,
and finally, I was able to reproduce the linkage error with 
only the following code in <code class="highlighter-rouge">lib.c</code> targeting macOS <code class="highlighter-rouge">10.10</code>, but not macOS <code class="highlighter-rouge">10.13</code>:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">foo</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">/// that is a CLang extension</span>
  <span class="k">if</span><span class="p">(</span><span class="n">__builtin_available</span><span class="p">(</span><span class="n">macOS</span> <span class="mi">10</span><span class="p">.</span><span class="mi">12</span><span class="p">,</span> <span class="n">iOS</span> <span class="mi">9</span><span class="p">.</span><span class="mi">0</span><span class="p">,</span> <span class="n">tvOS</span> <span class="mi">9</span><span class="p">.</span><span class="mi">0</span><span class="p">,</span> <span class="n">watchOS</span> <span class="mi">2</span><span class="p">.</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="mi">256</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="mi">42</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>And the linker error:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">Undefined symbols for architecture x86_64:
  "___isOSVersionAtLeast", referenced from:
      _foo in lib.a(lib.o)</code></pre></figure>

<p>I ran the <code class="highlighter-rouge">ld</code> command with <code class="highlighter-rouge">-macosx_version_min 10.10</code> to target macOS <code class="highlighter-rouge">10.10</code>. The 
argument specifies the minimal version of macOS the created binary supports.</p>

<p>More experiments with arguments help me to find that CLang is smart to optimize that 
code if the check makes no sense.
For example, CLang optimizes the call <code class="highlighter-rouge">__builtin_available(macOS 10.12,*)</code> when I target
<code class="highlighter-rouge">10.12</code> or <code class="highlighter-rouge">10.13</code>. It also means no linkage error. 
The call <code class="highlighter-rouge">__builtin_available(macOS 10.14,*)</code> is never optimized, as long as I cannot target
<code class="highlighter-rouge">10.14</code> yet.</p>

<p>My <a href="/blog/2018/05/16/link-error/">linkage problem</a> was not in the target version 
specification at all. Otherwise, the problem was with a missing library. I was missing the 
compiler-runtime library in my <code class="highlighter-rouge">ld</code> call.
I found the hacky path (on <a href="https://www.google.de/search?q=works+on+my+machine" target="_blank">my machine</a>) 
to solve the linker error:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/Library/Developer/CommandLineTools/usr/lib/clang/9.1.0/lib/darwin/libclang_rt.osx.a
</code></pre></div></div>

<p>That one defines the symbol I was missing. The only problem is the path hard-codes 
too many internals. It is too internal to be used directly from a build. It seems to 
be a part of Xcode 9.1.0, which is too old.</p>

<h2 id="compiler-rt">compiler-rt</h2>

<p><a href="https://compiler-rt.llvm.org/">LLVM “compiler-rt”</a> that is the place with the documentation
of the LLVM and CLang features, that requires a runtime. It includes nice and helpful 
features inside. There is still no answer with the correct linker options.
I have no plans to build my own toolchain.</p>

<h2 id="the-right-fix">The right fix</h2>

<p>The best fix for <code class="highlighter-rouge">___isOSVersionAtLeast</code> undefined symbol so far is to include the missing 
runtime library to an <code class="highlighter-rouge">ld</code> command. It only needs a path to the static library with no other
arguments. Shall a build tool help here? I do not know yet.</p>

<p>The worst here is one needs to generate the path manually. One need to know the Xcode (aka toolchain)
version to do that. And the trickiest is to make sure the path is updated once Xcode or something
else is updated.</p>

<p>I am looking to find the best way to include the <code class="highlighter-rouge">compiler-rt</code>. If you know something, 
please comment below.</p>

<p>Continue reading the <a href="/blog/2018/06/13/link-error-3/">next part of the investigation</a></p>

        
          <div id="disqus_thread"></div><!-- /#disqus_thread -->
          
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'jonnyzzz'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

        
      </div><!-- /.entry-content -->
    </div><!-- /.entry-wrapper -->
    <nav class="pagination" role="navigation">
      
        <a href="/blog/2018/05/28/minimalistic-kn/" class="btn" title="Minimalistic C library and Kotlin/Native">Previous</a>
      
      
        <a href="/blog/2018/06/13/link-error-3/" class="btn" title="Understanding isOSVersionAtLeast on macOS">Next</a>
      
    </nav><!-- /.pagination -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo" class="entry-wrapper">
    

<span>
  &copy; 2005—2019 Eugene Petrenko.
  <br />
  Unless otherwise noted, the content on the website is licensed under a
  <a href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a> license.
  <br />
  Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using
  the <a href="https://mademistakes.com/work/so-simple-jekyll-theme/" rel="nofollow">So Simple Theme</a>.
</span>
<div class="social-icons">
	<a href="https://twitter.com/jonnyzzz" title="Eugene Petrenko on Twitter" target="_blank"><i class="fa fa-twitter-square fa-2x"></i></a>
	<a href="https://facebook.com/jonnyzzz" title="Eugene Petrenko on Facebook" target="_blank"><i class="fa fa-facebook-square fa-2x"></i></a>
	
	<a href="https://linkedin.com/in/jonnyzzz" title="Eugene Petrenko on LinkedIn" target="_blank"><i class="fa fa-linkedin-square fa-2x"></i></a>
	<a href="http://stackoverflow.com/users/49811/eugene-petrenko" title="Eugene Petrenko on StackExchange" target="_blank"><i class="fa fa-stack-exchange fa-2x"></i></a>
	<a href="https://instagram.com/jonnyzzz" title="Eugene Petrenko on Instagram" target="_blank"><i class="fa fa-instagram fa-2x"></i></a>
	<a href="https://www.flickr.com/photos/_jonny_" title="Eugene Petrenko on Flickr" target="_blank"><i class="fa fa-flickr fa-2x"></i></a>
	<a href="https://github.com/jonnyzzz" title="Eugene Petrenko on Github" target="_blank"><i class="fa fa-github-square fa-2x"></i></a>
	
  <a href="https://www.pinterest.com/jonnyzzz/" title="Eugene Petrenko on Pinterest" target="_blank"><i class="fa fa-pinterest fa-2x"></i></a>
	
  <a href="https://feeds.feedburner.com/jonnyzzz" title="Atom/RSS feed"><i class="fa fa-rss-square fa-2x"></i></a>
</div><!-- /.social-icons -->

  </footer>
</div><!-- /.footer-wrapper -->

<script type="text/javascript">
  var BASE_URL = '';
</script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script src="/assets/js/scripts.min.js"></script>


<!-- Google Analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-70104598-1', 'auto');
  ga('send', 'pageview');
</script>
<!-- End Google Analytics -->




<!-- MathJax -->
<script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


<script type="text/javascript">
  window.cookieconsent_options = {"message":"This website uses cookies to ensure you get the best experience on our website","dismiss":"Got it!","learnMore":"More info","link":null,"theme":"light-bottom"};
</script>

<script async type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/1.0.9/cookieconsent.min.js"></script>



<!--SYNTAX HIGHLIGHTER BEGINS-->

<script async src="/assets/syntax/syntax.js"></script>

<link rel="stylesheet" href="/assets/syntax/syntax.css" />

<!--SYNTAX HIGHLIGHTER ENDS-->



</body>
</html>
